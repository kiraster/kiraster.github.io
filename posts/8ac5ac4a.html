<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
<meta charset="utf-8">
<title>No.001 Simple Case - Kir&#39;s Blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<meta name="description" content="Kir的博客，网络设备配置，网络拓扑实验，华为华三路由交换无线安全HCIP,CISCO,NETWORK">


<meta name="keywords" content="Kir的博客，网络设备配置，网络拓扑实验，华为华三路由交换无线安全HCIP,CISCO,NETWORK">


    <meta name="description" content="上文提到要 po 一篇文，现在发表一下自己的思路和配置。原文:【有点儿意思系列 06】一个看起来简单的案例，再上图。">
<meta property="og:type" content="article">
<meta property="og:title" content="No.001 Simple Case">
<meta property="og:url" content="https://kiraster.github.io/posts/8ac5ac4a.html">
<meta property="og:site_name" content="Kir&#39;s Blog">
<meta property="og:description" content="上文提到要 po 一篇文，现在发表一下自己的思路和配置。原文:【有点儿意思系列 06】一个看起来简单的案例，再上图。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/11/05/aV6ElzprdKjscFt.jpg">
<meta property="og:image" content="https://i.loli.net/2021/11/07/cuPSatd6w2E18Hq.jpg">
<meta property="og:image" content="https://i.loli.net/2021/11/07/VG6mjtd1Ww49iSv.jpg">
<meta property="article:published_time" content="2021-11-06T16:31:11.000Z">
<meta property="article:modified_time" content="2023-02-14T08:59:47.183Z">
<meta property="article:author" content="Kir Aster">
<meta property="article:tag" content="Network Emulator">
<meta property="article:tag" content="PNETLab">
<meta property="article:tag" content="Cisco">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/11/05/aV6ElzprdKjscFt.jpg">



<link rel="icon" href="https://s2.loli.net/2022/11/07/nR4jdLTGEq6kZ2S.png">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<!--引入思源黑体 rel-->
<link rel="preconnect" href="https://fonts.proxy.ustclug.org">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.proxy.ustclug.org/css2?family=Noto+Sans+SC&display=swap" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-209914470-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-209914470-1');
</script>


    
    
<!-- Clarity tracking code for https://kiraster.github.io/ -->
<script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i+"?ref=bwt";
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "heff72hdac");
</script>

    

<meta name="generator" content="Hexo 6.3.0"></head>
<body>

<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Kir&#39;s
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/gallery">Gallery</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#Request-and-Solution">1&nbsp;&nbsp;<b>Request and Solution</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Ending">2&nbsp;&nbsp;<b>Ending</b></a>
                    
                </div>
            </div>
            
            
        </div>
    </div>
</nav>

<section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    
      <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
          
              No.001 Simple Case
          
      </h1>
    
    
      <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
          <span class="column is-narrow">
              
                  <i class="far fa-clock"></i>
                  <span>&nbspNov 7th 21&nbsp</span>
              
          </span>
          
          <span class="column is-narrow article-category">
              <i class="far fa-folder"></i>
              <a class="article-category-link" href="/categories/PNETLab/">PNETLab</a>
          </span>
          
          
          <span class="column is-narrow">
              
              
              17 minutes read (About 2613 words)
          </span>
          
      </div>
    
    <!-- add timeliness tips date:20230510 -->
    
      
      
        <div>
          <i class="fa fa-exclamation-triangle"></i> 
          This is an article that was created 755 days ago, and the information may have evolved or changed.  
        </div>
        <br>
      
    
    
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        
        <html><head></head><body><p>上文提到要 po 一篇文，现在发表一下自己的思路和配置。原文:<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_5ec353710102w64i.html">【有点儿意思系列 06】一个看起来简单的案例</a>，再上图。<span id="more"></span></p>
<p><img src="https://i.loli.net/2021/11/05/aV6ElzprdKjscFt.jpg"></p>
<h2 id="Request-and-Solution"><a href="#Request-and-Solution" class="headerlink" title="Request and Solution"></a>Request and Solution</h2><ol>
<li><p>PC1、PC2 分属 VLAN10 和 VLAN20；DHCP 服务器属 VLAN30 ，PC1 和 PC2 从 DHCP 服务器自动获取地址。</p>
<p>  <strong>S</strong>：根据上下文需求，确定 R3 和 R4 是热备组网。R3 和 R4 上配置子接口，配置 VRRP ；业务地址段和 DHCPServer 不在同一网段，所以需要在业务网段的网关上配置 DHCP 中继。实验中使用一台路由器模拟 DHCPServer，上面配置分配给 VLAN10,VLAN20 的地址池。</p>
  <figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">! --- DHCPServer 配置</span><br><span class="line">!</span><br><span class="line">ip dhcp excluded-address 10.1.10.252 10.1.10.254</span><br><span class="line">ip dhcp excluded-address 10.1.20.252 10.1.20.254</span><br><span class="line">!</span><br><span class="line">ip dhcp pool vlan10</span><br><span class="line"> network 10.1.10.0 255.255.255.0</span><br><span class="line"> default-router 10.1.10.254 </span><br><span class="line">!</span><br><span class="line">ip dhcp pool vlan20</span><br><span class="line"> network 10.1.20.0 255.255.255.0</span><br><span class="line"> default-router 10.1.20.254 </span><br><span class="line">!</span><br></pre></td></tr></tbody></table></figure>

  <figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">! --- R3 配置</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1.10</span><br><span class="line"> encapsulation dot1Q 10</span><br><span class="line"> ip address 10.1.10.252 255.255.255.0</span><br><span class="line"> ip helper-address 10.1.30.1</span><br><span class="line"> vrrp 10 ip 10.1.10.254</span><br><span class="line"> vrrp 10 priority 120</span><br><span class="line"> vrrp 10 track 1 decrement 21</span><br><span class="line">!         </span><br><span class="line">interface Ethernet0/1.20</span><br><span class="line"> encapsulation dot1Q 20</span><br><span class="line"> ip address 10.1.20.252 255.255.255.0</span><br><span class="line"> ip helper-address 10.1.30.1</span><br><span class="line"> vrrp 20 ip 10.1.20.254</span><br><span class="line">!         </span><br><span class="line">interface Ethernet0/1.30</span><br><span class="line"> encapsulation dot1Q 30</span><br><span class="line"> ip address 10.1.30.252 255.255.255.0</span><br><span class="line"> vrrp 30 ip 10.1.30.254</span><br><span class="line"> vrrp 30 priority 120</span><br><span class="line"> vrrp 30 track 1 decrement 21</span><br><span class="line">! --- 网管地址网关</span><br><span class="line">interface Ethernet0/1.99</span><br><span class="line"> encapsulation dot1Q 99</span><br><span class="line"> ip address 20.1.1.252 255.255.255.0</span><br><span class="line"> vrrp 99 ip 20.1.1.254</span><br><span class="line"> vrrp 99 priority 120</span><br><span class="line"> vrrp 99 track 1 decrement 21</span><br><span class="line">!       </span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>SW4 是内网用户接入交换机（仅具二层功能），要求内网两个网段的用户均能 telnet 到该设备。</p>
<p>  <strong>S</strong>：配置 VLAN ，划分接口，配置 Trunk，配置默认网关和远程网管</p>
  <figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">! --- SW4 配置</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> switchport trunk allowed vlan 10,20,30,99</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> switchport trunk allowed vlan 10,20,30,99</span><br><span class="line"> switchport trunk encapsulation dot1q</span><br><span class="line"> switchport mode trunk</span><br><span class="line">!</span><br><span class="line">interface Ethernet1/1</span><br><span class="line"> switchport access vlan 10</span><br><span class="line">!</span><br><span class="line">interface Ethernet1/2</span><br><span class="line"> switchport access vlan 20</span><br><span class="line">!</span><br><span class="line">interface Ethernet1/3</span><br><span class="line"> switchport access vlan 30</span><br><span class="line">! --- 网管IP地址</span><br><span class="line">interface Vlan99</span><br><span class="line"> ip address 20.1.1.10 255.255.255.0</span><br><span class="line">! -- 本想使用 ip default-gateway，但是不起作用，下面这条效果是一样</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 20.1.1.254</span><br><span class="line">! --- 网管配置 略</span><br><span class="line">……</span><br></pre></td></tr></tbody></table></figure>

<p>  由于 VPCS 不支持 Telnet ，此处使用 DHCPServer 做测试。</p>
</li>
</ol>
<p><img src="https://i.loli.net/2021/11/07/cuPSatd6w2E18Hq.jpg"></p>
<ol start="3">
<li><p>R3 和 R4 作为内网用户的网关设备，互为热备份。</p>
<p> <strong>S</strong>：这一条前面提过了，整个拓扑完整配置后边发，我打个包。</p>
</li>
<li><p>R3、R4、SW2 及 SW3 上不允许出现任何手工配置的静态路由条目。 </p>
<p> <strong>S</strong>：好的，满足你。</p>
</li>
<li><p>SW1 采用重发布的方式，将直连的服务器网段路由（如10.1.100.0/24）注入 EIGRP。</p>
<p> <strong>S</strong>：好的，满足你。</p>
</li>
<li><p>内网用户（PC1、PC2）访问核心服务器 Server（10.1.100.1）的数据流走向如下：</p>
<p> PC1 访问 Server：R3 &gt; R1 &gt; SW2 &gt; SW1 &gt; Server；</p>
<p> PC2 访问 Server：R4 &gt; R2 &gt; SW3 &gt; SW1 &gt; Server；</p>
<p> 沿途任何设备上到达 Server 的路由不允许出现负载均衡，且 PC 访问 Server 的流量往返路径一致。</p>
<p>  <strong>S</strong>：在配置完路由协议后，查看沿途设备路由表发现到达 Server 的路由出现负载均衡是正常现象，旁观大局，逐个处理就行。</p>
<p>  但是有一个现象我不知是模拟器的 Bug 还是镜像的问题，查看 SW3 和 SW4  ，总有一台设备到达 Server 的路由是这样的：</p>
 <figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D EX     10.1.100.0/24 [170/307200]</span><br></pre></td></tr></tbody></table></figure>
<p>  另一台学习到去往 Server 网段的路由是从上面这台学习到的外部路由，重启两台交换机的 OSPF 进程，这条路由又可能显示在第二台了。我又用 GNS3 做了测试，也是这种情况，按理说加载到路由表的不应该是管理距离为 110 的 OSPF 外部路由么？</p>
<p> 我思考了一番，可能是 OSPF 进程启动先后顺序的问题，先启动的交换机 OSPF 进程加载了 EIGRP 外部路由，而后启动的交换机 OSPF 进程学习到 EIGRP 外部路由和 OSPF 外部路由，按照规则选择了管理距离值较小的 OSPF 路由条目。</p>
<p> <strong>PC1 访问 Server：R3 &gt; R1 &gt; SW2 &gt; SW1 &gt; Server；</strong></p>
 <figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">! --- R1 配置，修改 OSPF 入向接口的 cost ，使从 e0/0 收到去往10.1.100.0网段的路由更优</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> ip ospf cost 11</span><br><span class="line">!</span><br></pre></td></tr></tbody></table></figure>
 <figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">! --- SW2 配置, 在 OSPF 进程下过滤入方向收到的去往 10.1.100.0 网段的条目，为什么这么做呢，从后面需求看，断掉 SW2/SW3 与 SW1 的线路之一，去往 Server的流量就不需要经过断掉线路这台交换机，而且断掉线路还要流量经过这台设备，走了个直角线路，并不是最优路径</span><br><span class="line">!</span><br><span class="line">router ospf 200</span><br><span class="line"> distribute-list 10 in</span><br><span class="line">!</span><br><span class="line">access-list 10 deny   10.1.100.0 0.0.0.255</span><br><span class="line">access-list 10 permit any</span><br><span class="line">!</span><br></pre></td></tr></tbody></table></figure>
<p> <strong>PC2 访问 Server ：R4 &gt; R2 &gt; SW3 &gt; SW1 &gt; Server；</strong></p>
<p> 思路和 PC1 访问 Server 一样，逆推一下即可，不占用篇幅了（懒得码字）</p>
<p> <strong>PC1 访问 Server 回程路径： Server&gt; SW1 &gt; SW2 &gt; R1 &gt;R3 ；</strong></p>
 <figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">! --- SW1 配置，观察到去往内网网段的路由条目是负载均衡，配置偏移列表和指定入向接口，增加希望不要出现在路由表里的条目 metric 偏移，影响路由表加载</span><br><span class="line">!</span><br><span class="line">router eigrp 100</span><br><span class="line"> offset-list 20 in 1024 Ethernet0/2 </span><br><span class="line"> offset-list 10 in 1024 Ethernet0/1 </span><br><span class="line">!</span><br><span class="line">access-list 10 permit 10.1.20.0 0.0.0.255</span><br><span class="line">access-list 20 permit 10.1.10.0 0.0.0.255</span><br><span class="line"> !</span><br></pre></td></tr></tbody></table></figure>
 <figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">! --- SW2 配置，修改 e0/3 接口 cost，使得从该接口学习到去往 10.1.10.0 和 10.1.20.0 网段的路由不是最优路由</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/3</span><br><span class="line">  ip ospf cost 11</span><br><span class="line">!</span><br></pre></td></tr></tbody></table></figure>
<p>  <strong>PC2 访问 Server 回程路径： Server&gt; SW1 &gt; SW3 &gt; R2 &gt;R3 ；</strong></p>
<p>  思路和 PC1 访问 Server 回程路径一样，逆推一下即可，不占用篇幅了（懒得码字）</p>
</li>
<li><p>要求 SW2 和 SW3 访问 Server 都走最优路径，即 SW2 前往 Server 的数据流走 SW1，SW3 前往 Server 的数据流也直接到 SW1。</p>
<p>   <strong>S</strong>：这一条也佐证了我在上面说到的流量走直角路径不是最优的想法。说的通俗一点就是：SW1 上的有流量要去往 Server 只能从 e0/1 出去，不走直角。即使 SW1 上的出口线路故障了也不走，走的路径是：拓扑上的对角线。退一步来说当 SW2/SW3 的出口线路故障了，下联的 R1/R2 不会从 SW2/SW3 学习到去往 Server 的路由条目。SW2 也是这个道理。</p>
</li>
</ol>
<p><img src="https://i.loli.net/2021/11/07/VG6mjtd1Ww49iSv.jpg"></p>
<ol start="8">
<li><p>SW1 上关于 10.1.10.0/24 和 10.1.20.0/24 的路由不应该出现等价负载均衡，正常情况下访问 10.0/24 网段的数据流走 SW2，访问2 0.0/24 网段的数据流走 SW3。</p>
<p>  <strong>S</strong>：在 PC1/PC2 访问 Server 的回程路径时候已经解决这一条，不占用篇幅了（懒得码字）。</p>
</li>
<li><p>当 SW1-SW2 之间的链路 DOWN 掉时，PC1 访问 Server 的数据流切换至路径： R3&gt;R1&gt;SW3&gt;SW1&gt;Server，且往返路径一致。而当 SW1-SW3 之间的链路 DOWN 掉时，PC2 应该仍然能够访问 Server，情况类似。</p>
<p>  <strong>S</strong>：正如我前面所说的：当 SW2/SW3 的出口线路故障了，下联的 R1/R2 也不会从 SW2/SW3 学习到去往 Server 的路由条目。此时去往 Server 的流量已经在 R1/R2 通过走对角线的路径来到 SW3/SW2 上。</p>
<p>重点解决回程的路径。因为前面已经修改了 SW2 和 SW3 上的 e0/3 的 cost ，这就使得当 SW1-SW2 之间的链路 DOWN 掉或者 SW1-SW3 之间的链路 DOWN 掉时，SW3/SW2 去往 10.1.10.0 和 10.1.20.0 网段都是直线往下经过 R2 或者 R1 回程到业务网段，并不符合需求。需要添加策略路由 PBR 实现往返路径一致。</p>
<figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">! --- SW2 配置，配置匹配去往 10.1.20.0 网段的 ACL，配置 route-map 匹配 ACL ，设置去往10.1.20.0 网段的下一跳地址，配置 SLA 监测，最后在 e0/1 调用</span><br><span class="line">!</span><br><span class="line">access-list 101 permit ip any 10.1.20.0 0.0.0.255</span><br><span class="line">!</span><br><span class="line">route-map pbr_20.0 permit 10</span><br><span class="line"> match ip address 101</span><br><span class="line"> set ip next-hop verify-availability 10.1.254.105 1 track 1</span><br><span class="line">!</span><br><span class="line">ip sla 1</span><br><span class="line"> icmp-echo 10.1.254.105 source-interface Ethernet0/3</span><br><span class="line"> frequency 5</span><br><span class="line">! 设置 delay 是为了及时观察现象，实际生产环境不需这么做</span><br><span class="line"> track 1 ip sla 1 reachability</span><br><span class="line"> delay down 5 up 3</span><br><span class="line">!</span><br><span class="line">ip sla schedule 1 life forever start-time now</span><br><span class="line">!</span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> ip policy route-map pbr_20.0</span><br><span class="line">!</span><br></pre></td></tr></tbody></table></figure>

<p>当SW1-SW3之间的链路DOWN掉时，PC2应该仍然能够访问Server，情况类似。解决思路和上面一样，懒-码-字。</p>
</li>
<li><p>当 SW2-R1 之间的链路 DOWN 掉时，PC1 访问 Server 的数据流切换至路径：R3&gt;R1&gt;SW3&gt;SW1&gt;Server，此时不要求流量往返路径完全一致。当 SW3-R2 之间的链路 DOWN 掉时，PC2 应该仍能够访问到 Server。</p>
<p>  <strong>S</strong>：当 SW2-R1 之间的链路 DOWN 掉时，R1 是能够从 SW3 学习到去往 Server 的路由的，只是回程的时候路径是： Server&gt; SW1 &gt; SW2 &gt; R2 &gt;R4 ，不要求流量往返路径完全一致，本条需求已经自动实现了。当SW3-R2之间的链路DOWN掉时同理。</p>
</li>
<li><p>R3、R4 任意一台路由器与内网交换机直连链路 DOWN 掉，不影响内网 PC 访问外网。</p>
<p>  <strong>S</strong>：配置的 VRRP 可以实现。 </p>
</li>
<li><p>【可选】若 R3 的出口 DOWN 或 R1 的两条上联链路都 DOWN，以上两种情况，R3 都能检测到，要求此两种情况发生时内网用户访问 SERVER 都不受影响，R4 同理。</p>
<p>  <strong>S</strong>：R3 的出口 DOWN 或 R1 的两条上联链路都 DOWN，明显要求配置 SLA 特性，我的做法是在 SW3 和 SW2 上配置一个环回地址，R3/R4 检测这个地址的可达性。举例：当 R3 配置了监测 SW3 的环回地址可达性，无论是 R3 的出口 DOWN 或 R1 的两条上联链路都 DOWN 其中一个条件达成，都会导致监测失败不可达，再在相应的内网子接口下配置 Track 联动降低 VRRP 组的优先级，使其成为 Backup 状态，另一台路由器成为 Master ，此时内网用户访问 Server 路径自动切换不受影响（其实还是会掉包的，取决于你配置的监测周期，抢占延时，生成树协议）。R4 同理。</p>
<p>（11月10日发现，可以使用 <strong>Track list</strong> 的方式实现）</p>
<figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">! --- R3 配置</span><br><span class="line">interface Ethernet0/1.10</span><br><span class="line"> vrrp 10 track 1 decrement 21</span><br><span class="line">!</span><br><span class="line">ip sla 1</span><br><span class="line"> icmp-echo 33.33.33.33 source-interface Ethernet0/0</span><br><span class="line"> frequency 5</span><br><span class="line">ip sla schedule 1 life forever start-time now</span><br><span class="line">!</span><br><span class="line">track 1 ip sla 1 reachability</span><br><span class="line"> delay down 5 up 3</span><br><span class="line">!</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h2 id="Ending"><a href="#Ending" class="headerlink" title="Ending"></a>Ending</h2><ul>
<li>配置存阿里云盘了，这是链接：[<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/VsEkNTBjuxy">分享的文件</a>]</li>
<li>欢迎“<del>来电</del>”来函探讨。</li>
</ul>
</body></html>
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Network-Emulator/">#Network Emulator</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/PNETLab/">#PNETLab</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Cisco/">#Cisco</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/posts/2da7a7a9.html">No.002 Simple Case</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/posts/13f1a9a7.html">PNETLab试用</a>
            
        </span>
    </div>
    
</article>
<!-- 
DO NOT APPLY SHAREBOX

<div class="sharebox">
    
<div class="notification is-danger">
    You need to set <code>install_url</code> to use ShareThis. Please set it in <code>_config.yml</code>.
</div>

</div>

DO NOT APPLY COMMENTS

<div class="comments">
    <h3 class="title is-4">Comments</h3>
    
<div id="disqus_thread">
    
    <div class="notification is-danger">
        You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.
    </div>
    
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

-->
    </div>
</section>
<footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 Kir Aster&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-blue" title="About" href="/about">
                    
                    About
                    
                </a>
                
                    
                <a class="column is-narrow has-text-blue" title="Privacy" href="/privacy-statement">
                    
                    Privacy
                    
                </a>
                
                    
                <a class="column is-narrow has-text-blue" title="GitHub" target="_blank" rel="noopener" href="https://github.com/kiraster">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
<div id="totop" class="ctotop">
<a title="返回顶部"><img src="/images/scrollup.png"/></a>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery > p > .gallery-item').unwrap();
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    
    

    
    
    



<script src="/js/script.js"></script>


<script src="/js/totop.js"></script>


<div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>


</body>
</html>