<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="上文提到要 po 一篇文，现在发表一下自己的思路和配置。原文:【有点儿意思系列 06】一个看起来简单的案例 ，再上图。\n"><title>No.001 Simple Case</title>
<link rel=canonical href=https://kiraster.github.io/posts/8ac5ac4a/><link rel=stylesheet href=/scss/style.min.655b8db05b082413bbbb47617eac892a6a33c4f697e079bf8c9ee93cfba90fa3.css><meta property='og:title' content="No.001 Simple Case"><meta property='og:description' content="上文提到要 po 一篇文，现在发表一下自己的思路和配置。原文:【有点儿意思系列 06】一个看起来简单的案例 ，再上图。\n"><meta property='og:url' content='https://kiraster.github.io/posts/8ac5ac4a/'><meta property='og:site_name' content="Kir's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Network Emulator'><meta property='article:tag' content='PNETLab'><meta property='article:tag' content='Cisco'><meta property='article:published_time' content='2021-11-07T00:31:11+00:00'><meta property='article:modified_time' content='2021-11-07T00:31:11+00:00'><meta name=twitter:title content="No.001 Simple Case"><meta name=twitter:description content="上文提到要 po 一篇文，现在发表一下自己的思路和配置。原文:【有点儿意思系列 06】一个看起来简单的案例 ，再上图。\n"><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZZ2XLP4292"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZZ2XLP4292")}</script><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","heff72hdac")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu16060348347131247650.jpg width=300 height=283 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Kir's Blog</a></h1><h2 class=site-description>@kiraster</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/gallery/><svg viewBox="0 0 24 24" fill="none" width="24" height="24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke="currentcolor"><path d="M15 8h.01"/><path d="M12.5 21H6a3 3 0 01-3-3V6a3 3 0 013-3h12a3 3 0 013 3v6.5"/><path d="M3 16l5-5c.928-.893 2.072-.893 3 0l4 4"/><path d="M14 14l1-1c.67-.644 1.45-.824 2.182-.54"/><path d="M16 19h6"/><path d="M19 16v6"/></svg>
<span>Gallery</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#request-and-solution>Request and Solution</a></li><li><a href=#ending>Ending</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/pnetlab/ style=background-color:#cae1ff;color:#fff>PNETLab</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/8ac5ac4a/>No.001 Simple Case</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 07, 2021</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>上文提到要 po 一篇文，现在发表一下自己的思路和配置。原文:<a class=link href=http://blog.sina.com.cn/s/blog_5ec353710102w64i.html target=_blank rel=noopener>【有点儿意思系列 06】一个看起来简单的案例
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>，再上图。</p><p><div class=post-img-view><a data-fancybox=gallery href=https://i.loli.net/2021/11/05/aV6ElzprdKjscFt.jpg><img src=https://i.loli.net/2021/11/05/aV6ElzprdKjscFt.jpg loading=lazy></a></div></p><h2 id=request-and-solution>Request and Solution</h2><ol><li><p>PC1、PC2 分属 VLAN10 和 VLAN20；DHCP 服务器属 VLAN30 ，PC1 和 PC2 从 DHCP 服务器自动获取地址。</p><p><strong>S</strong>：根据上下文需求，确定 R3 和 R4 是热备组网。R3 和 R4 上配置子接口，配置 VRRP ；业务地址段和 DHCPServer 不在同一网段，所以需要在业务网段的网关上配置 DHCP 中继。实验中使用一台路由器模拟 DHCPServer，上面配置分配给 VLAN10,VLAN20 的地址池。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>! --- DHCPServer 配置
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>ip dhcp excluded-address 10.1.10.252 10.1.10.254
</span></span><span class=line><span class=cl>ip dhcp excluded-address 10.1.20.252 10.1.20.254
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>ip dhcp pool vlan10
</span></span><span class=line><span class=cl> network 10.1.10.0 255.255.255.0
</span></span><span class=line><span class=cl> default-router 10.1.10.254 
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>ip dhcp pool vlan20
</span></span><span class=line><span class=cl> network 10.1.20.0 255.255.255.0
</span></span><span class=line><span class=cl> default-router 10.1.20.254 
</span></span><span class=line><span class=cl>!
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>! --- R3 配置
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>interface Ethernet0/1.10
</span></span><span class=line><span class=cl> encapsulation dot1Q 10
</span></span><span class=line><span class=cl> ip address 10.1.10.252 255.255.255.0
</span></span><span class=line><span class=cl> ip helper-address 10.1.30.1
</span></span><span class=line><span class=cl> vrrp 10 ip 10.1.10.254
</span></span><span class=line><span class=cl> vrrp 10 priority 120
</span></span><span class=line><span class=cl> vrrp 10 track 1 decrement 21
</span></span><span class=line><span class=cl>!         
</span></span><span class=line><span class=cl>interface Ethernet0/1.20
</span></span><span class=line><span class=cl> encapsulation dot1Q 20
</span></span><span class=line><span class=cl> ip address 10.1.20.252 255.255.255.0
</span></span><span class=line><span class=cl> ip helper-address 10.1.30.1
</span></span><span class=line><span class=cl> vrrp 20 ip 10.1.20.254
</span></span><span class=line><span class=cl>!         
</span></span><span class=line><span class=cl>interface Ethernet0/1.30
</span></span><span class=line><span class=cl> encapsulation dot1Q 30
</span></span><span class=line><span class=cl> ip address 10.1.30.252 255.255.255.0
</span></span><span class=line><span class=cl> vrrp 30 ip 10.1.30.254
</span></span><span class=line><span class=cl> vrrp 30 priority 120
</span></span><span class=line><span class=cl> vrrp 30 track 1 decrement 21
</span></span><span class=line><span class=cl>! --- 网管地址网关
</span></span><span class=line><span class=cl>interface Ethernet0/1.99
</span></span><span class=line><span class=cl> encapsulation dot1Q 99
</span></span><span class=line><span class=cl> ip address 20.1.1.252 255.255.255.0
</span></span><span class=line><span class=cl> vrrp 99 ip 20.1.1.254
</span></span><span class=line><span class=cl> vrrp 99 priority 120
</span></span><span class=line><span class=cl> vrrp 99 track 1 decrement 21
</span></span><span class=line><span class=cl>!       
</span></span></code></pre></div></li><li><p>SW4 是内网用户接入交换机（仅具二层功能），要求内网两个网段的用户均能 telnet 到该设备。</p><p><strong>S</strong>：配置 VLAN ，划分接口，配置 Trunk，配置默认网关和远程网管</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>! --- SW4 配置
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>interface Ethernet0/0
</span></span><span class=line><span class=cl> switchport trunk allowed vlan 10,20,30,99
</span></span><span class=line><span class=cl> switchport trunk encapsulation dot1q
</span></span><span class=line><span class=cl> switchport mode trunk
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>interface Ethernet0/1
</span></span><span class=line><span class=cl> switchport trunk allowed vlan 10,20,30,99
</span></span><span class=line><span class=cl> switchport trunk encapsulation dot1q
</span></span><span class=line><span class=cl> switchport mode trunk
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>interface Ethernet1/1
</span></span><span class=line><span class=cl> switchport access vlan 10
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>interface Ethernet1/2
</span></span><span class=line><span class=cl> switchport access vlan 20
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>interface Ethernet1/3
</span></span><span class=line><span class=cl> switchport access vlan 30
</span></span><span class=line><span class=cl>! --- 网管IP地址
</span></span><span class=line><span class=cl>interface Vlan99
</span></span><span class=line><span class=cl> ip address 20.1.1.10 255.255.255.0
</span></span><span class=line><span class=cl>! -- 本想使用 ip default-gateway，但是不起作用，下面这条效果是一样
</span></span><span class=line><span class=cl>ip route 0.0.0.0 0.0.0.0 20.1.1.254
</span></span><span class=line><span class=cl>! --- 网管配置 略
</span></span><span class=line><span class=cl>……
</span></span></code></pre></div><p>由于 VPCS 不支持 Telnet ，此处使用 DHCPServer 做测试。</p></li></ol><p><div class=post-img-view><a data-fancybox=gallery href=https://i.loli.net/2021/11/07/cuPSatd6w2E18Hq.jpg><img src=https://i.loli.net/2021/11/07/cuPSatd6w2E18Hq.jpg loading=lazy></a></div></p><ol start=3><li><p>R3 和 R4 作为内网用户的网关设备，互为热备份。</p><p><strong>S</strong>：这一条前面提过了，整个拓扑完整配置后边发，我打个包。</p></li><li><p>R3、R4、SW2 及 SW3 上不允许出现任何手工配置的静态路由条目。</p><p><strong>S</strong>：好的，满足你。</p></li><li><p>SW1 采用重发布的方式，将直连的服务器网段路由（如10.1.100.0/24）注入 EIGRP。</p><p><strong>S</strong>：好的，满足你。</p></li><li><p>内网用户（PC1、PC2）访问核心服务器 Server（10.1.100.1）的数据流走向如下：</p><p>PC1 访问 Server：R3 > R1 > SW2 > SW1 > Server；</p><p>PC2 访问 Server：R4 > R2 > SW3 > SW1 > Server；</p><p>沿途任何设备上到达 Server 的路由不允许出现负载均衡，且 PC 访问 Server 的流量往返路径一致。</p><p><strong>S</strong>：在配置完路由协议后，查看沿途设备路由表发现到达 Server 的路由出现负载均衡是正常现象，旁观大局，逐个处理就行。</p><p>但是有一个现象我不知是模拟器的 Bug 还是镜像的问题，查看 SW3 和 SW4 ，总有一台设备到达 Server 的路由是这样的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>D EX     10.1.100.0/24 [170/307200]
</span></span></code></pre></div><p>另一台学习到去往 Server 网段的路由是从上面这台学习到的外部路由，重启两台交换机的 OSPF 进程，这条路由又可能显示在第二台了。我又用 GNS3 做了测试，也是这种情况，按理说加载到路由表的不应该是管理距离为 110 的 OSPF 外部路由么？</p><p>我思考了一番，可能是 OSPF 进程启动先后顺序的问题，先启动的交换机 OSPF 进程加载了 EIGRP 外部路由，而后启动的交换机 OSPF 进程学习到 EIGRP 外部路由和 OSPF 外部路由，按照规则选择了管理距离值较小的 OSPF 路由条目。</p><p><strong>PC1 访问 Server：R3 > R1 > SW2 > SW1 > Server；</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>! --- R1 配置，修改 OSPF 入向接口的 cost ，使从 e0/0 收到去往10.1.100.0网段的路由更优
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>interface Ethernet0/1
</span></span><span class=line><span class=cl> ip ospf cost 11
</span></span><span class=line><span class=cl>!
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>! --- SW2 配置, 在 OSPF 进程下过滤入方向收到的去往 10.1.100.0 网段的条目，为什么这么做呢，从后面需求看，断掉 SW2/SW3 与 SW1 的线路之一，去往 Server的流量就不需要经过断掉线路这台交换机，而且断掉线路还要流量经过这台设备，走了个直角线路，并不是最优路径
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>router ospf 200
</span></span><span class=line><span class=cl> distribute-list 10 in
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>access-list 10 deny   10.1.100.0 0.0.0.255
</span></span><span class=line><span class=cl>access-list 10 permit any
</span></span><span class=line><span class=cl>!
</span></span></code></pre></div><p><strong>PC2 访问 Server ：R4 > R2 > SW3 > SW1 > Server；</strong></p><p>思路和 PC1 访问 Server 一样，逆推一下即可，不占用篇幅了（懒得码字）</p><p><strong>PC1 访问 Server 回程路径： Server> SW1 > SW2 > R1 >R3 ；</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>! --- SW1 配置，观察到去往内网网段的路由条目是负载均衡，配置偏移列表和指定入向接口，增加希望不要出现在路由表里的条目 metric 偏移，影响路由表加载
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>router eigrp 100
</span></span><span class=line><span class=cl> offset-list 20 in 1024 Ethernet0/2 
</span></span><span class=line><span class=cl> offset-list 10 in 1024 Ethernet0/1 
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>access-list 10 permit 10.1.20.0 0.0.0.255
</span></span><span class=line><span class=cl>access-list 20 permit 10.1.10.0 0.0.0.255
</span></span><span class=line><span class=cl> !
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>! --- SW2 配置，修改 e0/3 接口 cost，使得从该接口学习到去往 10.1.10.0 和 10.1.20.0 网段的路由不是最优路由
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>interface Ethernet0/3
</span></span><span class=line><span class=cl>  ip ospf cost 11
</span></span><span class=line><span class=cl>!
</span></span></code></pre></div><p><strong>PC2 访问 Server 回程路径： Server> SW1 > SW3 > R2 >R3 ；</strong></p><p>思路和 PC1 访问 Server 回程路径一样，逆推一下即可，不占用篇幅了（懒得码字）</p></li><li><p>要求 SW2 和 SW3 访问 Server 都走最优路径，即 SW2 前往 Server 的数据流走 SW1，SW3 前往 Server 的数据流也直接到 SW1。</p><p><strong>S</strong>：这一条也佐证了我在上面说到的流量走直角路径不是最优的想法。说的通俗一点就是：SW1 上的有流量要去往 Server 只能从 e0/1 出去，不走直角。即使 SW1 上的出口线路故障了也不走，走的路径是：拓扑上的对角线。退一步来说当 SW2/SW3 的出口线路故障了，下联的 R1/R2 不会从 SW2/SW3 学习到去往 Server 的路由条目。SW2 也是这个道理。</p></li></ol><p><div class=post-img-view><a data-fancybox=gallery href=https://i.loli.net/2021/11/07/VG6mjtd1Ww49iSv.jpg><img src=https://i.loli.net/2021/11/07/VG6mjtd1Ww49iSv.jpg loading=lazy></a></div></p><ol start=8><li><p>SW1 上关于 10.1.10.0/24 和 10.1.20.0/24 的路由不应该出现等价负载均衡，正常情况下访问 10.0/24 网段的数据流走 SW2，访问2 0.0/24 网段的数据流走 SW3。</p><p><strong>S</strong>：在 PC1/PC2 访问 Server 的回程路径时候已经解决这一条，不占用篇幅了（懒得码字）。</p></li><li><p>当 SW1-SW2 之间的链路 DOWN 掉时，PC1 访问 Server 的数据流切换至路径： R3>R1>SW3>SW1>Server，且往返路径一致。而当 SW1-SW3 之间的链路 DOWN 掉时，PC2 应该仍然能够访问 Server，情况类似。</p><p><strong>S</strong>：正如我前面所说的：当 SW2/SW3 的出口线路故障了，下联的 R1/R2 也不会从 SW2/SW3 学习到去往 Server 的路由条目。此时去往 Server 的流量已经在 R1/R2 通过走对角线的路径来到 SW3/SW2 上。</p><p>重点解决回程的路径。因为前面已经修改了 SW2 和 SW3 上的 e0/3 的 cost ，这就使得当 SW1-SW2 之间的链路 DOWN 掉或者 SW1-SW3 之间的链路 DOWN 掉时，SW3/SW2 去往 10.1.10.0 和 10.1.20.0 网段都是直线往下经过 R2 或者 R1 回程到业务网段，并不符合需求。需要添加策略路由 PBR 实现往返路径一致。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>! --- SW2 配置，配置匹配去往 10.1.20.0 网段的 ACL，配置 route-map 匹配 ACL ，设置去往10.1.20.0 网段的下一跳地址，配置 SLA 监测，最后在 e0/1 调用
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>access-list 101 permit ip any 10.1.20.0 0.0.0.255
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>route-map pbr_20.0 permit 10
</span></span><span class=line><span class=cl> match ip address 101
</span></span><span class=line><span class=cl> set ip next-hop verify-availability 10.1.254.105 1 track 1
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>ip sla 1
</span></span><span class=line><span class=cl> icmp-echo 10.1.254.105 source-interface Ethernet0/3
</span></span><span class=line><span class=cl> frequency 5
</span></span><span class=line><span class=cl>! 设置 delay 是为了及时观察现象，实际生产环境不需这么做
</span></span><span class=line><span class=cl> track 1 ip sla 1 reachability
</span></span><span class=line><span class=cl> delay down 5 up 3
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>ip sla schedule 1 life forever start-time now
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>interface Ethernet0/1
</span></span><span class=line><span class=cl> ip policy route-map pbr_20.0
</span></span><span class=line><span class=cl>!
</span></span></code></pre></div><p>当SW1-SW3之间的链路DOWN掉时，PC2应该仍然能够访问Server，情况类似。解决思路和上面一样，懒-码-字。</p></li><li><p>当 SW2-R1 之间的链路 DOWN 掉时，PC1 访问 Server 的数据流切换至路径：R3>R1>SW3>SW1>Server，此时不要求流量往返路径完全一致。当 SW3-R2 之间的链路 DOWN 掉时，PC2 应该仍能够访问到 Server。</p><p><strong>S</strong>：当 SW2-R1 之间的链路 DOWN 掉时，R1 是能够从 SW3 学习到去往 Server 的路由的，只是回程的时候路径是： Server> SW1 > SW2 > R2 >R4 ，不要求流量往返路径完全一致，本条需求已经自动实现了。当SW3-R2之间的链路DOWN掉时同理。</p></li><li><p>R3、R4 任意一台路由器与内网交换机直连链路 DOWN 掉，不影响内网 PC 访问外网。</p><p><strong>S</strong>：配置的 VRRP 可以实现。</p></li><li><p>【可选】若 R3 的出口 DOWN 或 R1 的两条上联链路都 DOWN，以上两种情况，R3 都能检测到，要求此两种情况发生时内网用户访问 SERVER 都不受影响，R4 同理。</p><p><strong>S</strong>：R3 的出口 DOWN 或 R1 的两条上联链路都 DOWN，明显要求配置 SLA 特性，我的做法是在 SW3 和 SW2 上配置一个环回地址，R3/R4 检测这个地址的可达性。举例：当 R3 配置了监测 SW3 的环回地址可达性，无论是 R3 的出口 DOWN 或 R1 的两条上联链路都 DOWN 其中一个条件达成，都会导致监测失败不可达，再在相应的内网子接口下配置 Track 联动降低 VRRP 组的优先级，使其成为 Backup 状态，另一台路由器成为 Master ，此时内网用户访问 Server 路径自动切换不受影响（其实还是会掉包的，取决于你配置的监测周期，抢占延时，生成树协议）。R4 同理。</p><p>（11月10日发现，可以使用 <strong>Track list</strong> 的方式实现）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>! --- R3 配置
</span></span><span class=line><span class=cl>interface Ethernet0/1.10
</span></span><span class=line><span class=cl> vrrp 10 track 1 decrement 21
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>ip sla 1
</span></span><span class=line><span class=cl> icmp-echo 33.33.33.33 source-interface Ethernet0/0
</span></span><span class=line><span class=cl> frequency 5
</span></span><span class=line><span class=cl>ip sla schedule 1 life forever start-time now
</span></span><span class=line><span class=cl>!
</span></span><span class=line><span class=cl>track 1 ip sla 1 reachability
</span></span><span class=line><span class=cl> delay down 5 up 3
</span></span><span class=line><span class=cl>!
</span></span></code></pre></div></li></ol><h2 id=ending>Ending</h2><ul><li>配置存阿里云盘了，这是链接：[<a class=link href=https://www.aliyundrive.com/s/VsEkNTBjuxy target=_blank rel=noopener>分享的文件
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>]</li><li>欢迎“<del>来电</del>”来函探讨。</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/network-emulator/>Network Emulator</a>
<a href=/tags/pnetlab/>PNETLab</a>
<a href=/tags/cisco/>Cisco</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/638be305/><div class=article-details><h2 class=article-title>多子网分支的第3阶段分层DMVPN实验</h2></div></a></article><article><a href=/posts/5c8077d9/><div class=article-details><h2 class=article-title>观察OSPF虚链路和虚链路的替代办法</h2></div></a></article><article><a href=/posts/c0ba4ae2/><div class=article-details><h2 class=article-title>配置跨域的Option C MPLS VPN（Cisco）</h2></div></a></article><article><a href=/posts/2e964a67/><div class=article-details><h2 class=article-title>IPv6 各隧道Tunnel使用Lab</h2></div></a></article><article><a href=/posts/48f55792/><div class=article-details><h2 class=article-title>BGP综合实验拓扑</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 <a href=https://github.com/kiraster target=_blank rel=noopener>@kiraster</a></section><section class=powerby><a href=https://github.com/kiraster target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a> <a href=https://space.bilibili.com/11565094 target=_blank title=Bilibili rel=me><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2"><path d="M3 10a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4v-6z"/><path d="M8 3l2 3"/><path d="M16 3l-2 3"/><path d="M9 13v-2"/><path d="M15 11v2"/></svg></a> <a href=mailto:kir_aster@foxmail.com target=_blank title=Email rel=me><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2"><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a><br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script src=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js integrity=sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css integrity=sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE crossorigin=anonymous><script>NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script><script>document.addEventListener("DOMContentLoaded",function(){jQuery(function(e){e("[data-fancybox]").fancybox()})})</script></body></html>