<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Introduction\nThis document describes how to configure and verify the Inter-AS Layer 3 Multiprotocol Label Switching (MPLS) VPN, option C feature. A sample network scenario and its configuration and outputs are shown for a better understanding.\n"><title>配置跨域的Option C MPLS VPN（Cisco）</title>
<link rel=canonical href=https://weeaster.github.io/posts/c0ba4ae2/><link rel=stylesheet href=/scss/style.min.655b8db05b082413bbbb47617eac892a6a33c4f697e079bf8c9ee93cfba90fa3.css><meta property='og:title' content="配置跨域的Option C MPLS VPN（Cisco）"><meta property='og:description' content="Introduction\nThis document describes how to configure and verify the Inter-AS Layer 3 Multiprotocol Label Switching (MPLS) VPN, option C feature. A sample network scenario and its configuration and outputs are shown for a better understanding.\n"><meta property='og:url' content='https://weeaster.github.io/posts/c0ba4ae2/'><meta property='og:site_name' content="Kir's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Network Emulator'><meta property='article:tag' content='PNETLab'><meta property='article:tag' content='Cisco'><meta property='article:tag' content='MPLS VPN'><meta property='article:tag' content='Option C'><meta property='article:tag' content='跨域'><meta property='article:tag' content='nter-AS'><meta property='article:published_time' content='2023-03-04T01:05:34+00:00'><meta property='article:modified_time' content='2023-03-04T01:05:34+00:00'><meta name=twitter:title content="配置跨域的Option C MPLS VPN（Cisco）"><meta name=twitter:description content="Introduction\nThis document describes how to configure and verify the Inter-AS Layer 3 Multiprotocol Label Switching (MPLS) VPN, option C feature. A sample network scenario and its configuration and outputs are shown for a better understanding.\n"><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZZ2XLP4292"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZZ2XLP4292")}</script><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","heff72hdac")</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu16060348347131247650.jpg width=300 height=283 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Kir's Blog</a></h1><h2 class=site-description>@kiraster</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/gallery/><svg viewBox="0 0 24 24" fill="none" width="24" height="24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke="currentcolor"><path d="M15 8h.01"/><path d="M12.5 21H6a3 3 0 01-3-3V6a3 3 0 013-3h12a3 3 0 013 3v6.5"/><path d="M3 16l5-5c.928-.893 2.072-.893 3 0l4 4"/><path d="M14 14l1-1c.67-.644 1.45-.824 2.182-.54"/><path d="M16 19h6"/><path d="M19 16v6"/></svg>
<span>Gallery</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#环境>环境</a></li><li><a href=#配置>配置</a><ol><li><a href=#网络拓扑>网络拓扑</a></li><li><a href=#拓扑规划>拓扑规划</a></li><li><a href=#配置思路>配置思路</a></li><li><a href=#配置步骤>配置步骤</a><ol><li><a href=#配置-ip-地址-略>配置 IP 地址 （略）</a></li><li><a href=#配置-isp-底层-igp-以-isp-1-为例isp2-同理>配置 ISP 底层 IGP （以 ISP 1 为例，ISP2 同理）</a></li><li><a href=#配置-isp-启用-mpls-ldp-以-isp-1-为例isp2-同理>配置 ISP 启用 MPLS LDP （以 ISP 1 为例，ISP2 同理）</a></li><li><a href=#配置-pe-的-vrf配置与-ce-互联的接口划分到-vrf>配置 PE 的 VRF，配置与 CE 互联的接口划分到 VRF</a></li><li><a href=#配置-isp-的-bgp-邻居>配置 ISP 的 BGP 邻居</a></li><li><a href=#配置-ce-和-pe-间的路由协议>配置 CE 和 PE 间的路由协议</a></li><li><a href=#配置-pe-上-双向重分布>配置 PE 上 双向重分布</a></li><li><a href=#优化isp-内部-ospf-下一跳>优化ISP 内部 OSPF 下一跳</a></li></ol></li><li><a href=#测试>测试</a></li></ol></li><li><a href=#一个视频>一个视频</a></li><li><a href=#最后>最后</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/pnetlab/ style=background-color:#cae1ff;color:#fff>PNETLab</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/c0ba4ae2/>配置跨域的Option C MPLS VPN（Cisco）</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 04, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>15 minute read</time></div></footer></div></header><section class=article-content><p><strong>Introduction</strong></p><p>This document describes how to configure and verify the Inter-AS Layer 3 Multiprotocol Label Switching (MPLS) VPN, option C feature. A sample network scenario and its configuration and outputs are shown for a better understanding.</p><p>本文描述的是根据思科网站一篇配置文档（https://www.cisco.com/c/en/us/support/docs/multiprotocol-label-switching-mpls/mpls/200523-Configuration-and-Verification-of-Layer.html#）修改搭建的一个实验。</p><hr><h2 id=环境>环境</h2><ul><li>模拟器：PNET 4.2.10</li><li>Cisco IOL： l3-ADVENTERPRISEK9-M-15.4-2T.bin</li></ul><h2 id=配置>配置</h2><h3 id=网络拓扑>网络拓扑</h3><p><strong>网站原图</strong></p><p><div class=post-img-view><a data-fancybox=gallery href=https://s2.loli.net/2023/03/07/oZLaRtUIcxgjFqe.jpg><img src=https://s2.loli.net/2023/03/07/oZLaRtUIcxgjFqe.jpg loading=lazy alt=200523-Configuration-and-Verification-of-Layer-00></a></div></p><p><strong>搭建的拓扑</strong></p><p><div class=post-img-view><a data-fancybox=gallery href=https://s2.loli.net/2023/03/07/S4HEnAgOUe6QYpj.jpg><img src=https://s2.loli.net/2023/03/07/S4HEnAgOUe6QYpj.jpg loading=lazy alt=ScreenCaputure230304012642></a></div></p><h3 id=拓扑规划>拓扑规划</h3><ol><li>每台路由配置环回接口 0 ，格式为 R1： 1.1.1.1/32</li><li>互联接口为：设备编号1 + 设备编号2 + .1.1 + 设备编号1，例如 R1 e0/0 接口IP地址：12.1.1.1/24</li><li>R7、R8、R9、R10 为 CE，R11 和 R12 为 反射器</li><li>ISP1，ISP2 底层 IGP 运行 OSPF 协议</li><li>A1，A2 的 CE 与 PE 运行 OSPF 协议</li><li>B1，B2 的 CE 与 PE 运行 BGP 协议</li></ol><h3 id=配置思路>配置思路</h3><ol><li>配置 ISP 底层 OSPF IGP ，验证：show ip os nei / show ip route ospf</li><li>配置 ISP 启用 MPLS LDP，验证：show mpls interface / show mpls ldp discovery</li><li>配置 PE VRF，配置与 CE 互联接口划分到 VRF，验证：show ip vrf int / show ip route vrf <strong>X</strong></li><li>配置 ISP 的 BGP 邻居，验证：show ip b summ / show ip b vpnv4 all summ</li><li>配置 RR1 和 RR2 的 MP-eBGP，验证：show ip b vpnv4 all summ</li><li>配置 CE 和 PE 间的路由协议，验证：show ip route vrf <strong>X</strong> / show ip os nei / show ip b summ</li><li>配置 PE 上 双向重分布</li></ol><h3 id=配置步骤>配置步骤</h3><ol><li><h4 id=配置-ip-地址-略>配置 IP 地址 （略）</h4></li><li><h4 id=配置-isp-底层-igp-以-isp-1-为例isp2-同理>配置 ISP 底层 IGP （以 ISP 1 为例，ISP2 同理）</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R1 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ran e 0/0,e0/3,lo0
</span></span><span class=line><span class=cl> ip os 100 a 0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R2 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ran e0/0-1,e0/3,lo0
</span></span><span class=line><span class=cl> ip os 100 a 0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R3 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ran e 0/1,e0/3,lo0
</span></span><span class=line><span class=cl> ip os 100 a 0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R11 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ran e 0/1-3,lo0
</span></span><span class=line><span class=cl> ip os 100 a 0
</span></span></code></pre></div><p>**验证：**查看 OSPF 邻居，查看 OSPF 路由，以 R2 为例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R2 output.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R2#sh ip os nei
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Neighbor ID     Pri   State           Dead Time   Address         Interface
</span></span><span class=line><span class=cl>11.11.11.11       1   FULL/BDR        00:00:39    112.1.1.11      Ethernet0/3
</span></span><span class=line><span class=cl>3.3.3.3           1   FULL/DR         00:00:30    23.1.1.3        Ethernet0/1
</span></span><span class=line><span class=cl>1.1.1.1           1   FULL/BDR        00:00:39    12.1.1.1        Ethernet0/0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R2#sh ip route ospf | b Gate
</span></span><span class=line><span class=cl>Gateway of last resort is not set
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      1.0.0.0/32 is subnetted, 1 subnets
</span></span><span class=line><span class=cl>O        1.1.1.1 [110/11] via 12.1.1.1, 02:06:04, Ethernet0/0
</span></span><span class=line><span class=cl>      3.0.0.0/32 is subnetted, 1 subnets
</span></span><span class=line><span class=cl>O        3.3.3.3 [110/11] via 23.1.1.3, 02:05:54, Ethernet0/1
</span></span><span class=line><span class=cl>      11.0.0.0/32 is subnetted, 1 subnets
</span></span><span class=line><span class=cl>O        11.11.11.11 [110/11] via 112.1.1.11, 02:05:54, Ethernet0/3
</span></span><span class=line><span class=cl>      111.0.0.0/24 is subnetted, 1 subnets
</span></span><span class=line><span class=cl>O        111.1.1.0 [110/20] via 12.1.1.1, 02:06:04, Ethernet0/0
</span></span><span class=line><span class=cl>      113.0.0.0/24 is subnetted, 1 subnets
</span></span><span class=line><span class=cl>O        113.1.1.0 [110/20] via 23.1.1.3, 02:05:54, Ethernet0/1
</span></span><span class=line><span class=cl>R2#
</span></span></code></pre></div></li><li><h4 id=配置-isp-启用-mpls-ldp-以-isp-1-为例isp2-同理>配置 ISP 启用 MPLS LDP （以 ISP 1 为例，ISP2 同理）</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R1 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ran e 0/0,e0/3    
</span></span><span class=line><span class=cl> mpls ip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R2 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ran e0/0-1,e0/3    
</span></span><span class=line><span class=cl> mpls ip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R3 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ran e 0/1,e0/3    
</span></span><span class=line><span class=cl> mpls ip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R11 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ran e 0/1-3
</span></span><span class=line><span class=cl> mpls ip
</span></span></code></pre></div><p><strong>验证：</strong> 查看 LDP 接口和 ldp 会话，以 R2 为例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R2 output.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R2#sh mpls interfaces 
</span></span><span class=line><span class=cl>Interface              IP            Tunnel   BGP Static Operational
</span></span><span class=line><span class=cl>Ethernet0/0            Yes (ldp)     No       No  No     Yes        
</span></span><span class=line><span class=cl>Ethernet0/1            Yes (ldp)     No       No  No     Yes        
</span></span><span class=line><span class=cl>Ethernet0/3            Yes (ldp)     No       No  No     Yes        
</span></span><span class=line><span class=cl>R2#sh mpls ldp dis
</span></span><span class=line><span class=cl>R2#sh mpls ldp discovery 
</span></span><span class=line><span class=cl> Local LDP Identifier:
</span></span><span class=line><span class=cl>    2.2.2.2:0
</span></span><span class=line><span class=cl>    Discovery Sources:
</span></span><span class=line><span class=cl>    Interfaces:
</span></span><span class=line><span class=cl>        Ethernet0/0 (ldp): xmit/recv
</span></span><span class=line><span class=cl>            LDP Id: 1.1.1.1:0
</span></span><span class=line><span class=cl>        Ethernet0/1 (ldp): xmit/recv
</span></span><span class=line><span class=cl>            LDP Id: 3.3.3.3:0
</span></span><span class=line><span class=cl>        Ethernet0/3 (ldp): xmit/recv
</span></span><span class=line><span class=cl>            LDP Id: 11.11.11.11:0
</span></span><span class=line><span class=cl>R2#
</span></span></code></pre></div></li><li><h4 id=配置-pe-的-vrf配置与-ce-互联的接口划分到-vrf>配置 PE 的 VRF，配置与 CE 互联的接口划分到 VRF</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>!---</span> <span class=n>R1</span> <span class=n>commands</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ip</span> <span class=n>vrf</span> <span class=n>a</span>
</span></span><span class=line><span class=cl> <span class=n>rd</span> <span class=mi>7</span><span class=p>:</span><span class=mi>100</span>
</span></span><span class=line><span class=cl> <span class=n>route</span><span class=o>-</span><span class=n>target</span> <span class=k>export</span> <span class=mi>7</span><span class=p>:</span><span class=mi>7</span>
</span></span><span class=line><span class=cl> <span class=n>route</span><span class=o>-</span><span class=n>target</span> <span class=n>import</span> <span class=mi>9</span><span class=p>:</span><span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=n>ip</span> <span class=n>vrf</span> <span class=n>b</span>
</span></span><span class=line><span class=cl> <span class=n>rd</span> <span class=mi>8</span><span class=p>:</span><span class=mi>100</span>
</span></span><span class=line><span class=cl> <span class=n>route</span><span class=o>-</span><span class=n>target</span> <span class=k>export</span> <span class=mi>8</span><span class=p>:</span><span class=mi>8</span>
</span></span><span class=line><span class=cl> <span class=n>route</span><span class=o>-</span><span class=n>target</span> <span class=n>import</span> <span class=mi>10</span><span class=p>:</span><span class=mi>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=n>interface</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>1</span>
</span></span><span class=line><span class=cl> <span class=n>ip</span> <span class=n>vrf</span> <span class=n>forwarding</span> <span class=n>a</span>
</span></span><span class=line><span class=cl> <span class=n>ip</span> <span class=n>address</span> <span class=mf>17.1</span><span class=o>.</span><span class=mf>1.1</span> <span class=mf>255.255</span><span class=o>.</span><span class=mf>255.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>interface</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>2</span>
</span></span><span class=line><span class=cl> <span class=n>ip</span> <span class=n>vrf</span> <span class=n>forwarding</span> <span class=n>b</span>
</span></span><span class=line><span class=cl> <span class=n>ip</span> <span class=n>address</span> <span class=mf>18.1</span><span class=o>.</span><span class=mf>1.1</span> <span class=mf>255.255</span><span class=o>.</span><span class=mf>255.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>!---</span> <span class=n>R6</span> <span class=n>commands</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ip</span> <span class=n>vrf</span> <span class=n>a</span>
</span></span><span class=line><span class=cl> <span class=n>rd</span> <span class=mi>9</span><span class=p>:</span><span class=mi>200</span>
</span></span><span class=line><span class=cl> <span class=n>route</span><span class=o>-</span><span class=n>target</span> <span class=k>export</span> <span class=mi>9</span><span class=p>:</span><span class=mi>9</span>
</span></span><span class=line><span class=cl> <span class=n>route</span><span class=o>-</span><span class=n>target</span> <span class=n>import</span> <span class=mi>7</span><span class=p>:</span><span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=n>ip</span> <span class=n>vrf</span> <span class=n>b</span>
</span></span><span class=line><span class=cl> <span class=n>rd</span> <span class=mi>10</span><span class=p>:</span><span class=mi>200</span>
</span></span><span class=line><span class=cl> <span class=n>route</span><span class=o>-</span><span class=n>target</span> <span class=k>export</span> <span class=mi>10</span><span class=p>:</span><span class=mi>10</span>
</span></span><span class=line><span class=cl> <span class=n>route</span><span class=o>-</span><span class=n>target</span> <span class=n>import</span> <span class=mi>8</span><span class=p>:</span><span class=mi>8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>interface</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>1</span>
</span></span><span class=line><span class=cl> <span class=n>ip</span> <span class=n>vrf</span> <span class=n>forwarding</span> <span class=n>a</span>
</span></span><span class=line><span class=cl> <span class=n>ip</span> <span class=n>address</span> <span class=mf>69.1</span><span class=o>.</span><span class=mf>1.6</span> <span class=mf>255.255</span><span class=o>.</span><span class=mf>255.0</span>
</span></span><span class=line><span class=cl><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=n>interface</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>2</span>
</span></span><span class=line><span class=cl> <span class=n>ip</span> <span class=n>vrf</span> <span class=n>forwarding</span> <span class=n>b</span>
</span></span><span class=line><span class=cl> <span class=n>ip</span> <span class=n>address</span> <span class=mf>106.1</span><span class=o>.</span><span class=mf>1.6</span> <span class=mf>255.255</span><span class=o>.</span><span class=mf>255.0</span>
</span></span></code></pre></div><p>**验证：**查看 VRF 路由表，以 R1 为例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>!---</span> <span class=n>R1</span> <span class=n>output</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>R1</span><span class=c1>#sh ip route vrf a | b Gate</span>
</span></span><span class=line><span class=cl><span class=n>Gateway</span> <span class=n>of</span> <span class=n>last</span> <span class=n>resort</span> <span class=n>is</span> <span class=ow>not</span> <span class=n>set</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=mf>7.0</span><span class=o>.</span><span class=mf>0.0</span><span class=o>/</span><span class=mi>32</span> <span class=n>is</span> <span class=n>subnetted</span><span class=p>,</span> <span class=mi>1</span> <span class=n>subnets</span>
</span></span><span class=line><span class=cl><span class=n>O</span>        <span class=mf>7.7</span><span class=o>.</span><span class=mf>7.7</span> <span class=p>[</span><span class=mi>110</span><span class=o>/</span><span class=mi>11</span><span class=p>]</span> <span class=n>via</span> <span class=mf>17.1</span><span class=o>.</span><span class=mf>1.7</span><span class=p>,</span> <span class=mi>02</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>47</span><span class=p>,</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>      <span class=mf>17.0</span><span class=o>.</span><span class=mf>0.0</span><span class=o>/</span><span class=mi>8</span> <span class=n>is</span> <span class=n>variably</span> <span class=n>subnetted</span><span class=p>,</span> <span class=mi>2</span> <span class=n>subnets</span><span class=p>,</span> <span class=mi>2</span> <span class=n>masks</span>
</span></span><span class=line><span class=cl><span class=n>C</span>        <span class=mf>17.1</span><span class=o>.</span><span class=mf>1.0</span><span class=o>/</span><span class=mi>24</span> <span class=n>is</span> <span class=n>directly</span> <span class=n>connected</span><span class=p>,</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>L</span>        <span class=mf>17.1</span><span class=o>.</span><span class=mf>1.1</span><span class=o>/</span><span class=mi>32</span> <span class=n>is</span> <span class=n>directly</span> <span class=n>connected</span><span class=p>,</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>R1</span><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=n>R1</span><span class=c1>#sh ip route vrf b | b Gate</span>
</span></span><span class=line><span class=cl><span class=n>Gateway</span> <span class=n>of</span> <span class=n>last</span> <span class=n>resort</span> <span class=n>is</span> <span class=ow>not</span> <span class=n>set</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=mf>8.0</span><span class=o>.</span><span class=mf>0.0</span><span class=o>/</span><span class=mi>32</span> <span class=n>is</span> <span class=n>subnetted</span><span class=p>,</span> <span class=mi>1</span> <span class=n>subnets</span>
</span></span><span class=line><span class=cl><span class=n>B</span>        <span class=mf>8.8</span><span class=o>.</span><span class=mf>8.8</span> <span class=p>[</span><span class=mi>20</span><span class=o>/</span><span class=mi>0</span><span class=p>]</span> <span class=n>via</span> <span class=mf>18.1</span><span class=o>.</span><span class=mf>1.8</span><span class=p>,</span> <span class=mi>02</span><span class=p>:</span><span class=mi>16</span><span class=p>:</span><span class=mi>08</span>
</span></span><span class=line><span class=cl>      <span class=mf>18.0</span><span class=o>.</span><span class=mf>0.0</span><span class=o>/</span><span class=mi>8</span> <span class=n>is</span> <span class=n>variably</span> <span class=n>subnetted</span><span class=p>,</span> <span class=mi>2</span> <span class=n>subnets</span><span class=p>,</span> <span class=mi>2</span> <span class=n>masks</span>
</span></span><span class=line><span class=cl><span class=n>C</span>        <span class=mf>18.1</span><span class=o>.</span><span class=mf>1.0</span><span class=o>/</span><span class=mi>24</span> <span class=n>is</span> <span class=n>directly</span> <span class=n>connected</span><span class=p>,</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>L</span>        <span class=mf>18.1</span><span class=o>.</span><span class=mf>1.1</span><span class=o>/</span><span class=mi>32</span> <span class=n>is</span> <span class=n>directly</span> <span class=n>connected</span><span class=p>,</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>R1</span><span class=c1>#</span>
</span></span></code></pre></div></li><li><h4 id=配置-isp-的-bgp-邻居>配置 ISP 的 BGP 邻居</h4><p><strong>R3 与 R4 配置 IPv4 BGP 邻居，R3 宣告 1.1.1.1 和 11.11.11.11，R4 宣告 6.6.6.6 和 12.12.12.12</strong></p><p><strong>将 BGP 路由重分布进底层 OSPF 协议，为了学习到对端 RR 和 PE 路由，建立 MP-BGP 需要</strong></p><p>由于底层 OSPF 协议的运行，R3 与 R4 已经学习到这些路由，在建立 eBGP 邻居后能传递到对端</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R3 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 100
</span></span><span class=line><span class=cl> bgp log-neighbor-changes
</span></span><span class=line><span class=cl> network 1.1.1.1 mask 255.255.255.255
</span></span><span class=line><span class=cl> network 11.11.11.11 mask 255.255.255.255
</span></span><span class=line><span class=cl> neighbor 34.1.1.4 remote-as 200
</span></span><span class=line><span class=cl> neighbor 34.1.1.4 send-label
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router ospf 100
</span></span><span class=line><span class=cl> redistribute bgp 100 subnets
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R4 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 200
</span></span><span class=line><span class=cl> bgp log-neighbor-changes
</span></span><span class=line><span class=cl> network 6.6.6.6 mask 255.255.255.255
</span></span><span class=line><span class=cl> network 12.12.12.12 mask 255.255.255.255
</span></span><span class=line><span class=cl> neighbor 34.1.1.3 remote-as 100
</span></span><span class=line><span class=cl> neighbor 34.1.1.3 send-label
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router ospf 200
</span></span><span class=line><span class=cl> redistribute bgp 200 subnets
</span></span></code></pre></div><p><strong>验证：</strong></p><p>R3 与 R4 的 eBGP 邻居</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R3#sh ip b summary 
</span></span><span class=line><span class=cl>BGP router identifier 3.3.3.3, local AS number 100
</span></span><span class=line><span class=cl>BGP table version is 75, main routing table version 75
</span></span><span class=line><span class=cl>4 network entries using 560 bytes of memory
</span></span><span class=line><span class=cl>4 path entries using 320 bytes of memory
</span></span><span class=line><span class=cl>4/4 BGP path/bestpath attribute entries using 576 bytes of memory
</span></span><span class=line><span class=cl>1 BGP AS-PATH entries using 24 bytes of memory
</span></span><span class=line><span class=cl>0 BGP route-map cache entries using 0 bytes of memory
</span></span><span class=line><span class=cl>0 BGP filter-list cache entries using 0 bytes of memory
</span></span><span class=line><span class=cl>BGP using 1480 total bytes of memory
</span></span><span class=line><span class=cl>BGP activity 4/0 prefixes, 36/32 paths, scan interval 60 secs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
</span></span><span class=line><span class=cl>34.1.1.4        4          200      90      90       75    0    0 01:16:45        0
</span></span></code></pre></div><p>R1 的 1.1.1.1 去往 R6 的 6.6.6.6 路由可达，标签路径连续</p><p>R11 的 11.11.11.11 去往 R12 的 12.12.12.12 路由可达，标签路径连续</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R1#ping  6.6.6.6 source 1.1.1.1        
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Sending 5, 100-byte ICMP Echos to 6.6.6.6, timeout is 2 seconds:
</span></span><span class=line><span class=cl>Packet sent with a source address of 1.1.1.1 
</span></span><span class=line><span class=cl>!!!!!
</span></span><span class=line><span class=cl>Success rate is 100 percent (5/5), round-trip min/avg/max = 6/6/8 ms
</span></span><span class=line><span class=cl>R1#traceroute 6.6.6.6 source 1.1.1.1
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Tracing the route to 6.6.6.6
</span></span><span class=line><span class=cl>VRF info: (vrf in name/id, vrf out name/id)
</span></span><span class=line><span class=cl>  1 12.1.1.2 [MPLS: Label 24 Exp 0] 5 msec 6 msec 6 msec
</span></span><span class=line><span class=cl>  2 23.1.1.3 [MPLS: Label 26 Exp 0] 6 msec 5 msec 6 msec
</span></span><span class=line><span class=cl>  3 34.1.1.4 [MPLS: Label 27 Exp 0] 7 msec 7 msec 5 msec
</span></span><span class=line><span class=cl>  4 45.1.1.5 [MPLS: Label 22 Exp 0] 4 msec 5 msec 6 msec
</span></span><span class=line><span class=cl>  5 56.1.1.6 6 msec *  7 msec
</span></span><span class=line><span class=cl>R1#
</span></span><span class=line><span class=cl>----------------------------------------------------------
</span></span><span class=line><span class=cl>R11#ping 12.12.12.12 source 11.11.11.11
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Sending 5, 100-byte ICMP Echos to 12.12.12.12, timeout is 2 seconds:
</span></span><span class=line><span class=cl>Packet sent with a source address of 11.11.11.11 
</span></span><span class=line><span class=cl>!!!!!
</span></span><span class=line><span class=cl>Success rate is 100 percent (5/5), round-trip min/avg/max = 3/3/4 ms
</span></span><span class=line><span class=cl>R11#trace 12.12.12.12 source 11.11.11.11
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Tracing the route to 12.12.12.12
</span></span><span class=line><span class=cl>VRF info: (vrf in name/id, vrf out name/id)
</span></span><span class=line><span class=cl>  1 113.1.1.3 [MPLS: Label 27 Exp 0] 4 msec 4 msec 4 msec
</span></span><span class=line><span class=cl>  2 34.1.1.4 [MPLS: Label 25 Exp 0] 3 msec 2 msec 2 msec
</span></span><span class=line><span class=cl>  3 124.1.1.12 4 msec *  4 msec
</span></span><span class=line><span class=cl>R11#
</span></span></code></pre></div><p><strong>关于send-label 命令：</strong></p><p>tell the router to send the lables of bgp prefix to its peer，为 BGP 路由传递标签，使用此命令后，对应接口自动配置 mpls bgp forwarding ，但是 no 掉后接口的这行配置并不会自动去掉</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>*Mar  4 05:54:10.850: %BGP_LMM-6-AUTOGEN1: The mpls bgp forwarding command has been configured on interface: Ethernet0/0
</span></span></code></pre></div><p>未配置 <strong>send-label</strong> 命令前，R3 去往 6.6.6.6 的标签 是空标签，R3 的动作是弹出所有标签，标签中断。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R3#sh mpls forwarding-table 6.6.6.6
</span></span><span class=line><span class=cl>Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
</span></span><span class=line><span class=cl>Label      Label      or Tunnel Id     Switched      interface              
</span></span><span class=line><span class=cl>26         No Label   6.6.6.6/32       0             Et0/0      34.1.1.4    
</span></span><span class=line><span class=cl>R3#sh ip b la                      
</span></span><span class=line><span class=cl>R3#sh ip b labels 
</span></span><span class=line><span class=cl>   Network          Next Hop      In label/Out label
</span></span><span class=line><span class=cl>   1.1.1.1/32       23.1.1.2        nolabel/nolabel
</span></span><span class=line><span class=cl>   6.6.6.6/32       34.1.1.4        nolabel/nolabel
</span></span><span class=line><span class=cl>   11.11.11.11/32   113.1.1.11      nolabel/nolabel
</span></span><span class=line><span class=cl>   12.12.12.12/32   34.1.1.4        nolabel/nolabel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R3#sh ip b 6.6.6.6        
</span></span><span class=line><span class=cl>BGP routing table entry for 6.6.6.6/32, version 66
</span></span><span class=line><span class=cl>Paths: (1 available, best #1, table default)
</span></span><span class=line><span class=cl>  Not advertised to any peer
</span></span><span class=line><span class=cl>  Refresh Epoch 1
</span></span><span class=line><span class=cl>  200
</span></span><span class=line><span class=cl>    34.1.1.4 from 34.1.1.4 (4.4.4.4)
</span></span><span class=line><span class=cl>      Origin IGP, metric 21, localpref 100, valid, external, best
</span></span><span class=line><span class=cl>      rx pathid: 0, tx pathid: 0x0
</span></span><span class=line><span class=cl>R3#
</span></span></code></pre></div><p>配置 <strong>send-label</strong> 命令后，分配 27 标签</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R3#sh mpls forwarding-table 6.6.6.6
</span></span><span class=line><span class=cl>Local      Outgoing   Prefix           Bytes Label   Outgoing   Next Hop    
</span></span><span class=line><span class=cl>Label      Label      or Tunnel Id     Switched      interface              
</span></span><span class=line><span class=cl>26         27         6.6.6.6/32       0             Et0/0      34.1.1.4    
</span></span><span class=line><span class=cl>R3#sh ip b labels                  
</span></span><span class=line><span class=cl>   Network          Next Hop      In label/Out label
</span></span><span class=line><span class=cl>   1.1.1.1/32       23.1.1.2        21/nolabel
</span></span><span class=line><span class=cl>   6.6.6.6/32       34.1.1.4        nolabel/27
</span></span><span class=line><span class=cl>   11.11.11.11/32   113.1.1.11      25/nolabel
</span></span><span class=line><span class=cl>   12.12.12.12/32   34.1.1.4        nolabel/25
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R3#sh ip b 6.6.6.6                 
</span></span><span class=line><span class=cl>BGP routing table entry for 6.6.6.6/32, version 56
</span></span><span class=line><span class=cl>Paths: (1 available, best #1, table default)
</span></span><span class=line><span class=cl>  Not advertised to any peer
</span></span><span class=line><span class=cl>  Refresh Epoch 1
</span></span><span class=line><span class=cl>  200
</span></span><span class=line><span class=cl>    34.1.1.4 from 34.1.1.4 (4.4.4.4)
</span></span><span class=line><span class=cl>      Origin IGP, metric 21, localpref 100, valid, external, best
</span></span><span class=line><span class=cl>      mpls labels in/out nolabel/27
</span></span><span class=line><span class=cl>      rx pathid: 0, tx pathid: 0x0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 在 R4 上查看到关于去往6.6.6.6 的 入向标签 27
</span></span><span class=line><span class=cl>R4#sh ip bgp labels 
</span></span><span class=line><span class=cl>   Network          Next Hop      In label/Out label
</span></span><span class=line><span class=cl>   1.1.1.1/32       34.1.1.3        nolabel/21
</span></span><span class=line><span class=cl>   6.6.6.6/32       45.1.1.5        27/nolabel
</span></span><span class=line><span class=cl>   11.11.11.11/32   34.1.1.3        nolabel/25
</span></span><span class=line><span class=cl>   12.12.12.12/32   124.1.1.12      25/nolabel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R4#
</span></span></code></pre></div><p><strong>R1 与 R11 配置 BGP VPNV4 邻居</strong></p><p>注意：R3 与 R11 不建立 BGP 邻居</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R1 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 100
</span></span><span class=line><span class=cl> no bgp default ipv4-unicast
</span></span><span class=line><span class=cl> neighbor 11.11.11.11 remote-as 100
</span></span><span class=line><span class=cl> neighbor 11.11.11.11 update-source Loopback0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> address-family vpnv4
</span></span><span class=line><span class=cl>  neighbor 11.11.11.11 activate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R11 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 100
</span></span><span class=line><span class=cl> bgp log-neighbor-changes
</span></span><span class=line><span class=cl> no bgp default ipv4-unicast
</span></span><span class=line><span class=cl> neighbor 1.1.1.1 remote-as 100
</span></span><span class=line><span class=cl> neighbor 1.1.1.1 update-source Loopback0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> address-family vpnv4
</span></span><span class=line><span class=cl>  neighbor 1.1.1.1 activate
</span></span><span class=line><span class=cl>  neighbor 1.1.1.1 route-reflector-client
</span></span></code></pre></div><p><strong>R6 与 R12 配置 BGP VPNV4 邻居</strong></p><p>注意：R4 与 R12 不建立 BGP 邻居</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R6 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 200
</span></span><span class=line><span class=cl> no bgp default ipv4-unicast
</span></span><span class=line><span class=cl> neighbor 12.12.12.12 remote-as 200
</span></span><span class=line><span class=cl> neighbor 12.12.12.12 update-source Loopback0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> address-family vpnv4
</span></span><span class=line><span class=cl>  neighbor 12.12.12.12 activate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R12 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 200
</span></span><span class=line><span class=cl> no bgp default ipv4-unicast
</span></span><span class=line><span class=cl> neighbor 6.6.6.6 remote-as 200
</span></span><span class=line><span class=cl> neighbor 6.6.6.6 update-source Loopback0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> address-family vpnv4
</span></span><span class=line><span class=cl>  neighbor 6.6.6.6 activate
</span></span><span class=line><span class=cl>  neighbor 6.6.6.6 route-reflector-client
</span></span></code></pre></div><p>**验证：**VPNV4 邻居</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sh ip b vpnv4 all summary 
</span></span></code></pre></div><p><strong>R11 与 R12 建立 MP-eBGP 邻居</strong></p><p>设置 eBGP 多跳。不是物理直连的 eBGP 邻居</p><p>设置下一跳不改变。R11 与 R12 建立 MP-eBGP 邻居，传递路由时默认下一跳改变成自身，这样 ISP 两侧的流量互通都流经反射器不合理，设置下一跳不改变后，R1 上去往 ISP2 CE 的路由下一跳看到的是 R6 的 6.6.6.6 ，最后再在两个 ISP 内部控制底层 IGP 的路径，使得流量不经过反射器。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R11 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 100
</span></span><span class=line><span class=cl> neighbor 12.12.12.12 remote-as 200
</span></span><span class=line><span class=cl> neighbor 12.12.12.12 ebgp-multihop 255
</span></span><span class=line><span class=cl> neighbor 12.12.12.12 update-source Loopback0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> address-family vpnv4
</span></span><span class=line><span class=cl>  neighbor 12.12.12.12 activate
</span></span><span class=line><span class=cl>  neighbor 12.12.12.12 next-hop-unchanged
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R12 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 200
</span></span><span class=line><span class=cl> neighbor 11.11.11.11 remote-as 100
</span></span><span class=line><span class=cl> neighbor 11.11.11.11 ebgp-multihop 255
</span></span><span class=line><span class=cl> neighbor 11.11.11.11 update-source Loopback0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> address-family vpnv4
</span></span><span class=line><span class=cl>  neighbor 11.11.11.11 activate
</span></span><span class=line><span class=cl>  neighbor 11.11.11.11 next-hop-unchanged
</span></span></code></pre></div><p>验证：查看 R11 上的 BGP 邻居</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R11#sh ip b vpnv4 all summary 
</span></span><span class=line><span class=cl>BGP router identifier 11.11.11.11, local AS number 100
</span></span><span class=line><span class=cl>BGP table version is 67, main routing table version 67
</span></span><span class=line><span class=cl>6 network entries using 912 bytes of memory
</span></span><span class=line><span class=cl>6 path entries using 480 bytes of memory
</span></span><span class=line><span class=cl>5/5 BGP path/bestpath attribute entries using 760 bytes of memory
</span></span><span class=line><span class=cl>3 BGP AS-PATH entries using 72 bytes of memory
</span></span><span class=line><span class=cl>4 BGP extended community entries using 128 bytes of memory
</span></span><span class=line><span class=cl>0 BGP route-map cache entries using 0 bytes of memory
</span></span><span class=line><span class=cl>0 BGP filter-list cache entries using 0 bytes of memory
</span></span><span class=line><span class=cl>BGP using 2352 total bytes of memory
</span></span><span class=line><span class=cl>BGP activity 6/0 prefixes, 6/0 paths, scan interval 60 secs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
</span></span><span class=line><span class=cl>1.1.1.1         4          100     127     151       67    0    0 01:50:57        3
</span></span><span class=line><span class=cl>12.12.12.12     4          200     190     185       67    0    0 01:50:16        3
</span></span><span class=line><span class=cl>R11#
</span></span></code></pre></div></li><li><h4 id=配置-ce-和-pe-间的路由协议>配置 CE 和 PE 间的路由协议</h4><p>以 R7，R8，R1 为例， R9，R10，R6 同理</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R7 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ran e 0/0,lo0
</span></span><span class=line><span class=cl> ip os 7 a 0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R8 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 300
</span></span><span class=line><span class=cl> network 8.8.8.8 mask 255.255.255.255
</span></span><span class=line><span class=cl> neighbor 18.1.1.1 remote-as 100
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>!--- R1 commands.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router ospf 1 vrf a
</span></span><span class=line><span class=cl> router-id 1.1.1.17
</span></span><span class=line><span class=cl> network 17.1.1.1 0.0.0.0 area 0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 100
</span></span><span class=line><span class=cl> address-family ipv4 vrf b
</span></span><span class=line><span class=cl>  neighbor 18.1.1.8 remote-as 300
</span></span></code></pre></div><p><strong>验证：</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>show ip os nei
</span></span><span class=line><span class=cl>show ip route ospf
</span></span><span class=line><span class=cl>show ip route vrf a
</span></span><span class=line><span class=cl>show ip route vrf b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sh ip b summary 
</span></span></code></pre></div></li><li><h4 id=配置-pe-上-双向重分布>配置 PE 上 双向重分布</h4><p>以 R1 为例，只需在 VRF a</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>!--- R1 commands.
</span></span><span class=line><span class=cl># 只需在 vrf a 和 BGP ipv4 vrf a 视图下配置重分布
</span></span><span class=line><span class=cl># R8 - R1 之间运行的是 BGP ，在 BGP ipv4 vrf b 视图下建立邻居即可
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router ospf 1 vrf a
</span></span><span class=line><span class=cl> redistribute bgp 100 subnets
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>router bgp 100
</span></span><span class=line><span class=cl> address-family ipv4 vrf a
</span></span><span class=line><span class=cl>  redistribute ospf 1
</span></span></code></pre></div></li><li><h4 id=优化isp-内部-ospf-下一跳>优化ISP 内部 OSPF 下一跳</h4><p>查看 R1 路由表发现，去往 9.9.9.9 下一跳是 6.6.6.6</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>R1</span><span class=c1>#sh ip b vpnv4 vrf a </span>
</span></span><span class=line><span class=cl><span class=n>BGP</span> <span class=n>table</span> <span class=n>version</span> <span class=n>is</span> <span class=mi>166</span><span class=p>,</span> <span class=n>local</span> <span class=n>router</span> <span class=n>ID</span> <span class=n>is</span> <span class=mf>1.1</span><span class=o>.</span><span class=mf>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Status</span> <span class=n>codes</span><span class=p>:</span> <span class=n>s</span> <span class=n>suppressed</span><span class=p>,</span> <span class=n>d</span> <span class=n>damped</span><span class=p>,</span> <span class=n>h</span> <span class=n>history</span><span class=p>,</span> <span class=o>*</span> <span class=n>valid</span><span class=p>,</span> <span class=o>&gt;</span> <span class=n>best</span><span class=p>,</span> <span class=n>i</span> <span class=o>-</span> <span class=n>internal</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>              <span class=n>r</span> <span class=n>RIB</span><span class=o>-</span><span class=n>failure</span><span class=p>,</span> <span class=n>S</span> <span class=n>Stale</span><span class=p>,</span> <span class=n>m</span> <span class=n>multipath</span><span class=p>,</span> <span class=n>b</span> <span class=n>backup</span><span class=o>-</span><span class=n>path</span><span class=p>,</span> <span class=n>f</span> <span class=n>RT</span><span class=o>-</span><span class=n>Filter</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>              <span class=n>x</span> <span class=n>best</span><span class=o>-</span><span class=n>external</span><span class=p>,</span> <span class=n>a</span> <span class=n>additional</span><span class=o>-</span><span class=n>path</span><span class=p>,</span> <span class=n>c</span> <span class=n>RIB</span><span class=o>-</span><span class=n>compressed</span><span class=p>,</span> 
</span></span><span class=line><span class=cl><span class=n>Origin</span> <span class=n>codes</span><span class=p>:</span> <span class=n>i</span> <span class=o>-</span> <span class=n>IGP</span><span class=p>,</span> <span class=n>e</span> <span class=o>-</span> <span class=n>EGP</span><span class=p>,</span> <span class=err>?</span> <span class=o>-</span> <span class=n>incomplete</span>
</span></span><span class=line><span class=cl><span class=n>RPKI</span> <span class=n>validation</span> <span class=n>codes</span><span class=p>:</span> <span class=n>V</span> <span class=n>valid</span><span class=p>,</span> <span class=n>I</span> <span class=n>invalid</span><span class=p>,</span> <span class=n>N</span> <span class=n>Not</span> <span class=n>found</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=n>Network</span>          <span class=n>Next</span> <span class=n>Hop</span>            <span class=n>Metric</span> <span class=n>LocPrf</span> <span class=n>Weight</span> <span class=ne>Path</span>
</span></span><span class=line><span class=cl><span class=n>Route</span> <span class=n>Distinguisher</span><span class=p>:</span> <span class=mi>7</span><span class=p>:</span><span class=mi>100</span> <span class=p>(</span><span class=n>default</span> <span class=k>for</span> <span class=n>vrf</span> <span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=o>*&gt;</span>  <span class=mf>7.7</span><span class=o>.</span><span class=mf>7.7</span><span class=o>/</span><span class=mi>32</span>       <span class=mf>17.1</span><span class=o>.</span><span class=mf>1.7</span>                <span class=mi>11</span>         <span class=mi>32768</span> <span class=err>?</span>
</span></span><span class=line><span class=cl> <span class=o>*&gt;</span><span class=n>i</span> <span class=mf>9.9</span><span class=o>.</span><span class=mf>9.9</span><span class=o>/</span><span class=mi>32</span>       <span class=mf>6.6</span><span class=o>.</span><span class=mf>6.6</span>                  <span class=mi>0</span>    <span class=mi>100</span>      <span class=mi>0</span> <span class=mi>200</span> <span class=err>?</span>
</span></span><span class=line><span class=cl> <span class=o>*&gt;</span>  <span class=mf>17.1</span><span class=o>.</span><span class=mf>1.0</span><span class=o>/</span><span class=mi>24</span>      <span class=mf>0.0</span><span class=o>.</span><span class=mf>0.0</span>                  <span class=mi>0</span>         <span class=mi>32768</span> <span class=err>?</span>
</span></span><span class=line><span class=cl> <span class=o>*&gt;</span><span class=n>i</span> <span class=mf>69.1</span><span class=o>.</span><span class=mf>1.0</span><span class=o>/</span><span class=mi>24</span>      <span class=mf>6.6</span><span class=o>.</span><span class=mf>6.6</span>                  <span class=mi>0</span>    <span class=mi>100</span>      <span class=mi>0</span> <span class=mi>200</span> <span class=err>?</span>
</span></span><span class=line><span class=cl><span class=n>R1</span><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=n>R1</span><span class=c1>#sh ip route vrf a  | b Gate</span>
</span></span><span class=line><span class=cl><span class=n>Gateway</span> <span class=n>of</span> <span class=n>last</span> <span class=n>resort</span> <span class=n>is</span> <span class=ow>not</span> <span class=n>set</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=mf>7.0</span><span class=o>.</span><span class=mf>0.0</span><span class=o>/</span><span class=mi>32</span> <span class=n>is</span> <span class=n>subnetted</span><span class=p>,</span> <span class=mi>1</span> <span class=n>subnets</span>
</span></span><span class=line><span class=cl><span class=n>O</span>        <span class=mf>7.7</span><span class=o>.</span><span class=mf>7.7</span> <span class=p>[</span><span class=mi>110</span><span class=o>/</span><span class=mi>11</span><span class=p>]</span> <span class=n>via</span> <span class=mf>17.1</span><span class=o>.</span><span class=mf>1.7</span><span class=p>,</span> <span class=mi>04</span><span class=p>:</span><span class=mi>21</span><span class=p>:</span><span class=mi>39</span><span class=p>,</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>      <span class=mf>9.0</span><span class=o>.</span><span class=mf>0.0</span><span class=o>/</span><span class=mi>32</span> <span class=n>is</span> <span class=n>subnetted</span><span class=p>,</span> <span class=mi>1</span> <span class=n>subnets</span>
</span></span><span class=line><span class=cl><span class=n>B</span>        <span class=mf>9.9</span><span class=o>.</span><span class=mf>9.9</span> <span class=p>[</span><span class=mi>200</span><span class=o>/</span><span class=mi>0</span><span class=p>]</span> <span class=n>via</span> <span class=mf>6.6</span><span class=o>.</span><span class=mf>6.6</span><span class=p>,</span> <span class=mi>03</span><span class=p>:</span><span class=mi>10</span><span class=p>:</span><span class=mi>42</span>
</span></span><span class=line><span class=cl>      <span class=mf>17.0</span><span class=o>.</span><span class=mf>0.0</span><span class=o>/</span><span class=mi>8</span> <span class=n>is</span> <span class=n>variably</span> <span class=n>subnetted</span><span class=p>,</span> <span class=mi>2</span> <span class=n>subnets</span><span class=p>,</span> <span class=mi>2</span> <span class=n>masks</span>
</span></span><span class=line><span class=cl><span class=n>C</span>        <span class=mf>17.1</span><span class=o>.</span><span class=mf>1.0</span><span class=o>/</span><span class=mi>24</span> <span class=n>is</span> <span class=n>directly</span> <span class=n>connected</span><span class=p>,</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>L</span>        <span class=mf>17.1</span><span class=o>.</span><span class=mf>1.1</span><span class=o>/</span><span class=mi>32</span> <span class=n>is</span> <span class=n>directly</span> <span class=n>connected</span><span class=p>,</span> <span class=n>Ethernet0</span><span class=o>/</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>      <span class=mf>69.0</span><span class=o>.</span><span class=mf>0.0</span><span class=o>/</span><span class=mi>24</span> <span class=n>is</span> <span class=n>subnetted</span><span class=p>,</span> <span class=mi>1</span> <span class=n>subnets</span>
</span></span><span class=line><span class=cl><span class=n>B</span>        <span class=mf>69.1</span><span class=o>.</span><span class=mf>1.0</span> <span class=p>[</span><span class=mi>200</span><span class=o>/</span><span class=mi>0</span><span class=p>]</span> <span class=n>via</span> <span class=mf>6.6</span><span class=o>.</span><span class=mf>6.6</span><span class=p>,</span> <span class=mi>03</span><span class=p>:</span><span class=mi>10</span><span class=p>:</span><span class=mi>42</span>
</span></span><span class=line><span class=cl><span class=n>R1</span><span class=c1>#</span>
</span></span></code></pre></div><p>再查找，去往 6.6.6.6 前缀有两条路径，管理和开销都一致，负载均衡？</p><p>这条路由是 R3 BGP 重分布进底层 IGP OSPF 而学习到的，有两条路径，管理距离110，metric 1 ，这时候需要比较forwarding metric，很不巧的是forwarding metric 也是一样，这样去往 6.6.6.6 就真负载均衡。forwarding metric 是本地到 ASBR 的 开销，修改 R11 e0/1-3 的开销。同理也需要修改 R12 的接口开销。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>O E2     12.12.12.12/32 [110/1] via 111.1.1.11, 01:37:27, Ethernet0/3
</span></span><span class=line><span class=cl>                        [110/1] via 12.1.1.2, 03:15:27, Ethernet0/0
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R1#sh ip route | b Gate
</span></span><span class=line><span class=cl>Gateway of last resort is not set
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      1.0.0.0/32 is subnetted, 1 subnets
</span></span><span class=line><span class=cl>C        1.1.1.1 is directly connected, Loopback0
</span></span><span class=line><span class=cl>      2.0.0.0/32 is subnetted, 1 subnets
</span></span><span class=line><span class=cl>O        2.2.2.2 [110/11] via 12.1.1.2, 04:26:59, Ethernet0/0
</span></span><span class=line><span class=cl>      3.0.0.0/32 is subnetted, 1 subnets
</span></span><span class=line><span class=cl>O        3.3.3.3 [110/21] via 111.1.1.11, 01:37:27, Ethernet0/3
</span></span><span class=line><span class=cl>                 [110/21] via 12.1.1.2, 04:26:49, Ethernet0/0
</span></span><span class=line><span class=cl>      6.0.0.0/32 is subnetted, 1 subnets
</span></span><span class=line><span class=cl>O E2     6.6.6.6 [110/1] via 111.1.1.11, 01:37:27, Ethernet0/3
</span></span><span class=line><span class=cl>                 [110/1] via 12.1.1.2, 03:15:27, Ethernet0/0
</span></span><span class=line><span class=cl>……
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R1#
</span></span><span class=line><span class=cl>R1#sh ip route 6.6.6.6
</span></span><span class=line><span class=cl>Routing entry for 6.6.6.6/32
</span></span><span class=line><span class=cl>  Known via &#34;ospf 100&#34;, distance 110, metric 1
</span></span><span class=line><span class=cl>  Tag 200, type extern 2, forward metric 20
</span></span><span class=line><span class=cl>  Last update from 12.1.1.2 on Ethernet0/0, 00:00:51 ago
</span></span><span class=line><span class=cl>  Routing Descriptor Blocks:
</span></span><span class=line><span class=cl>  * 111.1.1.11, from 3.3.3.3, 00:31:15 ago, via Ethernet0/3
</span></span><span class=line><span class=cl>      Route metric is 1, traffic share count is 1
</span></span><span class=line><span class=cl>      Route tag 200
</span></span><span class=line><span class=cl>    12.1.1.2, from 3.3.3.3, 00:00:51 ago, via Ethernet0/0
</span></span><span class=line><span class=cl>      Route metric is 1, traffic share count is 1
</span></span><span class=line><span class=cl>      Route tag 200
</span></span><span class=line><span class=cl>R1#
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 修改 R11 R12 的接口开销
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R11(config)#int ran e 0/1-/3  
</span></span><span class=line><span class=cl>R11(config-if-range)#ip ospf cost 1000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>R12(config-if)#int ran e 0/1-0/3
</span></span><span class=line><span class=cl>R12(config-if-range)#ip ospf cost 1000
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 修改 R11 R12 的接口开销后
</span></span><span class=line><span class=cl>R1#sh ip route 6.6.6.6
</span></span><span class=line><span class=cl>Routing entry for 6.6.6.6/32
</span></span><span class=line><span class=cl>  Known via &#34;ospf 100&#34;, distance 110, metric 1
</span></span><span class=line><span class=cl>  Tag 200, type extern 2, forward metric 20
</span></span><span class=line><span class=cl>  Last update from 12.1.1.2 on Ethernet0/0, 00:08:51 ago
</span></span><span class=line><span class=cl>  Routing Descriptor Blocks:
</span></span><span class=line><span class=cl>  * 12.1.1.2, from 3.3.3.3, 00:08:51 ago, via Ethernet0/0
</span></span><span class=line><span class=cl>      Route metric is 1, traffic share count is 1
</span></span><span class=line><span class=cl>      Route tag 200
</span></span><span class=line><span class=cl>R1#
</span></span><span class=line><span class=cl>R6#sh ip rou 1.1.1.1 
</span></span><span class=line><span class=cl>Routing entry for 1.1.1.1/32
</span></span><span class=line><span class=cl>  Known via &#34;ospf 200&#34;, distance 110, metric 1
</span></span><span class=line><span class=cl>  Tag 100, type extern 2, forward metric 20
</span></span><span class=line><span class=cl>  Last update from 56.1.1.5 on Ethernet0/0, 00:02:30 ago
</span></span><span class=line><span class=cl>  Routing Descriptor Blocks:
</span></span><span class=line><span class=cl>  * 56.1.1.5, from 4.4.4.4, 00:39:02 ago, via Ethernet0/0
</span></span><span class=line><span class=cl>      Route metric is 1, traffic share count is 1
</span></span><span class=line><span class=cl>      Route tag 100
</span></span><span class=line><span class=cl>R6#
</span></span></code></pre></div></li></ol><h3 id=测试>测试</h3><p><strong>R7 和 R9 之间的 ping 操作</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R7#ping 9.9.9.9 source 7.7.7.7
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Sending 5, 100-byte ICMP Echos to 9.9.9.9, timeout is 2 seconds:
</span></span><span class=line><span class=cl>Packet sent with a source address of 7.7.7.7 
</span></span><span class=line><span class=cl>!!!!!
</span></span><span class=line><span class=cl>Success rate is 100 percent (5/5), round-trip min/avg/max = 8/8/11 ms
</span></span><span class=line><span class=cl>R7#
</span></span><span class=line><span class=cl>R9#ping 7.7.7.7 source 9.9.9.9
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Sending 5, 100-byte ICMP Echos to 7.7.7.7, timeout is 2 seconds:
</span></span><span class=line><span class=cl>Packet sent with a source address of 9.9.9.9 
</span></span><span class=line><span class=cl>!!!!!
</span></span><span class=line><span class=cl>Success rate is 100 percent (5/5), round-trip min/avg/max = 8/8/10 ms
</span></span><span class=line><span class=cl>R9#
</span></span></code></pre></div><p><strong>R8 和 R10 之间的 ping 操作</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R8#ping 10.10.10.10 source 8.8.8.8
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Sending 5, 100-byte ICMP Echos to 10.10.10.10, timeout is 2 seconds:
</span></span><span class=line><span class=cl>Packet sent with a source address of 8.8.8.8 
</span></span><span class=line><span class=cl>!!!!!
</span></span><span class=line><span class=cl>Success rate is 100 percent (5/5), round-trip min/avg/max = 8/9/13 ms
</span></span><span class=line><span class=cl>R8#
</span></span><span class=line><span class=cl>R10#ping 8.8.8.8 source 10.10.10.10
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is 2 seconds:
</span></span><span class=line><span class=cl>Packet sent with a source address of 10.10.10.10 
</span></span><span class=line><span class=cl>!!!!!
</span></span><span class=line><span class=cl>Success rate is 100 percent (5/5), round-trip min/avg/max = 8/9/10 ms
</span></span><span class=line><span class=cl>R10#
</span></span></code></pre></div><p><strong>R7 和 R9 之间的 Traceroute 操作</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R7#traceroute 9.9.9.9 source 7.7.7.7
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Tracing the route to 9.9.9.9
</span></span><span class=line><span class=cl>VRF info: (vrf in name/id, vrf out name/id)
</span></span><span class=line><span class=cl>  1 17.1.1.1 1 msec 1 msec 2 msec
</span></span><span class=line><span class=cl>  2 12.1.1.2 [MPLS: Labels 24/26 Exp 0] 8 msec 8 msec 8 msec
</span></span><span class=line><span class=cl>  3 23.1.1.3 [MPLS: Labels 26/26 Exp 0] 8 msec 12 msec 7 msec
</span></span><span class=line><span class=cl>  4 34.1.1.4 [MPLS: Labels 27/26 Exp 0] 8 msec 9 msec 8 msec
</span></span><span class=line><span class=cl>  5 45.1.1.5 [MPLS: Labels 22/26 Exp 0] 9 msec 8 msec 8 msec
</span></span><span class=line><span class=cl>  6 69.1.1.6 [MPLS: Label 26 Exp 0] 9 msec 7 msec 9 msec
</span></span><span class=line><span class=cl>  7 69.1.1.9 9 msec *  9 msec
</span></span><span class=line><span class=cl>R7#
</span></span><span class=line><span class=cl>R9#traceroute 7.7.7.7 source 9.9.9.9
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Tracing the route to 7.7.7.7
</span></span><span class=line><span class=cl>VRF info: (vrf in name/id, vrf out name/id)
</span></span><span class=line><span class=cl>  1 69.1.1.6 2 msec 39 msec 2 msec
</span></span><span class=line><span class=cl>  2 56.1.1.5 [MPLS: Labels 25/26 Exp 0] 10 msec 9 msec 9 msec
</span></span><span class=line><span class=cl>  3 45.1.1.4 [MPLS: Labels 23/26 Exp 0] 12 msec 9 msec 9 msec
</span></span><span class=line><span class=cl>  4 34.1.1.3 [MPLS: Labels 21/26 Exp 0] 10 msec 8 msec 10 msec
</span></span><span class=line><span class=cl>  5 23.1.1.2 [MPLS: Labels 19/26 Exp 0] 9 msec 10 msec 11 msec
</span></span><span class=line><span class=cl>  6 17.1.1.1 [MPLS: Label 26 Exp 0] 7 msec 18 msec 9 msec
</span></span><span class=line><span class=cl>  7 17.1.1.7 8 msec *  8 msec
</span></span><span class=line><span class=cl>R9#
</span></span></code></pre></div><p><strong>R8 和 R10 之间的 Traceroute 操作</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>R8#traceroute 10.10.10.10 source 8.8.8.8
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Tracing the route to 10.10.10.10
</span></span><span class=line><span class=cl>VRF info: (vrf in name/id, vrf out name/id)
</span></span><span class=line><span class=cl>  1 18.1.1.1 2 msec 1 msec 1 msec
</span></span><span class=line><span class=cl>  2 12.1.1.2 [MPLS: Labels 24/28 Exp 0] 8 msec 9 msec 9 msec
</span></span><span class=line><span class=cl>  3 23.1.1.3 [MPLS: Labels 26/28 Exp 0] 9 msec 9 msec 9 msec
</span></span><span class=line><span class=cl>  4 34.1.1.4 [MPLS: Labels 27/28 Exp 0] 10 msec 8 msec 10 msec
</span></span><span class=line><span class=cl>  5 45.1.1.5 [MPLS: Labels 22/28 Exp 0] 7 msec 9 msec 8 msec
</span></span><span class=line><span class=cl>  6 106.1.1.6 [MPLS: Label 28 Exp 0] 8 msec 7 msec 9 msec
</span></span><span class=line><span class=cl>  7 106.1.1.10 8 msec *  10 msec
</span></span><span class=line><span class=cl>R8#
</span></span><span class=line><span class=cl>R10#traceroute 8.8.8.8 source 10.10.10.10
</span></span><span class=line><span class=cl>Type escape sequence to abort.
</span></span><span class=line><span class=cl>Tracing the route to 8.8.8.8
</span></span><span class=line><span class=cl>VRF info: (vrf in name/id, vrf out name/id)
</span></span><span class=line><span class=cl>  1 106.1.1.6 1 msec 2 msec 1 msec
</span></span><span class=line><span class=cl>  2 56.1.1.5 [MPLS: Labels 25/28 Exp 0] 8 msec 8 msec 11 msec
</span></span><span class=line><span class=cl>  3 45.1.1.4 [MPLS: Labels 23/28 Exp 0] 8 msec 28 msec 8 msec
</span></span><span class=line><span class=cl>  4 34.1.1.3 [MPLS: Labels 21/28 Exp 0] 8 msec 11 msec 8 msec
</span></span><span class=line><span class=cl>  5 23.1.1.2 [MPLS: Labels 19/28 Exp 0] 9 msec 8 msec 10 msec
</span></span><span class=line><span class=cl>  6 18.1.1.1 [MPLS: Label 28 Exp 0] 16 msec 6 msec 7 msec
</span></span><span class=line><span class=cl>  7 18.1.1.8 9 msec *  10 msec
</span></span><span class=line><span class=cl>R10#
</span></span></code></pre></div><h2 id=一个视频>一个视频</h2><div class=video-wrapper><iframe src="https://player.bilibili.com/player.html?as_wide=1&amp;high_quality=1&amp;page=1&bvid=BV1Lv4y1a7tG" scrolling=no frameborder=no framespacing=0 allowfullscreen></iframe></div><h2 id=最后>最后</h2><ul><li>文中可能有些配置未提及或内容术语表述的不规范，请见谅。</li><li>配置存阿里云盘了，这是链接：[<a class=link href=https://www.aliyundrive.com/s/HueqNEaKSAx target=_blank rel=noopener>分享的文件
<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span>
</a>]</li><li>欢迎“<del>来电</del>”来函探讨。</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/network-emulator/>Network Emulator</a>
<a href=/tags/pnetlab/>PNETLab</a>
<a href=/tags/cisco/>Cisco</a>
<a href=/tags/mpls-vpn/>MPLS VPN</a>
<a href=/tags/option-c/>Option C</a>
<a href=/tags/%E8%B7%A8%E5%9F%9F/>跨域</a>
<a href=/tags/nter-as/>Nter-AS</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/638be305/><div class=article-details><h2 class=article-title>多子网分支的第3阶段分层DMVPN实验</h2></div></a></article><article><a href=/posts/5c8077d9/><div class=article-details><h2 class=article-title>观察OSPF虚链路和虚链路的替代办法</h2></div></a></article><article><a href=/posts/2e964a67/><div class=article-details><h2 class=article-title>IPv6 各隧道Tunnel使用Lab</h2></div></a></article><article><a href=/posts/48f55792/><div class=article-details><h2 class=article-title>BGP综合实验拓扑</h2></div></a></article><article><a href=/posts/1b6d0fec/><div class=article-details><h2 class=article-title>几种重分发方式可能带来的问题和处理</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 <a href=https://github.com/kiraster target=_blank rel=noopener>@kiraster</a></section><section class=powerby><a href=https://github.com/kiraster target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a> <a href=https://space.bilibili.com/11565094 target=_blank title=Bilibili rel=me><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2"><path d="M3 10a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4v-6z"/><path d="M8 3l2 3"/><path d="M16 3l-2 3"/><path d="M9 13v-2"/><path d="M15 11v2"/></svg></a> <a href=mailto:kir_aster@foxmail.com target=_blank title=Email rel=me><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2"><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a><br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script src=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js integrity=sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css integrity=sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE crossorigin=anonymous><script>NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script><script>document.addEventListener("DOMContentLoaded",function(){jQuery(function(e){e("[data-fancybox]").fancybox()})})</script></body></html>