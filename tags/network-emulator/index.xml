<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Network Emulator on Kir's Blog</title><link>https://kiraster.github.io/tags/network-emulator/</link><description>Recent content in Network Emulator on Kir's Blog</description><generator>Hugo -- gohugo.io</generator><language>en</language><copyright>@kiraster</copyright><lastBuildDate>Fri, 17 May 2024 16:13:59 +0000</lastBuildDate><atom:link href="https://kiraster.github.io/tags/network-emulator/index.xml" rel="self" type="application/rss+xml"/><item><title>多子网分支的第3阶段分层DMVPN实验</title><link>https://kiraster.github.io/posts/638be305.html/</link><pubDate>Fri, 17 May 2024 16:13:59 +0000</pubDate><guid>https://kiraster.github.io/posts/638be305.html/</guid><description>&lt;p>以前了解过DMVPN组网，没发现还有这么个分层组网的模型，于是玩一玩做个记录&lt;/p>
&lt;p>Cisco网站文档链接： &lt;a class="link" href="https://www.cisco.com/c/zh_cn/support/docs/security/dynamic-multipoint-vpn-dmvpn/211292-Configure-Phase-3-Hierarchical-DMVPN-wit.html" target="_blank" rel="noopener"
>https://www.cisco.com/c/zh_cn/support/docs/security/dynamic-multipoint-vpn-dmvpn/211292-Configure-Phase-3-Hierarchical-DMVPN-wit.html
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;p>华为的说法是Hub级联网络部署DSVPN&lt;/p>
&lt;p>华为网站文档链接： &lt;a class="link" href="https://support.huawei.com/enterprise/zh/doc/EDOC1100271739/baf3c434" target="_blank" rel="noopener"
>https://support.huawei.com/enterprise/zh/doc/EDOC1100271739/baf3c434
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;p>&lt;strong>一段蹩脚的Cisco网站机器翻译原文&lt;/strong>&lt;/p>
&lt;p>分层设置（大于一级）允许更复杂的基于树的DMVPN网络拓扑。基于树的拓扑允许使用区域集线器构建DMVPN网络，区域集线器是中心集线器的分支。此体系结构允许区域中心处理其区域分支的数据和下一跳解析协议(NHRP)控制流量。但是，它仍允许在DMVPN网络内的任何分支之间构建分支到分支隧道，无论它们是否位于同一区域。此架构还允许DMVPN网络布局更紧密地匹配区域或分层数据流模式。&lt;/p>
&lt;h2 id="dmvpn的组成">DMVPN的组成
&lt;/h2>&lt;ol>
&lt;li>多GRE隧道&lt;/li>
&lt;li>NHRP&lt;/li>
&lt;li>动态路由协议&lt;/li>
&lt;li>IPSec加密&lt;/li>
&lt;/ol>
&lt;p>配置思路也是分这四个步骤，本人觉得DMVPN的精髓在于NHRP协议，这个协议可以使Spoke站点之间动态建立隧道，新增Spoke站点无须改动Hub端配置，看上去很智能哦&lt;/p>
&lt;h2 id="实验逻辑拓扑">实验逻辑拓扑
&lt;/h2>&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2024/05/17/R8tbOLimrvfyBKJ.png">
&lt;img src="https://s2.loli.net/2024/05/17/R8tbOLimrvfyBKJ.png"
loading="lazy"
alt="image-20240516152212789"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="实验物理拓扑">实验物理拓扑
&lt;/h2>&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2024/05/17/J4mckBb8fnpIDFe.png">
&lt;img src="https://s2.loli.net/2024/05/17/J4mckBb8fnpIDFe.png"
loading="lazy"
alt="image-20240516025005087"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>&lt;strong>最终的效果&lt;/strong>（例如：R4的192.168.4.0/24网段去往R6的192.168.6.0/24网段一跳可达）&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2024/05/17/ZE1AL9r4OXimSuh.png">
&lt;img src="https://s2.loli.net/2024/05/17/ZE1AL9r4OXimSuh.png"
loading="lazy"
alt="image-20240516233604433"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="配置过程">配置过程
&lt;/h2>&lt;h3 id="基础配置">基础配置
&lt;/h3>&lt;p>包括IP地址，去往ISP的默认路由等&lt;/p>
&lt;p>基础配置完成后各Hub路由器和Spoke路由器可以ping通各个公网IP地址&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R1#ping 100.28.28.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 100.28.28.2, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">..!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 60 percent (3/5), round-trip min/avg/max = 4/5/7 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#ping 200.28.28.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 200.28.28.2, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 2/2/3 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#ping 100.38.38.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 100.38.38.3, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 2/2/4 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#ping 200.38.38.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 200.38.38.3, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 2/2/4 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#ping 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 100.48.48.4, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 2/3/5 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#ping 100.58.58.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 100.58.58.5, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 2/3/4 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#ping 100.68.68.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 100.68.68.6, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 2/2/4 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#ping 100.78.78.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 100.78.78.7, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 2/3/4 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#ping 8.8.8.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/2 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="多gre隧道">多GRE隧道
&lt;/h3>&lt;p>Central Hub 与 Hub1，Hub2 配置tunnel&lt;/p>
&lt;p>mGRE与单GRE的配置区别在于隧道模式 multipoint 和填写远端destination地址&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">！配置R1,R2,R3的tunnel，注意修改tunnel的IP地址，R2，R3 如法炮制
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">！R1 Tunnel0 （R1)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.0.0.1 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode gre multipoint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel key 12345
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Hub1，Hub2 ，Spoke配置tunnel&lt;/p>
&lt;p>在Hub1，Hub2上配置tunnel 1（与Spoke建立隧道使用）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">！ Hub1 Tunnel1 （R2)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.0.1.2 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip redirects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode gre multipoint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel key 12345
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">！ Hub2 Tunnel1 （R3)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.0.2.3 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip redirects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode gre multipoint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel key 12345
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">！ Spoke1 （R4)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.0.1.4 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip redirects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode gre multipoint
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel key 12345
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ！ 其他Spoke站点如法炮制
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="nhrp">NHRP
&lt;/h3>&lt;p>Central Hub的配置（R1)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">！Central Hub （R1)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp authentication cisco # 配置nhrp认证(可选)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp map multicast dynamic # 动态接受组播映射，(Version 15.7(3)M2 版本默认开启)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp network-id 123 # network-id，很重要，当前这个拓扑需要同一配置，原因是影响nhrp解析请求的发送
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp redirect # nhrp的重定向，Hub向spoke发送重定向消息
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Hub1和Hub2的配置（以Hub1为例（R2)）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">！ Hub 1 （R2)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp authentication cisco
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp map 10.0.0.1 100.18.18.1 # 隧道地址对应的公网地址映射
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp map multicast 100.18.18.1 # 组播对应的公网地址映射
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp network-id 123 # network-id，很重要，当前这个拓扑需要同一配置，原因是影响nhrp解析请求的发送
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp nhs 10.0.0.1 # 配置nhs，spoke向nhs注册
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp shorcut # Hub1和Hub2是Central Hub的Spoke (Version 15.7(3)M2 版本默认开启)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp redirect # 当前这个拓扑，需要配置这一项，因为在配置动态路由协议后，R3去往R4和R5业务网段的下一跳是R2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp authentication cisco
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp network-id 123
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp redirect
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Spoke1,2,3,4的配置（以Spoke1和Spoke3为例）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">！Spoke 1 （R4)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp authentication cisco
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp map 10.0.1.2 200.28.28.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp map multicast 200.28.28.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp network-id 123
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp nhs 10.0.1.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">！Spoke 3 （R6)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp authentication cisco
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp network-id 123
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip nhrp nhs 10.0.2.3 nbma 200.38.38.3 multicast # 一次性配置nhs,映射地址
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在配置完成mGRE和NHRP之后，产生流量之后（ping测试）应该可以观察到以下现象&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Hub1(R2)到Hub2(R3)的tunnel地址形成动态映射和动态隧道，跟踪路径查看到一跳可达&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2024/05/17/fvQMnquVr98ytge.png">
&lt;img src="https://s2.loli.net/2024/05/17/fvQMnquVr98ytge.png"
loading="lazy"
alt="image-20240516170204803"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Spoke1(R4)到Spoke2(R5)的tunnel地址形成动态映射和动态隧道，跟踪路径查看到一跳可达&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2024/05/17/OEwfcxm1dbiLQrn.png">
&lt;img src="https://s2.loli.net/2024/05/17/OEwfcxm1dbiLQrn.png"
loading="lazy"
alt="image-20240516170409590"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Spoke3(R6)到Spoke4(R7)的tunnel地址形成动态映射和动态隧道，跟踪路径查看到一跳可达&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2024/05/17/2fE4NeGJSnqyHul.png">
&lt;img src="https://s2.loli.net/2024/05/17/2fE4NeGJSnqyHul.png"
loading="lazy"
alt="image-20240516170521889"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="动态路由协议">动态路由协议
&lt;/h3>&lt;p>可选的协议RIP、EIGRP、OSPF、BGP、ODR&lt;/p>
&lt;p>本实验业务网络选用OSPF，Central Hub，Hub1和Hub2设计在Area0；Hub1和Spoke1，Spoke2设计在Area1；Hub2和Spoke3，Spoke4设计在Area2；&lt;/p>
&lt;p>根据组网情况分析，OSPF的网络类型可选的有广播、点到多点；&lt;/p>
&lt;p>本实验选用广播，因为在配置tunnel 的ospf网络类型为广播后，同一个hub下的spoke站点能学习到优化下一跳后的路由，注意修改Spoke的ospf优先级为0不参与DR选举；&lt;/p>
&lt;p>（配置tunnel 的ospf网络类型为点到多点后，spoke站点在产生分支站点流量后会对路由进行override， % - next hop override ，O之后有%符号）&lt;/p>
&lt;p>Central Hub，Hub1和Hub2的OSPF配置&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">！Central Hub （R1)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 110
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 1.1.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.0.0.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 172.16.1.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network broadcast # 修改tunnel0接口ospf网络类型为广播
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point # 修改环回接口网络类型为点到点
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">！ Hub 1 （R2)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 110
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 2.2.2.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.0.0.2 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 172.16.2.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network broadcast # 修改tunnel0接口ospf网络类型为广播
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf priority 0 # 修改ospf 优先级为0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point # 修改环回接口网络类型为点到点
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">！Hub 2 （R3)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 110
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 3.3.3.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.0.0.3 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 172.16.3.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network broadcast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf priority 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Hub1和Spoke1，Spoke2的配置；Hub2和Spoke3，Spoke4的配置如法炮制即可&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">！ Hub 1 （R2)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 110
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.0.1.2 0.0.0.0 area 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network broadcast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">！Spoke 1 （R4)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 4.4.4.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.0.1.4 0.0.0.0 area 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.4.1 0.0.0.0 area 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network broadcast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf priority 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">！Spoke 2 （R5)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 110
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 5.5.5.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.0.1.5 0.0.0.0 area 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.5.1 0.0.0.0 area 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network broadcast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf priority 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置完成以上内容后，可以观察到的现象（例如：R5的192.168.5.0/24网段去往R7的192.168.7.0/24网段一跳可达）&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2024/05/17/v28wm1Rp6qoQSzj.png">
&lt;img src="https://s2.loli.net/2024/05/17/v28wm1Rp6qoQSzj.png"
loading="lazy"
alt="image-20240516233848193"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h3 id="ipsec加密">IPSec加密
&lt;/h3>&lt;p>配置ISAKMP第一阶段策略&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">crypto isakmp policy 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encr 3des
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hash md5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authentication pre-share
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> group 2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置ISAKMP预共享密码&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">crypto isakmp key Cisco@123 address 0.0.0.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置IPSec策略（转换集）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">crypto ipsec transform-set DMVPN esp-3des esp-md5-hmac
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode transport
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置IPSec profile&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">crypto ipsec profile DMVPN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set transform-set DMVPN
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>调用IPSec profile&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel protection ipsec profile DMVPN
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>以上命令配置完成后，使用命令sh run | s crypto 查看配置，复制粘贴到其他设备上，然后在在tunnel接口调用&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R1#sh run | s crypto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto isakmp policy 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encr 3des
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hash md5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authentication pre-share
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> group 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto isakmp key Cisco@123 address 0.0.0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto ipsec transform-set DMVPN esp-3des esp-md5-hmac
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode transport
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto ipsec profile DMVPN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set transform-set DMVPN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Hub1和Hub2接口调用时后边添加share可能遇到只有一个隧道起来的情况（不懂是模拟器bug还是怎么滴），按照思科官网配置两个不同名称的ipsec profile再次进行调用，可以解决&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R2#sh run | s crypto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto isakmp policy 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encr 3des
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hash md5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authentication pre-share
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> group 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto isakmp key Cisco@123 address 0.0.0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto ipsec transform-set DMVPN esp-3des esp-md5-hmac
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mode transport
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto ipsec profile DMVPN-0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set transform-set DMVPN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto ipsec profile DMVPN-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set transform-set DMVPN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>验证加密&lt;/strong>&lt;/p>
&lt;p>在R4上清空会话&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R4#clea crypto session
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R4#sh crypto engine connections active
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Crypto Engine Connections
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ID Type Algorithm Encrypt Decrypt LastSeqN IP-Address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 45 IPsec 3DES+MD5 0 2 2 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 46 IPsec 3DES+MD5 2 0 0 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1016 IKE MD5+3DES 0 0 0 100.48.48.4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>使用ping命令产生数据&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R4#ping 192.168.7.1 source 192.168.4.1 repeat 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 100, 100-byte ICMP Echos to 192.168.7.1, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Packet sent with a source address of 192.168.4.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (100/100), round-trip min/avg/max = 4/10/27 ms
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看加解密数据包计数&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R4#sh crypto engine connections active
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Crypto Engine Connections
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ID Type Algorithm Encrypt Decrypt LastSeqN IP-Address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 45 IPsec 3DES+MD5 0 13 13 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 46 IPsec 3DES+MD5 13 0 0 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 47 IPsec 3DES+MD5 0 0 0 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 48 IPsec 3DES+MD5 92 0 0 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 49 IPsec 3DES+MD5 0 93 93 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 50 IPsec 3DES+MD5 0 0 0 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1016 IKE MD5+3DES 0 0 0 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1017 IKE MD5+3DES 0 0 0 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1018 IKE MD5+3DES 0 0 0 100.48.48.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R4#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>结果显示，加密或解密的数量分别超过100&lt;/p>
&lt;h2 id="nhrp工作流程">NHRP工作流程
&lt;/h2>&lt;p>详细的可以去思科网站看看，这里贴个图&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2024/05/17/QJ2OBd39G4HR6cL.gif">
&lt;img src="https://s2.loli.net/2024/05/17/QJ2OBd39G4HR6cL.gif"
loading="lazy"
alt="img"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>大致单向流程（以Spoke1（192.168.4.1）到Spoke4（192.168.7.1）为例）：&lt;/p>
&lt;ol>
&lt;li>当Spoke1首次与Spoke4进行通信（第一个数据包流，比如ping）或动态隧道已过期，icmp request 到达Hub1，查询nhrp缓存，发现没有192.168.7.1的缓存记录，icmp request 根据路由表和nhrp迭代转发到Hub1&lt;/li>
&lt;li>Hub1收到icmp request ，由于Hub1不是192.168.7.1的终点，于是向Spoke1发送nhrp 重定向（指示Spoke1发nhrp request），同时icmp request 根据路由表和nhrp迭代转发到Central Hub&lt;/li>
&lt;li>Central Hub收到icmp request，由于Central Hub不是192.168.7.1的终点，于是向Spoke1发送nhrp 重定向（往tunnel0发送，Hub1收到后再转发到tunnel1上，指示Spoke1发nhrp request，），同时icmp request 根据路由表和nhrp迭代转发到Hub2&lt;/li>
&lt;li>Hub2收到icmp request，由于Hub2不是192.168.7.1的终点，于是向Spoke1发送nhrp 重定向（往tunnel0发送，再转发到tunnel1，指示Spoke1发nhrp request），同时icmp request 根据路由表和nhrp迭代转发到Spoke4&lt;/li>
&lt;li>Spoke4收到icmp request，由于Spoke4是192.168.7.1的终点，在收到Spoke1的nhrp request于是向Spoke1发送Resolution Reply（沿着来的的路径逐条转发回去） ，icmp request 到达目的地&lt;/li>
&lt;/ol>
&lt;p>返回流程也是经过一轮重定向的操作，因为当icmp request 到达目的地后，Spoke4的nhrp缓存也没有192.168.4.1的条目或者说没有形成动态的tunnel&lt;/p>
&lt;p>通过debug nhrp packet观察，nhrp的重定向、 request 消息在几十毫秒内全部完成&lt;/p>
&lt;p>R2和R3之间也会发送重定向和request，因为运行了ospf协议，R2和R3之间有Spoke的路由（例如R2去往R6，R7的下一跳是R3的tunnel接口地址）&lt;/p>
&lt;p>假设R2和R3直接已经形成动态隧道（R2ping通R3的tunnel0接口）那么Spoke1（192.168.4.1）到Spoke4（192.168.7.1）的首次通信跟踪路径如下&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R4#tra 192.168.6.1 sou 192.168.4.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Tracing the route to 192.168.6.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VRF info: (vrf in name/id, vrf out name/id)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 10.0.1.2 9 msec 8 msec 8 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2 10.0.0.3 11 msec 11 msec 15 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3 10.0.2.6 19 msec * 14 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R4#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">在路由器上使用命令清空nhrp缓存，再次使用trace可以看到数据包经过了R1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#clea ip nhrp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#clea ip nhrp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R3#clea ip nhrp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R4#clea ip nhrp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R6#clea ip nhrp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R4#tra 192.168.6.1 sou 192.168.4.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Tracing the route to 192.168.6.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VRF info: (vrf in name/id, vrf out name/id)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 10.0.1.2 11 msec 11 msec 9 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2 10.0.0.1 11 msec 11 msec 17 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3 10.0.0.3 19 msec 13 msec 12 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4 10.0.2.6 18 msec * 14 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R4#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="spoke站点外网地址">Spoke站点外网地址
&lt;/h2>&lt;p>Spoke站点是静态或动态的公网IP不影响&lt;/p>
&lt;p>但是如果Spoke站点的出口地址是私网地址呢？不要惊奇，十几年前就发现有这种现象了，或者说Spoke站点上一级有NAT设备，这种情况下DMVPN仍然可用（前提是运营商没把UDP500给干掉）&lt;/p>
&lt;p>在上面的拓扑R7和R8之间添加R9，配置NAT，R7和R9之间配置10.79.79.0网段，完成配置后发现R7学习路由和连通性测试没有问题，R3上观察nhrp缓存如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R3#sh ip nhrp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.0.1/32 via 10.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tunnel0 created 00:12:47, never expire
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Type: static, Flags: used
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> NBMA address: 100.18.18.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.2.6/32 via 10.0.2.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tunnel1 created 00:12:35, expire 00:09:08
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Type: dynamic, Flags: registered used nhop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> NBMA address: 100.68.68.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.0.2.7/32 via 10.0.2.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tunnel1 created 00:00:25, expire 00:09:35
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Type: dynamic, Flags: registered used nhop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> NBMA address: 100.89.89.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> (Claimed NBMA address: 10.79.79.7)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">比正常的显示多了一行 (Claimed NBMA address: 10.79.79.7)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>R9上查看NAT转换，是不是很熟悉哈，在IPSec VPN穿越NAT的时候也出现过这种情况，所以我想说DMVPN是IPSec VPN 的PLUS+PRO+MAX升级版&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R9#sh ip nat translations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Pro Inside global Inside local Outside local Outside global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">udp 100.89.89.9:500 10.79.79.7:500 100.58.58.5:500 100.58.58.5:500
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">udp 100.89.89.9:500 10.79.79.7:500 200.38.38.3:500 200.38.38.3:500
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">udp 100.89.89.9:4500 10.79.79.7:4500 100.58.58.5:4500 100.58.58.5:4500
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">udp 100.89.89.9:4500 10.79.79.7:4500 200.38.38.3:4500 200.38.38.3:4500
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R9#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="经典结尾扯蛋">经典结尾扯蛋
&lt;/h2>&lt;ul>
&lt;li>整了这么个实验，精华部分也就是nhrp的重定向和Spoke站点之间的动态隧道&lt;/li>
&lt;li>在本人接触过的Hub和Spoke组网的项目中，也就接触过IPSec VPN，分支站点向中心传数据的情况，至于站点和站点互通的少见&lt;/li>
&lt;li>其实使用DMVPN组网也能完成分支站点仅向中心传数据；在实际的项目中怀疑是参杂了一些利益因素导致这种组网少见，可能是我见识短浅；因为这种技术也不会向友商设备提供对接，跟你对接了我岂不是少赚钱了&lt;/li>
&lt;li>而IPSec VPN则不同，它是一个安全框架，遵守框架开发理论上都能对接，本人提到的第二点的项目中对接的设备有深信服，华三，华为，迈普，绿盟，都组网正常运行了&lt;/li>
&lt;li>做完这个实验去瞄了一眼华为的DSVPN，配置项差不多，命令表现形式不一样&lt;/li>
&lt;li>配置存阿里云盘了，这是链接：[&lt;a class="link" href="https://www.alipan.com/s/Bpdw7YeYPZt" target="_blank" rel="noopener"
>分享的文件
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>]&lt;/li>
&lt;li>欢迎“&lt;del>来电&lt;/del>”来函探讨。&lt;/li>
&lt;/ul></description></item><item><title>观察OSPF虚链路和虚链路的替代办法</title><link>https://kiraster.github.io/posts/5c8077d9.html/</link><pubDate>Thu, 16 Mar 2023 22:45:33 +0000</pubDate><guid>https://kiraster.github.io/posts/5c8077d9.html/</guid><description>&lt;p>一个小实验，观察&lt;code>OSPF&lt;/code>虚链路、虚链路的替代办法。&lt;/p>
&lt;p>&lt;strong>拓扑图：&lt;/strong>&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2023/03/16/L1V6fSaPcXrFZgq.jpg">
&lt;img src="https://s2.loli.net/2023/03/16/L1V6fSaPcXrFZgq.jpg"
loading="lazy"
alt="ScreenCaputure230316225301"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>如上图所示，右边 AREA 2、3、4 普通区域被 AREA 1 分割。&lt;/p>
&lt;p>要求：不改动物理连线的方式配置设备，使得 R1 学习到 R6、R7、R8上的路由。&lt;/p>
&lt;p>方式一：R2 &amp;ndash; R3 间配置跨 AREA 1 的虚链路&lt;/p>
&lt;p>方式二：R2 &amp;ndash; R4 间配置 Tunnel 隧道，配置宣告&lt;/p>
&lt;p>方式三：R5 上 配置 AREA 4 在另一个 OSPF 进程，配置重分布&lt;/p>
&lt;hr>
&lt;h2 id="方式一">方式一
&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R2 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> area 1 virtual-link 3.3.3.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R3 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> area 1 virtual-link 2.2.2.2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="方式二">方式二
&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R2 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 100.1.1.1 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source 24.1.1.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel destination 24.1.1.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # 将Tunnel接口地址宣告进区域0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 100.1.1.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R4 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 100.1.1.2 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source 24.1.1.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel destination 24.1.1.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # 将Tunnel接口地址宣告进区域0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 100.1.1.2 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="方式三">方式三
&lt;/h2>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R5#sh run | s r o
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 5.5.5.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # 重分布
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute ospf 200 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 5.5.5.5 0.0.0.0 area 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 25.1.1.5 0.0.0.0 area 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 配置 AREA 4 在另一个 OSPF 进程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 55.55.55.55
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> # 重分布
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute ospf 100 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 58.1.1.5 0.0.0.0 area 4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R5#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="观察">观察
&lt;/h2>&lt;p>R1 上查看 OSPF 路由，发现能学习到 R6，R7，R8上的环回口路由；Tunnel接口的地址也被学习到，而且是 O 表项路由属于区域 0 ，R8 的路由因为在R5 上进行了双向重分布显示为 OE2 表项。 R6，R7 则是区域间路由，逻辑上的直连区域0。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1">#sh ip route ospf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Codes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">L&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">local&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">C&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">connected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">S&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="k">static&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">R&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">RIP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">M&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">mobile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">B&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">BGP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">D&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">EIGRP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">EX&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">EIGRP&lt;/span> &lt;span class="n">external&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">O&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">inter&lt;/span> &lt;span class="n">area&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">N1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">NSSA&lt;/span> &lt;span class="n">external&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">N2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">NSSA&lt;/span> &lt;span class="n">external&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">E1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">external&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">external&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">su&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span> &lt;span class="n">summary&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">L1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span> &lt;span class="n">level&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">L2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span> &lt;span class="n">level&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ia&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span> &lt;span class="n">inter&lt;/span> &lt;span class="n">area&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">candidate&lt;/span> &lt;span class="n">default&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">U&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">per&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">user&lt;/span> &lt;span class="k">static&lt;/span> &lt;span class="n">route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">o&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">ODR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">P&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">periodic&lt;/span> &lt;span class="n">downloaded&lt;/span> &lt;span class="k">static&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">H&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">NHRP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">l&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">LISP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">a&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">application&lt;/span> &lt;span class="n">route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">replicated&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">next&lt;/span> &lt;span class="n">hop&lt;/span> &lt;span class="n">override&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">overrides&lt;/span> &lt;span class="n">from&lt;/span> &lt;span class="n">PfR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Gateway&lt;/span> &lt;span class="n">of&lt;/span> &lt;span class="n">last&lt;/span> &lt;span class="n">resort&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">set&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">2.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="mf">2.2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">2.2&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">3.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">3.3&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">3.3&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">54&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">4.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">4.4&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">4.4&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">5.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">5.5&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">5.5&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">6.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">6.6&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">6.6&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">31&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">54&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">7.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">7.7&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">7.7&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1021&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">53&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">8.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">8.8&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">8.8&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">53&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">23.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">23.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">24.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">24.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">25.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">25.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">36.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">36.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">54&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">47.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="mf">47.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1020&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">58.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">54&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">100.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">30&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="mf">100.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1010&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1"># &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>R2上查看 OSPF 邻居，发现除常规的邻居外，还有Tunnel0 的邻居和虚链路的邻居，两种邻居的区别在于虚链路邻居一旦邻居建立处于稳定状态，不发送hello报文，而且&lt;code>Dead Time &lt;/code>永不超时。而Tunnel0 的邻居有Dead Time 默认40秒，debug 查看 hello 会发现&lt;code>*Mar 16 15:24:11.782: OSPF-100 HELLO Tu0: Rcv hello from 4.4.4.4 area 0 100.1.1.2&lt;/code>，好像没什么用，好看&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R2#sh ip os nei
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Neighbor ID Pri State Dead Time Address Interface
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4.4.4.4 0 FULL/ - 00:00:30 100.1.1.2 Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1.1.1.1 1 FULL/BDR 00:00:32 12.1.1.1 Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3.3.3.3 0 FULL/ - - 23.1.1.3 OSPF_VL0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5.5.5.5 1 FULL/DR 00:00:33 25.1.1.5 Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4.4.4.4 1 FULL/DR 00:00:34 24.1.1.4 Ethernet0/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3.3.3.3 1 FULL/DR 00:00:37 23.1.1.3 Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>R8上查看路由表，因为在R5上进行了重分布，R5是ASBR。所有看到的OSPF路由表项都是 OE&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">R8&lt;/span>&lt;span class="c1">#sh ip rou os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Codes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">L&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">local&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">C&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">connected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">S&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="k">static&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">R&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">RIP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">M&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">mobile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">B&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">BGP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">D&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">EIGRP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">EX&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">EIGRP&lt;/span> &lt;span class="n">external&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">O&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">IA&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">inter&lt;/span> &lt;span class="n">area&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">N1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">NSSA&lt;/span> &lt;span class="n">external&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">N2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">NSSA&lt;/span> &lt;span class="n">external&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">E1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">external&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">external&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">su&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span> &lt;span class="n">summary&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">L1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span> &lt;span class="n">level&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">L2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span> &lt;span class="n">level&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ia&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">IS&lt;/span> &lt;span class="n">inter&lt;/span> &lt;span class="n">area&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">candidate&lt;/span> &lt;span class="n">default&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">U&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">per&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">user&lt;/span> &lt;span class="k">static&lt;/span> &lt;span class="n">route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">o&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">ODR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">P&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">periodic&lt;/span> &lt;span class="n">downloaded&lt;/span> &lt;span class="k">static&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">H&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">NHRP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">l&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">LISP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">a&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">application&lt;/span> &lt;span class="n">route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">replicated&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">next&lt;/span> &lt;span class="n">hop&lt;/span> &lt;span class="n">override&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">overrides&lt;/span> &lt;span class="n">from&lt;/span> &lt;span class="n">PfR&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Gateway&lt;/span> &lt;span class="n">of&lt;/span> &lt;span class="n">last&lt;/span> &lt;span class="n">resort&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">set&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">1.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">1.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">2.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">2.2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">2.2&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">3.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">3.3&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">3.3&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">4.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">4.4&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">4.4&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">5.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">5.5&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">5.5&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">6.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">6.6&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">6.6&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">31&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">7.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">7.7&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">7.7&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">31&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">01&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">46&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">12.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">12.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">23.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">23.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">24.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">24.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">25.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">25.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">36.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">36.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">47.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">47.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">01&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">46&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">100.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">30&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="n">E2&lt;/span> &lt;span class="mf">100.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1010&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">41&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R8&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R8&lt;/span>&lt;span class="c1"># sh ip os border-routers &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">OSPF&lt;/span> &lt;span class="n">Router&lt;/span> &lt;span class="n">with&lt;/span> &lt;span class="n">ID&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mf">8.8&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">8.8&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Process&lt;/span> &lt;span class="n">ID&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Base&lt;/span> &lt;span class="n">Topology&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">MTID&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Internal&lt;/span> &lt;span class="n">Router&lt;/span> &lt;span class="n">Routing&lt;/span> &lt;span class="n">Table&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Codes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">Intra&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">area&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">I&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">Inter&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">area&lt;/span> &lt;span class="n">route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">i&lt;/span> &lt;span class="mf">55.55&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">55.55&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">58.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ASBR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ne">Area&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SPF&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R8&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>配置跨域的Option C MPLS VPN（Cisco）</title><link>https://kiraster.github.io/posts/c0ba4ae2.html/</link><pubDate>Sat, 04 Mar 2023 01:05:34 +0000</pubDate><guid>https://kiraster.github.io/posts/c0ba4ae2.html/</guid><description>&lt;p>&lt;strong>Introduction&lt;/strong>&lt;/p>
&lt;p>This document describes how to configure and verify the Inter-AS Layer 3 Multiprotocol Label Switching (MPLS) VPN, option C feature. A sample network scenario and its configuration and outputs are shown for a better understanding.&lt;/p>
&lt;p>本文描述的是根据思科网站一篇配置文档（https://www.cisco.com/c/en/us/support/docs/multiprotocol-label-switching-mpls/mpls/200523-Configuration-and-Verification-of-Layer.html#）修改搭建的一个实验。&lt;/p>
&lt;hr>
&lt;h2 id="环境">环境
&lt;/h2>&lt;ul>
&lt;li>模拟器：PNET 4.2.10&lt;/li>
&lt;li>Cisco IOL： l3-ADVENTERPRISEK9-M-15.4-2T.bin&lt;/li>
&lt;/ul>
&lt;h2 id="配置">配置
&lt;/h2>&lt;h3 id="网络拓扑">网络拓扑
&lt;/h3>&lt;p>&lt;strong>网站原图&lt;/strong>&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2023/03/07/oZLaRtUIcxgjFqe.jpg">
&lt;img src="https://s2.loli.net/2023/03/07/oZLaRtUIcxgjFqe.jpg"
loading="lazy"
alt="200523-Configuration-and-Verification-of-Layer-00"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>&lt;strong>搭建的拓扑&lt;/strong>&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2023/03/07/S4HEnAgOUe6QYpj.jpg">
&lt;img src="https://s2.loli.net/2023/03/07/S4HEnAgOUe6QYpj.jpg"
loading="lazy"
alt="ScreenCaputure230304012642"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h3 id="拓扑规划">拓扑规划
&lt;/h3>&lt;ol>
&lt;li>每台路由配置环回接口 0 ，格式为 R1： 1.1.1.1/32&lt;/li>
&lt;li>互联接口为：设备编号1 + 设备编号2 + .1.1 + 设备编号1，例如 R1 e0/0 接口IP地址：12.1.1.1/24&lt;/li>
&lt;li>R7、R8、R9、R10 为 CE，R11 和 R12 为 反射器&lt;/li>
&lt;li>ISP1，ISP2 底层 IGP 运行 OSPF 协议&lt;/li>
&lt;li>A1，A2 的 CE 与 PE 运行 OSPF 协议&lt;/li>
&lt;li>B1，B2 的 CE 与 PE 运行 BGP 协议&lt;/li>
&lt;/ol>
&lt;h3 id="配置思路">配置思路
&lt;/h3>&lt;ol>
&lt;li>配置 ISP 底层 OSPF IGP ，验证：show ip os nei / show ip route ospf&lt;/li>
&lt;li>配置 ISP 启用 MPLS LDP，验证：show mpls interface / show mpls ldp discovery&lt;/li>
&lt;li>配置 PE VRF，配置与 CE 互联接口划分到 VRF，验证：show ip vrf int / show ip route vrf &lt;strong>X&lt;/strong>&lt;/li>
&lt;li>配置 ISP 的 BGP 邻居，验证：show ip b summ / show ip b vpnv4 all summ&lt;/li>
&lt;li>配置 RR1 和 RR2 的 MP-eBGP，验证：show ip b vpnv4 all summ&lt;/li>
&lt;li>配置 CE 和 PE 间的路由协议，验证：show ip route vrf &lt;strong>X&lt;/strong> / show ip os nei / show ip b summ&lt;/li>
&lt;li>配置 PE 上 双向重分布&lt;/li>
&lt;/ol>
&lt;h3 id="配置步骤">配置步骤
&lt;/h3>&lt;ol>
&lt;li>
&lt;h4 id="配置-ip-地址-略">配置 IP 地址 （略）
&lt;/h4>&lt;/li>
&lt;li>
&lt;h4 id="配置-isp-底层-igp-以-isp-1-为例isp2-同理">配置 ISP 底层 IGP （以 ISP 1 为例，ISP2 同理）
&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R1 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">int ran e 0/0,e0/3,lo0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip os 100 a 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R2 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">int ran e0/0-1,e0/3,lo0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip os 100 a 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R3 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">int ran e 0/1,e0/3,lo0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip os 100 a 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R11 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">int ran e 0/1-3,lo0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip os 100 a 0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>**验证：**查看 OSPF 邻居，查看 OSPF 路由，以 R2 为例&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R2 output.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#sh ip os nei
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Neighbor ID Pri State Dead Time Address Interface
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">11.11.11.11 1 FULL/BDR 00:00:39 112.1.1.11 Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3.3.3.3 1 FULL/DR 00:00:30 23.1.1.3 Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1.1.1.1 1 FULL/BDR 00:00:39 12.1.1.1 Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#sh ip route ospf | b Gate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Gateway of last resort is not set
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1.0.0.0/32 is subnetted, 1 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">O 1.1.1.1 [110/11] via 12.1.1.1, 02:06:04, Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3.0.0.0/32 is subnetted, 1 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">O 3.3.3.3 [110/11] via 23.1.1.3, 02:05:54, Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 11.0.0.0/32 is subnetted, 1 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">O 11.11.11.11 [110/11] via 112.1.1.11, 02:05:54, Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 111.0.0.0/24 is subnetted, 1 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">O 111.1.1.0 [110/20] via 12.1.1.1, 02:06:04, Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 113.0.0.0/24 is subnetted, 1 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">O 113.1.1.0 [110/20] via 23.1.1.3, 02:05:54, Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;h4 id="配置-isp-启用-mpls-ldp-以-isp-1-为例isp2-同理">配置 ISP 启用 MPLS LDP （以 ISP 1 为例，ISP2 同理）
&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R1 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">int ran e 0/0,e0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mpls ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R2 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">int ran e0/0-1,e0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mpls ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R3 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">int ran e 0/1,e0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mpls ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R11 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">int ran e 0/1-3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mpls ip
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>验证：&lt;/strong> 查看 LDP 接口和 ldp 会话，以 R2 为例&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R2 output.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#sh mpls interfaces
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Interface IP Tunnel BGP Static Operational
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Ethernet0/0 Yes (ldp) No No No Yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Ethernet0/1 Yes (ldp) No No No Yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Ethernet0/3 Yes (ldp) No No No Yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#sh mpls ldp dis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#sh mpls ldp discovery
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Local LDP Identifier:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2.2.2.2:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Discovery Sources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Interfaces:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Ethernet0/0 (ldp): xmit/recv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> LDP Id: 1.1.1.1:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Ethernet0/1 (ldp): xmit/recv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> LDP Id: 3.3.3.3:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Ethernet0/3 (ldp): xmit/recv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> LDP Id: 11.11.11.11:0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;h4 id="配置-pe-的-vrf配置与-ce-互联的接口划分到-vrf">配置 PE 的 VRF，配置与 CE 互联的接口划分到 VRF
&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!---&lt;/span> &lt;span class="n">R1&lt;/span> &lt;span class="n">commands&lt;/span>&lt;span class="o">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">17.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">18.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!---&lt;/span> &lt;span class="n">R6&lt;/span> &lt;span class="n">commands&lt;/span>&lt;span class="o">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">69.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.6&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">106.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.6&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>**验证：**查看 VRF 路由表，以 R1 为例&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!---&lt;/span> &lt;span class="n">R1&lt;/span> &lt;span class="n">output&lt;/span>&lt;span class="o">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1">#sh ip route vrf a | b Gate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Gateway&lt;/span> &lt;span class="n">of&lt;/span> &lt;span class="n">last&lt;/span> &lt;span class="n">resort&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">set&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">7.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="mf">7.7&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">7.7&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">17.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">02&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">47&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">17.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">8&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">variably&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">subnets&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">masks&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">C&lt;/span> &lt;span class="mf">17.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">directly&lt;/span> &lt;span class="n">connected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">L&lt;/span> &lt;span class="mf">17.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">directly&lt;/span> &lt;span class="n">connected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1">#sh ip route vrf b | b Gate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Gateway&lt;/span> &lt;span class="n">of&lt;/span> &lt;span class="n">last&lt;/span> &lt;span class="n">resort&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">set&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">8.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">B&lt;/span> &lt;span class="mf">8.8&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">8.8&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">18.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">02&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">08&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">18.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">8&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">variably&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">subnets&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">masks&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">C&lt;/span> &lt;span class="mf">18.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">directly&lt;/span> &lt;span class="n">connected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">L&lt;/span> &lt;span class="mf">18.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">directly&lt;/span> &lt;span class="n">connected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;h4 id="配置-isp-的-bgp-邻居">配置 ISP 的 BGP 邻居
&lt;/h4>&lt;p>&lt;strong>R3 与 R4 配置 IPv4 BGP 邻居，R3 宣告 1.1.1.1 和 11.11.11.11，R4 宣告 6.6.6.6 和 12.12.12.12&lt;/strong>&lt;/p>
&lt;p>&lt;strong>将 BGP 路由重分布进底层 OSPF 协议，为了学习到对端 RR 和 PE 路由，建立 MP-BGP 需要&lt;/strong>&lt;/p>
&lt;p>由于底层 OSPF 协议的运行，R3 与 R4 已经学习到这些路由，在建立 eBGP 邻居后能传递到对端&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R3 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp log-neighbor-changes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 1.1.1.1 mask 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 11.11.11.11 mask 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 34.1.1.4 remote-as 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 34.1.1.4 send-label
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute bgp 100 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R4 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp log-neighbor-changes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 6.6.6.6 mask 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 12.12.12.12 mask 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 34.1.1.3 remote-as 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 34.1.1.3 send-label
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute bgp 200 subnets
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>验证：&lt;/strong>&lt;/p>
&lt;p>R3 与 R4 的 eBGP 邻居&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R3#sh ip b summary
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP router identifier 3.3.3.3, local AS number 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP table version is 75, main routing table version 75
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4 network entries using 560 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4 path entries using 320 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4/4 BGP path/bestpath attribute entries using 576 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1 BGP AS-PATH entries using 24 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0 BGP route-map cache entries using 0 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0 BGP filter-list cache entries using 0 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP using 1480 total bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP activity 4/0 prefixes, 36/32 paths, scan interval 60 secs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Neighbor V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">34.1.1.4 4 200 90 90 75 0 0 01:16:45 0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>R1 的 1.1.1.1 去往 R6 的 6.6.6.6 路由可达，标签路径连续&lt;/p>
&lt;p>R11 的 11.11.11.11 去往 R12 的 12.12.12.12 路由可达，标签路径连续&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R1#ping 6.6.6.6 source 1.1.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 6.6.6.6, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Packet sent with a source address of 1.1.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 6/6/8 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#traceroute 6.6.6.6 source 1.1.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Tracing the route to 6.6.6.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VRF info: (vrf in name/id, vrf out name/id)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 12.1.1.2 [MPLS: Label 24 Exp 0] 5 msec 6 msec 6 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2 23.1.1.3 [MPLS: Label 26 Exp 0] 6 msec 5 msec 6 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3 34.1.1.4 [MPLS: Label 27 Exp 0] 7 msec 7 msec 5 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4 45.1.1.5 [MPLS: Label 22 Exp 0] 4 msec 5 msec 6 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5 56.1.1.6 6 msec * 7 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R11#ping 12.12.12.12 source 11.11.11.11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 12.12.12.12, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Packet sent with a source address of 11.11.11.11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 3/3/4 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R11#trace 12.12.12.12 source 11.11.11.11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Tracing the route to 12.12.12.12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VRF info: (vrf in name/id, vrf out name/id)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 113.1.1.3 [MPLS: Label 27 Exp 0] 4 msec 4 msec 4 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2 34.1.1.4 [MPLS: Label 25 Exp 0] 3 msec 2 msec 2 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3 124.1.1.12 4 msec * 4 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R11#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>关于send-label 命令：&lt;/strong>&lt;/p>
&lt;p>tell the router to send the lables of bgp prefix to its peer，为 BGP 路由传递标签，使用此命令后，对应接口自动配置 mpls bgp forwarding ，但是 no 掉后接口的这行配置并不会自动去掉&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">*Mar 4 05:54:10.850: %BGP_LMM-6-AUTOGEN1: The mpls bgp forwarding command has been configured on interface: Ethernet0/0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>未配置 &lt;strong>send-label&lt;/strong> 命令前，R3 去往 6.6.6.6 的标签 是空标签，R3 的动作是弹出所有标签，标签中断。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R3#sh mpls forwarding-table 6.6.6.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Local Outgoing Prefix Bytes Label Outgoing Next Hop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Label Label or Tunnel Id Switched interface
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">26 No Label 6.6.6.6/32 0 Et0/0 34.1.1.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R3#sh ip b la
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R3#sh ip b labels
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Network Next Hop In label/Out label
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1.1.1.1/32 23.1.1.2 nolabel/nolabel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6.6.6.6/32 34.1.1.4 nolabel/nolabel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 11.11.11.11/32 113.1.1.11 nolabel/nolabel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 12.12.12.12/32 34.1.1.4 nolabel/nolabel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R3#sh ip b 6.6.6.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP routing table entry for 6.6.6.6/32, version 66
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Paths: (1 available, best #1, table default)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not advertised to any peer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Refresh Epoch 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 34.1.1.4 from 34.1.1.4 (4.4.4.4)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Origin IGP, metric 21, localpref 100, valid, external, best
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rx pathid: 0, tx pathid: 0x0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R3#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置 &lt;strong>send-label&lt;/strong> 命令后，分配 27 标签&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R3#sh mpls forwarding-table 6.6.6.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Local Outgoing Prefix Bytes Label Outgoing Next Hop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Label Label or Tunnel Id Switched interface
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">26 27 6.6.6.6/32 0 Et0/0 34.1.1.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R3#sh ip b labels
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Network Next Hop In label/Out label
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1.1.1.1/32 23.1.1.2 21/nolabel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6.6.6.6/32 34.1.1.4 nolabel/27
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 11.11.11.11/32 113.1.1.11 25/nolabel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 12.12.12.12/32 34.1.1.4 nolabel/25
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R3#sh ip b 6.6.6.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP routing table entry for 6.6.6.6/32, version 56
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Paths: (1 available, best #1, table default)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Not advertised to any peer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Refresh Epoch 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 34.1.1.4 from 34.1.1.4 (4.4.4.4)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Origin IGP, metric 21, localpref 100, valid, external, best
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mpls labels in/out nolabel/27
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rx pathid: 0, tx pathid: 0x0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 在 R4 上查看到关于去往6.6.6.6 的 入向标签 27
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R4#sh ip bgp labels
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Network Next Hop In label/Out label
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1.1.1.1/32 34.1.1.3 nolabel/21
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6.6.6.6/32 45.1.1.5 27/nolabel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 11.11.11.11/32 34.1.1.3 nolabel/25
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 12.12.12.12/32 124.1.1.12 25/nolabel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R4#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>R1 与 R11 配置 BGP VPNV4 邻居&lt;/strong>&lt;/p>
&lt;p>注意：R3 与 R11 不建立 BGP 邻居&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R1 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no bgp default ipv4-unicast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 11.11.11.11 remote-as 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 11.11.11.11 update-source Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address-family vpnv4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 11.11.11.11 activate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R11 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp log-neighbor-changes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no bgp default ipv4-unicast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 1.1.1.1 remote-as 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 1.1.1.1 update-source Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address-family vpnv4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 1.1.1.1 activate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 1.1.1.1 route-reflector-client
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>R6 与 R12 配置 BGP VPNV4 邻居&lt;/strong>&lt;/p>
&lt;p>注意：R4 与 R12 不建立 BGP 邻居&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R6 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no bgp default ipv4-unicast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 12.12.12.12 remote-as 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 12.12.12.12 update-source Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address-family vpnv4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 12.12.12.12 activate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R12 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no bgp default ipv4-unicast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 6.6.6.6 remote-as 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 6.6.6.6 update-source Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address-family vpnv4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 6.6.6.6 activate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 6.6.6.6 route-reflector-client
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>**验证：**VPNV4 邻居&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">sh ip b vpnv4 all summary
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>R11 与 R12 建立 MP-eBGP 邻居&lt;/strong>&lt;/p>
&lt;p>设置 eBGP 多跳。不是物理直连的 eBGP 邻居&lt;/p>
&lt;p>设置下一跳不改变。R11 与 R12 建立 MP-eBGP 邻居，传递路由时默认下一跳改变成自身，这样 ISP 两侧的流量互通都流经反射器不合理，设置下一跳不改变后，R1 上去往 ISP2 CE 的路由下一跳看到的是 R6 的 6.6.6.6 ，最后再在两个 ISP 内部控制底层 IGP 的路径，使得流量不经过反射器。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R11 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 12.12.12.12 remote-as 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 12.12.12.12 ebgp-multihop 255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 12.12.12.12 update-source Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address-family vpnv4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 12.12.12.12 activate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 12.12.12.12 next-hop-unchanged
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R12 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 11.11.11.11 remote-as 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 11.11.11.11 ebgp-multihop 255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 11.11.11.11 update-source Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address-family vpnv4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 11.11.11.11 activate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 11.11.11.11 next-hop-unchanged
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>验证：查看 R11 上的 BGP 邻居&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R11#sh ip b vpnv4 all summary
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP router identifier 11.11.11.11, local AS number 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP table version is 67, main routing table version 67
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6 network entries using 912 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6 path entries using 480 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5/5 BGP path/bestpath attribute entries using 760 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3 BGP AS-PATH entries using 72 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4 BGP extended community entries using 128 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0 BGP route-map cache entries using 0 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0 BGP filter-list cache entries using 0 bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP using 2352 total bytes of memory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BGP activity 6/0 prefixes, 6/0 paths, scan interval 60 secs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Neighbor V AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1.1.1.1 4 100 127 151 67 0 0 01:50:57 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12.12.12.12 4 200 190 185 67 0 0 01:50:16 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R11#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;h4 id="配置-ce-和-pe-间的路由协议">配置 CE 和 PE 间的路由协议
&lt;/h4>&lt;p>以 R7，R8，R1 为例， R9，R10，R6 同理&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R7 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">int ran e 0/0,lo0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip os 7 a 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R8 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 300
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 8.8.8.8 mask 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 18.1.1.1 remote-as 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!--- R1 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 1 vrf a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 1.1.1.17
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 17.1.1.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address-family ipv4 vrf b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 18.1.1.8 remote-as 300
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>验证：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">show ip os nei
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">show ip route ospf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">show ip route vrf a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">show ip route vrf b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sh ip b summary
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;h4 id="配置-pe-上-双向重分布">配置 PE 上 双向重分布
&lt;/h4>&lt;p>以 R1 为例，只需在 VRF a&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!--- R1 commands.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># 只需在 vrf a 和 BGP ipv4 vrf a 视图下配置重分布
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># R8 - R1 之间运行的是 BGP ，在 BGP ipv4 vrf b 视图下建立邻居即可
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 1 vrf a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute bgp 100 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> address-family ipv4 vrf a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute ospf 1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;h4 id="优化isp-内部-ospf-下一跳">优化ISP 内部 OSPF 下一跳
&lt;/h4>&lt;p>查看 R1 路由表发现，去往 9.9.9.9 下一跳是 6.6.6.6&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1">#sh ip b vpnv4 vrf a &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">BGP&lt;/span> &lt;span class="n">table&lt;/span> &lt;span class="n">version&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="mi">166&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">local&lt;/span> &lt;span class="n">router&lt;/span> &lt;span class="n">ID&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="mf">1.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Status&lt;/span> &lt;span class="n">codes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="n">suppressed&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="n">damped&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="n">history&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">valid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">best&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">internal&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r&lt;/span> &lt;span class="n">RIB&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">failure&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">S&lt;/span> &lt;span class="n">Stale&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">m&lt;/span> &lt;span class="n">multipath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="n">backup&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="n">RT&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Filter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="n">best&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">external&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="n">additional&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="n">RIB&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">compressed&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Origin&lt;/span> &lt;span class="n">codes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">IGP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">e&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">EGP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">?&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">incomplete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">RPKI&lt;/span> &lt;span class="n">validation&lt;/span> &lt;span class="n">codes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="n">valid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">I&lt;/span> &lt;span class="n">invalid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">N&lt;/span> &lt;span class="n">Not&lt;/span> &lt;span class="n">found&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Network&lt;/span> &lt;span class="n">Next&lt;/span> &lt;span class="n">Hop&lt;/span> &lt;span class="n">Metric&lt;/span> &lt;span class="n">LocPrf&lt;/span> &lt;span class="n">Weight&lt;/span> &lt;span class="ne">Path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Route&lt;/span> &lt;span class="n">Distinguisher&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">default&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&amp;gt;&lt;/span> &lt;span class="mf">7.7&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">7.7&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="mf">17.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.7&lt;/span> &lt;span class="mi">11&lt;/span> &lt;span class="mi">32768&lt;/span> &lt;span class="err">?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&amp;gt;&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="mf">9.9&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">9.9&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="mf">6.6&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">6.6&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="err">?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&amp;gt;&lt;/span> &lt;span class="mf">17.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">32768&lt;/span> &lt;span class="err">?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&amp;gt;&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="mf">69.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="mf">6.6&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">6.6&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="err">?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1">#sh ip route vrf a | b Gate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Gateway&lt;/span> &lt;span class="n">of&lt;/span> &lt;span class="n">last&lt;/span> &lt;span class="n">resort&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">set&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">7.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">O&lt;/span> &lt;span class="mf">7.7&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">7.7&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">110&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">17.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">04&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">21&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">39&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">9.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">B&lt;/span> &lt;span class="mf">9.9&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">9.9&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">6.6&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">6.6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">17.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">8&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">variably&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">subnets&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">masks&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">C&lt;/span> &lt;span class="mf">17.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">directly&lt;/span> &lt;span class="n">connected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">L&lt;/span> &lt;span class="mf">17.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">directly&lt;/span> &lt;span class="n">connected&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mf">69.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">subnetted&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">subnets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">B&lt;/span> &lt;span class="mf">69.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="mf">6.6&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">6.6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">03&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>再查找，去往 6.6.6.6 前缀有两条路径，管理和开销都一致，负载均衡？&lt;/p>
&lt;p>这条路由是 R3 BGP 重分布进底层 IGP OSPF 而学习到的，有两条路径，管理距离110，metric 1 ，这时候需要比较forwarding metric，很不巧的是forwarding metric 也是一样，这样去往 6.6.6.6 就真负载均衡。forwarding metric 是本地到 ASBR 的 开销，修改 R11 e0/1-3 的开销。同理也需要修改 R12 的接口开销。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">O E2 12.12.12.12/32 [110/1] via 111.1.1.11, 01:37:27, Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> [110/1] via 12.1.1.2, 03:15:27, Ethernet0/0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R1#sh ip route | b Gate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Gateway of last resort is not set
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1.0.0.0/32 is subnetted, 1 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">C 1.1.1.1 is directly connected, Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2.0.0.0/32 is subnetted, 1 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">O 2.2.2.2 [110/11] via 12.1.1.2, 04:26:59, Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3.0.0.0/32 is subnetted, 1 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">O 3.3.3.3 [110/21] via 111.1.1.11, 01:37:27, Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> [110/21] via 12.1.1.2, 04:26:49, Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6.0.0.0/32 is subnetted, 1 subnets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">O E2 6.6.6.6 [110/1] via 111.1.1.11, 01:37:27, Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> [110/1] via 12.1.1.2, 03:15:27, Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">……
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#sh ip route 6.6.6.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Routing entry for 6.6.6.6/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Known via &amp;#34;ospf 100&amp;#34;, distance 110, metric 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tag 200, type extern 2, forward metric 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Last update from 12.1.1.2 on Ethernet0/0, 00:00:51 ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Routing Descriptor Blocks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * 111.1.1.11, from 3.3.3.3, 00:31:15 ago, via Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Route metric is 1, traffic share count is 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Route tag 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 12.1.1.2, from 3.3.3.3, 00:00:51 ago, via Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Route metric is 1, traffic share count is 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Route tag 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># 修改 R11 R12 的接口开销
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R11(config)#int ran e 0/1-/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R11(config-if-range)#ip ospf cost 1000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R12(config-if)#int ran e 0/1-0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R12(config-if-range)#ip ospf cost 1000
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># 修改 R11 R12 的接口开销后
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#sh ip route 6.6.6.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Routing entry for 6.6.6.6/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Known via &amp;#34;ospf 100&amp;#34;, distance 110, metric 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tag 200, type extern 2, forward metric 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Last update from 12.1.1.2 on Ethernet0/0, 00:08:51 ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Routing Descriptor Blocks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * 12.1.1.2, from 3.3.3.3, 00:08:51 ago, via Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Route metric is 1, traffic share count is 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Route tag 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R6#sh ip rou 1.1.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Routing entry for 1.1.1.1/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Known via &amp;#34;ospf 200&amp;#34;, distance 110, metric 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tag 100, type extern 2, forward metric 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Last update from 56.1.1.5 on Ethernet0/0, 00:02:30 ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Routing Descriptor Blocks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> * 56.1.1.5, from 4.4.4.4, 00:39:02 ago, via Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Route metric is 1, traffic share count is 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Route tag 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R6#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="测试">测试
&lt;/h3>&lt;p>&lt;strong>R7 和 R9 之间的 ping 操作&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R7#ping 9.9.9.9 source 7.7.7.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 9.9.9.9, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Packet sent with a source address of 7.7.7.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 8/8/11 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R7#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R9#ping 7.7.7.7 source 9.9.9.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 7.7.7.7, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Packet sent with a source address of 9.9.9.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 8/8/10 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R9#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>R8 和 R10 之间的 ping 操作&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R8#ping 10.10.10.10 source 8.8.8.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 10.10.10.10, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Packet sent with a source address of 8.8.8.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 8/9/13 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R8#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R10#ping 8.8.8.8 source 10.10.10.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is 2 seconds:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Packet sent with a source address of 10.10.10.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!!!!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success rate is 100 percent (5/5), round-trip min/avg/max = 8/9/10 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R10#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>R7 和 R9 之间的 Traceroute 操作&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R7#traceroute 9.9.9.9 source 7.7.7.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Tracing the route to 9.9.9.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VRF info: (vrf in name/id, vrf out name/id)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 17.1.1.1 1 msec 1 msec 2 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2 12.1.1.2 [MPLS: Labels 24/26 Exp 0] 8 msec 8 msec 8 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3 23.1.1.3 [MPLS: Labels 26/26 Exp 0] 8 msec 12 msec 7 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4 34.1.1.4 [MPLS: Labels 27/26 Exp 0] 8 msec 9 msec 8 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5 45.1.1.5 [MPLS: Labels 22/26 Exp 0] 9 msec 8 msec 8 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6 69.1.1.6 [MPLS: Label 26 Exp 0] 9 msec 7 msec 9 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 7 69.1.1.9 9 msec * 9 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R7#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R9#traceroute 7.7.7.7 source 9.9.9.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Tracing the route to 7.7.7.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VRF info: (vrf in name/id, vrf out name/id)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 69.1.1.6 2 msec 39 msec 2 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2 56.1.1.5 [MPLS: Labels 25/26 Exp 0] 10 msec 9 msec 9 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3 45.1.1.4 [MPLS: Labels 23/26 Exp 0] 12 msec 9 msec 9 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4 34.1.1.3 [MPLS: Labels 21/26 Exp 0] 10 msec 8 msec 10 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5 23.1.1.2 [MPLS: Labels 19/26 Exp 0] 9 msec 10 msec 11 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6 17.1.1.1 [MPLS: Label 26 Exp 0] 7 msec 18 msec 9 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 7 17.1.1.7 8 msec * 8 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R9#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>R8 和 R10 之间的 Traceroute 操作&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R8#traceroute 10.10.10.10 source 8.8.8.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Tracing the route to 10.10.10.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VRF info: (vrf in name/id, vrf out name/id)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 18.1.1.1 2 msec 1 msec 1 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2 12.1.1.2 [MPLS: Labels 24/28 Exp 0] 8 msec 9 msec 9 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3 23.1.1.3 [MPLS: Labels 26/28 Exp 0] 9 msec 9 msec 9 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4 34.1.1.4 [MPLS: Labels 27/28 Exp 0] 10 msec 8 msec 10 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5 45.1.1.5 [MPLS: Labels 22/28 Exp 0] 7 msec 9 msec 8 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6 106.1.1.6 [MPLS: Label 28 Exp 0] 8 msec 7 msec 9 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 7 106.1.1.10 8 msec * 10 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R8#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R10#traceroute 8.8.8.8 source 10.10.10.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type escape sequence to abort.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Tracing the route to 8.8.8.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VRF info: (vrf in name/id, vrf out name/id)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 106.1.1.6 1 msec 2 msec 1 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 2 56.1.1.5 [MPLS: Labels 25/28 Exp 0] 8 msec 8 msec 11 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3 45.1.1.4 [MPLS: Labels 23/28 Exp 0] 8 msec 28 msec 8 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 4 34.1.1.3 [MPLS: Labels 21/28 Exp 0] 8 msec 11 msec 8 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5 23.1.1.2 [MPLS: Labels 19/28 Exp 0] 9 msec 8 msec 10 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6 18.1.1.1 [MPLS: Label 28 Exp 0] 16 msec 6 msec 7 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 7 18.1.1.8 9 msec * 10 msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R10#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="一个视频">一个视频
&lt;/h2>
&lt;div class="video-wrapper">
&lt;iframe src="https://player.bilibili.com/player.html?as_wide=1&amp;amp;high_quality=1&amp;amp;page=1&amp;bvid=BV1Lv4y1a7tG"
scrolling="no"
frameborder="no"
framespacing="0"
allowfullscreen="true"
>
&lt;/iframe>
&lt;/div>
&lt;h2 id="最后">最后
&lt;/h2>&lt;ul>
&lt;li>文中可能有些配置未提及或内容术语表述的不规范，请见谅。&lt;/li>
&lt;li>配置存阿里云盘了，这是链接：[&lt;a class="link" href="https://www.aliyundrive.com/s/HueqNEaKSAx" target="_blank" rel="noopener"
>分享的文件
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>]&lt;/li>
&lt;li>欢迎“&lt;del>来电&lt;/del>”来函探讨。&lt;/li>
&lt;/ul></description></item><item><title>IPv6 各隧道Tunnel使用Lab</title><link>https://kiraster.github.io/posts/2e964a67.html/</link><pubDate>Sun, 03 Apr 2022 07:18:36 +0000</pubDate><guid>https://kiraster.github.io/posts/2e964a67.html/</guid><description>&lt;p>最近看了很多关于 IPv6 的内容。老早前，大概2000年前后运营商就开始研究推进发展 IPv6 网络技术了，可能是是由于某些我等不知道的原因，这个推进的进程所演化出的表象让我等普通网民没什么感觉。部分科研机构、高校、金融、IT 大厂已经在使用了，一个比较大的使用群体也就是家用部分普及的不大开（我猜的，没有依据）。&lt;/p>
&lt;p>IPv6 相对于 IPv4 有种种的优势，我最有印象的几个是没有广播这个概念、“真 万物互联”、良好的包扩展结构，相对于 IPv4 不存在把什么什么封装进 IPv4 头部后面的字节……巴拉巴拉&lt;/p>
&lt;p>既然是实验，先上图：&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/05/02/WqsFfpynmbOgCe1.png">
&lt;img src="https://s2.loli.net/2022/05/02/WqsFfpynmbOgCe1.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;hr>
&lt;h2 id="start">Start
&lt;/h2>&lt;p>介绍一下这个拓扑包含的内容：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>A head&lt;/strong> 部分&lt;/p>
&lt;ul>
&lt;li>从运营商处申请到 240E:0:0:1500::/60 前缀，互联地址为静态 IPv6 ：240E:0:0:15::&lt;/li>
&lt;li>PC 网关在 SW19 / SW20，配置负载分担 （HSRP）；使用 MST ；PC 地址为无状态获取，同时获取除地址外的其他 DHCP 参数&lt;/li>
&lt;li>核心交换机与 R5 运行 OSPFv3,&lt;/li>
&lt;li>A head 和 A branch1 / A branch2 组建基于 IPv6 的 DMVPN (mGRE)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>A branch1&lt;/strong> 部分&lt;/p>
&lt;ul>
&lt;li>从运营商处申请到 2409:0:0:2600::/60 前缀，互联地址为静态 IPv6 2409:0:0:26::&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>A branch2 / B head&lt;/strong> 部分&lt;/p>
&lt;ul>
&lt;li>使用 PPPOE 拨号接入 ISP ，WAN 动态 IPv6 地址，并且获取到 PD 用于内部网络&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>其他站点如图所示&lt;/p>
&lt;ul>
&lt;li>R3 为 ISP IPv4 接入路由器，连接 R3 的三个站点除配置了 Tunnel 外，还支持 NAT 访问互联网&lt;/li>
&lt;li>为什么是就配置了这三个站点的 NAT，因为本人电脑内存不够（运行 NAT 的路由器要分配更多内存）&lt;/li>
&lt;li>6RD 的站点内部为 IPv6 网络&lt;/li>
&lt;li>IPv6 Over IPv4 的 站点互通配置了静态或者动态路由协议&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>为了测试，ISP 网络中均配置了环回接口的 IPv4/IPv6 地址，例如：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>R2&lt;/p>
&lt;p>interface Loopback0
ip address 10.2.2.2 255.255.255.255
ipv6 address 2008::2/128&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>除 Manual 和 GRE Tunnel 外，站点所有 IPv6 地址均可互通&lt;/p>
&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h2 id="design--configuration">Design &amp;amp; Configuration
&lt;/h2>&lt;p>&lt;strong>Note：ISP Network 内部运行 OSPF/OSPFv3，不展开说明。&lt;/strong>&lt;/p>
&lt;h3 id="a-head-配置">&lt;strong>A head&lt;/strong> 配置
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.5.5.5 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address FD00::5/128 // 惟一本地地址，不可在互联上路由
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 240E:0:0:15::5/64 // 与 ISP 互联地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 10.5.5.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default-information originate // OSPFv3 下发默认路由
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 route ::/0 240E:0:0:15::1 // 指向 ISP 的默认路由
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- DMVPN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> description DMVPN_HUB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address FD00:A::1/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 eigrp 90
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nhrp network-id 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode gre multipoint ipv6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 router eigrp 90 // HUB 与 SPOKE 之间运行 EIGRP,IPv6 multicast over mGRE tunnel is not supported.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor FE80::A8BB:CCFF:FE00:600 Tunnel1 // 手动指邻居
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor FE80::A8BB:CCFF:FE00:700 Tunnel1 // 手动指邻居
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> eigrp router-id 10.5.5.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute ospf 100 metric 10000 100 255 1 1500 // 重分布 OSPF 进 EIGRP 便于分支站点访问总部网络
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- SW19
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 dhcp pool O-POOL // DHCP 参数
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> domain-name a.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mode mst // mst 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mst configuration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name a.com.hub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> revision 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> instance 10 vlan 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> instance 20 vlan 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mst 10 priority 24576 // 实例 10 的主根桥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mst 20 priority 28672 // 实例 20 的备根桥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.19.19.19 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address FD00::19/128
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Port-channel1 // SW19 SW20 之间的端口聚合
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport access vlan 519 // 与 R5 互联端口
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> channel-group 1 mode active
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> channel-group 1 mode active
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby version 2 // HSRP 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 10 ipv6 autoconfig
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 10 priority 120 // 优先级120，设置为 Active 端
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 10 preempt delay minimum 30 // 抢占延迟 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 240E:0:0:1501::1/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nd other-config-flag // O 位
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp server O-POOL // 分配给终端 DHCP 其他参数
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby version 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 20 ipv6 autoconfig
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 20 preempt delay minimum 30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 240E:0:0:1502::1/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nd other-config-flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp server O-POOL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan519 // 与 R5 互联建立 OSPFV4 邻居
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 10.19.19.19
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- SW20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 dhcp pool O-POOL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> domain-name a.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mode mst
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree extend system-id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mst configuration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name a.com.hub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> revision 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> instance 10 vlan 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> instance 20 vlan 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mst 10 priority 28672
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mst 20 priority 24576
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.20.20.20 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address FD00::20/128
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Port-channel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport access vlan 520
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> channel-group 1 mode passive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> channel-group 1 mode passive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby version 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 10 ipv6 autoconfig
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 10 preempt delay minimum 30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 240E:0:0:1501::2/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nd other-config-flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp server O-POOL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby version 2 // HSRP 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 20 ipv6 autoconfig
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 20 priority 120 // 优先级120，设置为 Active 端
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> standby 20 preempt delay minimum 30 // 抢占延迟 30s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 240E:0:0:1502::2/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nd other-config-flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp server O-POOL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan520
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 10.20.20.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- SW21
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mode mst
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">spanning-tree mst configuration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> name a.com.hub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> revision 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> instance 10 vlan 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> instance 20 vlan 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport access vlan 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport access vlan 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="a-branch1-配置">&lt;strong>A branch1&lt;/strong> 配置
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 dhcp pool O-POOL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> domain-name a.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1 // DMVPN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> description DMVPN_BRANCH_1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address FD00:A::2/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 eigrp 90 // EIGRP 启用
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nhrp map FD00:A::1/64 240E:0:0:15::5 // 映射 FD00:A::1 R5 的公网 IPv6 地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nhrp map multicast 240E:0:0:15::5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nhrp network-id 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nhrp nhs FD00:A::1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode gre multipoint ipv6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 2409:0:0:26::6/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address autoconfig default //生成指向 ISP 默认路由
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 2409:0:0:2600::6/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nd other-config-flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 eigrp 90 // EIGRP 启用
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp server O-POOL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 router eigrp 90 //运行 EIGRP,IPv6 multicast over mGRE tunnel is not supported.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor FE80::A8BB:CCFF:FE00:500 Tunnel1 // 手动指邻居
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor FE80::A8BB:CCFF:FE00:700 Tunnel1 // 手动指邻居
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> eigrp router-id 10.6.6.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="a-branch2--b-head-配置">&lt;strong>A branch2 / B head&lt;/strong> 配置
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 dhcp pool O-POOL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> domain-name a.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1 // DMVPN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> description DMVPN_BRANCH_2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address FD00:A::3/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 eigrp 90 // EIGRP 启用
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nhrp map FD00:A::1/64 240E:0:0:15::5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nhrp map multicast 240E:0:0:15::5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nhrp network-id 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nhrp nhs FD00:A::1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Dialer1 // 出接口为 Dialer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode gre multipoint ipv6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pppoe enable group global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pppoe-client dial-pool-number 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address INTRA_PD ::7/64 // 使用获取到的前缀配置接口IPv6地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nd other-config-flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 eigrp 90 // EIGRP 启用
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp server O-POOL // DHCP 参数下发
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Dialer1 // PPPOE 拨号
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mtu 1492
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation ppp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dialer pool 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dialer-group 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address dhcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address autoconfig default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 mtu 1492
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp client pd INTRA_PD //获取前缀，命名 INTRA_PD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ppp authentication pap callin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ppp pap sent-username user1 password 0 user1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 router eigrp 90 // 运行 EIGRP,IPv6 multicast over mGRE tunnel is not supported.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor FE80::A8BB:CCFF:FE00:500 Tunnel1 // 手动指邻居
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor FE80::A8BB:CCFF:FE00:600 Tunnel1 // 手动指邻居
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> eigrp router-id 10.7.7.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-----------------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- R8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 dhcp pool O-POOL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns-server 2008::2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> domain-name b.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pppoe enable group global
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pppoe-client dial-pool-number 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address INTRA_PD ::8/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nd other-config-flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp server O-POOL // DHCP 参数下发
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Dialer1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mtu 1492
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation ppp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dialer pool 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dialer-group 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address dhcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address autoconfig default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 mtu 1492
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp client pd INTRA_PD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ppp authentication pap callin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ppp pap sent-username user2 password 0 user2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R2 PPPOE SERVER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 dhcp pool DHCPV6POOL //配置 PD 池
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> prefix-delegation pool POOL-2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">username user1 password 0 user1 // 用于 PPPOE 拨号认证
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">username user2 password 0 user2 // 用于 PPPOE 拨号认证
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bba-group pppoe GROUP-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual-template 1 // 绑定模版1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback11 // 这个地址用于复用，不知道Cisco为什么这般设计，直接在模版下配不就行了
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 2409:0:0:2::2/60
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pppoe enable group GROUP-1 // 调用
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Virtual-Template1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> description PPPOE-GROUP-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mtu 1492
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> peer default ipv6 pool PPPOE-PEER-POOL // 为拨号客户端对端配置 IPv6 的地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 unnumbered Loopback11 // 复用
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 mtu 1492
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 nd managed-config-flag
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ipv6 nd ra suppress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 dhcp server DHCPV6POOL // PD 下发
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ppp authentication pap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 local pool POOL-2 2409:0:0:2780::/60 64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 local pool PPPOE-PEER-POOL 2409:0:0:2220::/60 64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="isatap-tunnel">ISATAP Tunnel
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1 // ISATAP Tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip redirects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 2409:0:0:2900::/64 eui-64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ipv6 nd ra suppress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode ipv6ip isatap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 2409:0:0:29::9/64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.9.254 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 route ::/0 2409:0:0:29::2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="gre-tunnel">GRE Tunnel
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R15
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1 // GRE Tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel destination 200.1.103.10 // R10 WAN 地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.154.15 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.15.254 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address FD00:F::F/64 // 惟一本地地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 ospf 100 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route 0.0.0.0 0.0.0.0 200.1.154.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 10.15.15.15
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">--&lt;/span> &lt;span class="n">R10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Tunnel1&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">GRE&lt;/span> &lt;span class="n">Tunnel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="n">area&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">destination&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">154.15&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">R15&lt;/span> &lt;span class="n">WAN&lt;/span> &lt;span class="err">地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">103.10&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.254&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="n">FD00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">A&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="n">A&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">64&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">惟一本地&lt;/span>&lt;span class="n">IPv6地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="n">area&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="n">overload&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">IPv4&lt;/span> &lt;span class="n">NAT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">103.3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ipv6&lt;/span> &lt;span class="n">router&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">router&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">id&lt;/span> &lt;span class="mf">10.10&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="6to4-tunnel-and-realy">6to4 Tunnel and Realy
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R14
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1 // 6to4 Tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip redirects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 unnumbered Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode ipv6ip 6to4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.144.14 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 2408:0:0:E4::E/64 // 与 R4 互联的 IPv6 地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 2002:C801:900E::E/64 // 6to4 地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route 0.0.0.0 0.0.0.0 200.1.144.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 route 2002::/16 Tunnel1 // 站点互通
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 route ::/0 2408:0:0:E4::4 // 访问 ISP IPv6 网络
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">--&lt;/span> &lt;span class="n">R11&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Tunnel1&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="n">to4&lt;/span> &lt;span class="n">Tunnel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">redirects&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">mode&lt;/span> &lt;span class="n">ipv6ip&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="n">to4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">113.11&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">11.254&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mi">2002&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">C801&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">710&lt;/span>&lt;span class="n">B&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="n">B&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">64&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="n">to4&lt;/span> &lt;span class="err">地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="n">overload&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">IPv4&lt;/span> &lt;span class="n">NAT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">113.3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ipv6&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mi">2002&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">16&lt;/span> &lt;span class="n">Tunnel1&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">站点互通&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ipv6&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="p">::&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="mi">2002&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">C801&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">900&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="n">E&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">访问&lt;/span>&lt;span class="n">IPv6&lt;/span> &lt;span class="err">互联&lt;/span> &lt;span class="err">下一跳&lt;/span> &lt;span class="err">到&lt;/span> &lt;span class="n">R14&lt;/span> &lt;span class="err">中继&lt;/span> &lt;span class="err">转发&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">11.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="manual-tunnel">Manual Tunnel
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R13
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1 // Manual Tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 rip RIPNG enable // 启用 RIPNG
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode ipv6ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel destination 200.1.123.12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.134.13 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address FC00:D::D/64 // 惟一本地IPv6地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 rip RIPNG enable // 启用 RIPNG
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route 0.0.0.0 0.0.0.0 200.1.134.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 router rip RIPNG // 站点互通 RIPNG
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">--&lt;/span> &lt;span class="n">R12&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Tunnel1&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">Manual&lt;/span> &lt;span class="n">Tunnel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">rip&lt;/span> &lt;span class="n">RIPNG&lt;/span> &lt;span class="n">enable&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">启用&lt;/span> &lt;span class="n">RIPNG&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">mode&lt;/span> &lt;span class="n">ipv6ip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">destination&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">134.13&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">123.12&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">12.254&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="n">FC00&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">64&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">惟一本地&lt;/span>&lt;span class="n">IPv6地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ipv6&lt;/span> &lt;span class="n">rip&lt;/span> &lt;span class="n">RIPNG&lt;/span> &lt;span class="n">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="n">overload&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">IPv4&lt;/span> &lt;span class="n">NAT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">123.3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ipv6&lt;/span> &lt;span class="n">router&lt;/span> &lt;span class="n">rip&lt;/span> &lt;span class="n">RIPNG&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">站点互通&lt;/span> &lt;span class="n">RIPNG&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">12.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="6rd-tunnel">6RD Tunnel
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 general-prefix 6RD 6rd Tunnel1 // 从Tunnel 1 获取 ISP 通用前缀 命名为6RD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1 // 6RD Tunnel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip redirects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 6RD ::/128 // 通过命名为6RD 的通用前缀构建 IPv6 地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode ipv6ip 6rd // 模式
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel 6rd ipv4 prefix-len 16 // IPv4 通用前缀 ，不设置通用后缀
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel 6rd prefix 2408:1617::/32 //ISP 设定的 IPv6 前缀
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel 6rd br 200.1.4.4 // BR 地址，位于 ISP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.164.16 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 2408:1617:A410:F::F/64 // 通过 ISP 设定的前缀 + IPv4 通用前缀构造，IPv4通用前缀占去16位，而通用后缀没有设置，所以就是164.16，转16进制
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route 0.0.0.0 0.0.0.0 200.1.164.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 route 2408:1617::/32 Tunnel1 // 站点互访
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 route ::/0 Tunnel1 2408:1617:404:: // 访问 IPv6 互联网
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R17
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 general-prefix 6RD 6rd Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip redirects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 6RD ::/128
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode ipv6ip 6rd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel 6rd ipv4 prefix-len 16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel 6rd prefix 2408:1617::/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel 6rd br 200.1.4.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.174.17 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 2408:1617:AE11:11::11/64 // // 通过 ISP 设定的前缀 + IPv4 通用前缀构造，IPv4通用前缀占去16位，而通用后缀没有设置，所以就是174.17，转16进制
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route 0.0.0.0 0.0.0.0 200.1.174.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 route 2408:1617::/32 Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 route ::/0 Tunnel1 2408:1617:404::
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 general-prefix 6RD 6rd Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.4.4 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no ip redirects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 address 6RD ::/128
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ipv6 enable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source Loopback1 // 指定源，6RD 网络 IPv4 可达，还有一种说法是，可以配置anycast，6RD 网络就近访问
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel mode ipv6ip 6rd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel 6rd ipv4 prefix-len 16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel 6rd prefix 2408:1617::/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ipv6 route 2408:1617::/32 Tunnel1 // 站点访问IPv6 网络 返回流量
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="test---observation">Test &amp;amp; Observation
&lt;/h2>&lt;p>&lt;strong>PC 23&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ping PC 24&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/wdq98eSpnQIomMu.png">
&lt;img src="https://s2.loli.net/2022/04/03/wdq98eSpnQIomMu.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping R5 Loopback0&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/pNRlmzbMueHx4ci.png">
&lt;img src="https://s2.loli.net/2022/04/03/pNRlmzbMueHx4ci.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 ISP Network 的 R3 Loopback0&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/T6NrPOZoiJQsqcG.png">
&lt;img src="https://s2.loli.net/2022/04/03/T6NrPOZoiJQsqcG.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 A branch1 的 PC 25&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/KZQrajkhO8iqm2R.png">
&lt;img src="https://s2.loli.net/2022/04/03/KZQrajkhO8iqm2R.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 B head 的 PC 26&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/3FZM1b8tQGxf7js.png">
&lt;img src="https://s2.loli.net/2022/04/03/3FZM1b8tQGxf7js.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 6to4 Tunnel site2 的 PC 28&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/zGR5jO2XhyDNk9w.png">
&lt;img src="https://s2.loli.net/2022/04/03/zGR5jO2XhyDNk9w.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 6RD Tunnel site1 的 PC 30&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/pt6MgExKAVrh7Jc.png">
&lt;img src="https://s2.loli.net/2022/04/03/pt6MgExKAVrh7Jc.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>&lt;strong>PC 25&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ping 位于 A head 的 PC 24&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/EiJG1AeWxF2Chwp.png">
&lt;img src="https://s2.loli.net/2022/04/03/EiJG1AeWxF2Chwp.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 A branch2 的 E0/1 接口&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/lCnirqdHXLAPzOI.png">
&lt;img src="https://s2.loli.net/2022/04/03/lCnirqdHXLAPzOI.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>&lt;strong>PC 26&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ping 位于 ISP Network 的 R4 Loopback0&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/CpJV95worZjDeq6.png">
&lt;img src="https://s2.loli.net/2022/04/03/CpJV95worZjDeq6.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 A head 的 PC 24&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/Pogt8efnYlw7hVS.png">
&lt;img src="https://s2.loli.net/2022/04/03/Pogt8efnYlw7hVS.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 6RD Tunnel site1 的 PC 30&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/OgaZPtVnw1ovWqm.png">
&lt;img src="https://s2.loli.net/2022/04/03/OgaZPtVnw1ovWqm.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>&lt;strong>PC 27&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ping GRE Tunnel site1 的 E0/1 接口&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/dJxVzWU75PaS4pM.png">
&lt;img src="https://s2.loli.net/2022/04/03/dJxVzWU75PaS4pM.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 ISP Network 的 R1 Loopback0 （IPv4）&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/4kKtLZCPviFn1XE.png">
&lt;img src="https://s2.loli.net/2022/04/03/4kKtLZCPviFn1XE.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>&lt;strong>PC 28&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ping 位于 6to4 Tunnel site1 E0/1 接口&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/UrGM7mXeSuRFJOx.png">
&lt;img src="https://s2.loli.net/2022/04/03/UrGM7mXeSuRFJOx.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 ISP Network 的 R1 Loopback0 （IPv6）&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/LSMXYa1GTCRV85A.png">
&lt;img src="https://s2.loli.net/2022/04/03/LSMXYa1GTCRV85A.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 ISP Network 的 R1 Loopback0 （IPv4）&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/kjEiPofQ8HVKc3t.png">
&lt;img src="https://s2.loli.net/2022/04/03/kjEiPofQ8HVKc3t.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>&lt;strong>PC 29&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ping 位于 Manual Tunnel site1 E0/1 接口&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/kfljUI6ZwMCFcBm.png">
&lt;img src="https://s2.loli.net/2022/04/03/kfljUI6ZwMCFcBm.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 ISP Network 的 R1 Loopback0 （IPv4）&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/MvtomBCDQfGwuZ9.png">
&lt;img src="https://s2.loli.net/2022/04/03/MvtomBCDQfGwuZ9.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>&lt;strong>PC 30&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ping 位于 6RD Tunnel site2 E0/1 接口&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/b9VUl7PrZRnWM1K.png">
&lt;img src="https://s2.loli.net/2022/04/03/b9VUl7PrZRnWM1K.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>ping 位于 ISP Network 的 R1 Loopback0 （IPv6）&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/04/03/x8Bg5QzJmsL6fUP.png">
&lt;img src="https://s2.loli.net/2022/04/03/x8Bg5QzJmsL6fUP.png"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;hr>
&lt;h2 id="ending">Ending
&lt;/h2>&lt;ul>
&lt;li>文中可能有些配置未提及或内容术语表述的不规范，请见谅。&lt;/li>
&lt;li>配置存阿里云盘了，这是链接：[&lt;a class="link" href="https://www.aliyundrive.com/s/L2WMMmcVR1A" target="_blank" rel="noopener"
>分享的文件
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>]&lt;/li>
&lt;li>欢迎“&lt;del>来电&lt;/del>”来函探讨。&lt;/li>
&lt;/ul></description></item><item><title>BGP综合实验拓扑</title><link>https://kiraster.github.io/posts/48f55792.html/</link><pubDate>Fri, 25 Feb 2022 01:32:49 +0000</pubDate><guid>https://kiraster.github.io/posts/48f55792.html/</guid><description>&lt;p>在B站看了一个UP主（&lt;a class="link" href="https://space.bilibili.com/455975406" target="_blank" rel="noopener"
>155和150
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>）上传的视频，感觉挺有意思的，就搭拓扑玩一玩。现在这个视频已经不见了，视频里使用的eNSP模拟器搭建的，我用PNET搭建，模拟器类型不关键。已经删减了一些内容，并加了一些实验需求。&lt;/p>
&lt;p>实验主要涉及到的BGP技术的运用，包括有BGP邻居建立、路由加载、路由传递、BGP联盟、路由聚合、路由拆分、团体属性、路由选路、正则表达式、路由过滤、BGP特性、路由阻尼等。&lt;/p>
&lt;p>拓扑如图：&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://s2.loli.net/2022/02/24/6S5qGjeiQCaPcHb.jpg">
&lt;img src="https://s2.loli.net/2022/02/24/6S5qGjeiQCaPcHb.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="实验需求">实验需求
&lt;/h2>&lt;h3 id="bgp邻居建立">BGP邻居建立
&lt;/h3>&lt;ol>
&lt;li>eBGP之间使用接口建立(联盟内部子AS eBGP除外)，iBGP使用环回接口Lo0建立&lt;/li>
&lt;li>R2、R7、R9使用对等体组方式配置&lt;/li>
&lt;li>R4、R7、R9为路由反射器&lt;/li>
&lt;/ol>
&lt;h3 id="bgp路由加载">BGP路由加载
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>R5将ISIS重分布进BGP，R6、R7、R8将ISIS重分布进BGP&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute isis level-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R6、R7、R8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute isis level-2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R5能够正常接收到100.1.1.X的路由，R4不能使用next-hop-self&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_NH permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set ip next-hop 120.1.4.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor iBGP route-map SET_NH out
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="bgp路由传递">BGP路由传递
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>100.1.1.x之间可以通信&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neighbor 200.1.103.10 as-override
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neighbor 200.1.116.11 as-override
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neighbor 200.1.127.12 as-override
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R3、R6、R7针对AS 64520移除私有AS号&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.103.10 remove-private-as all replace-as
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.116.11 remove-private-as all replace-as
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.127.12 remove-private-as all replace-as
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>AS 64540 内部联邦配置&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64530
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp log-neighbor-changes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp confederation identifier 64540
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp confederation peers 64531
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.12 remote-as 64531
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.12 disable-connected-check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.12 update-source Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.12 next-hop-self
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.116.6 remote-as 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64531
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp log-neighbor-changes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp confederation identifier 64540
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp confederation peers 64530
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute eigrp 90
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.11 remote-as 64530
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.11 disable-connected-check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.11 update-source Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.11 next-hop-self
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.13 remote-as 64531
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.13 update-source Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.13 next-hop-self
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.127.7 remote-as 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R13
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64531
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp log-neighbor-changes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp confederation identifier 64540
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 111.1.2.0 mask 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 111.1.3.0 mask 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> aggregate-address 111.1.0.0 255.255.0.0 as-set summary-only
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.12 remote-as 64531
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 100.1.1.12 update-source Loopback0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="bgp路由聚合路由拆分">BGP路由聚合、路由拆分
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>R5、R6、R7、R8对AS内的互联地址与主机路由汇总为子网掩码为16位的聚合路由（例如：120.1.0.0/16），并防止路由回愦&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> aggregate-address 123.1.0.0 255.255.0.0 as-set summary-only
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> aggregate-address 120.1.0.0 255.255.0.0 as-set summary-only
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R6、R7、R8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> aggregate-address 145.1.0.0 255.255.0.0 as-set summary-only
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> aggregate-address 140.1.0.0 255.255.0.0 as-set summary-only
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R5的汇总主机路由，不抑制120.1.4.4/32和 120.1.5.5/32&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list UNSUPPRESS seq 5 permit 120.1.4.4/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list UNSUPPRESS seq 10 permit 120.1.5.5/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map UNSUPPRESS permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address prefix-list UNSUPPRESS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 120.1.4.4 unsuppress-map UNSUPPRESS
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R6、R7、R8的汇总主机路由，仅抑制145.1.9.9/32 ，并调整聚合路由起源属性为 igp&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R6、R7、R8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list SUPPRESS seq 5 permit 140.1.9.9/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SUPPRESS permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address prefix-list SUPPRESS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_IGP permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set origin igp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> aggregate-address 140.1.0.0 255.255.0.0 as-set summary-only attribute-map SET_IGP suppress-map SUPPRESS
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R1去往111.1.0.0/24和111.1.1.0/24下一跳走R5；R2去往111.1.2.0/24和111.1.3.0/24下一跳走R8&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">SOURCE_AS64100&lt;/span> &lt;span class="n">seq&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">15.5&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">huizong&lt;/span> &lt;span class="n">seq&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">111.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">mingxi&lt;/span> &lt;span class="n">seq&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">111.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">mingxi&lt;/span> &lt;span class="n">seq&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">111.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">mingxi&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">mingxi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set&lt;/span> &lt;span class="n">community&lt;/span> &lt;span class="n">no&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">export&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">huizong&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">match&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">huizong&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">match&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">source&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">SOURCE_AS64100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">router&lt;/span> &lt;span class="n">bgp&lt;/span> &lt;span class="mi">64520&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bgp&lt;/span> &lt;span class="n">inject&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">mingxi&lt;/span> &lt;span class="n">exist&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">huizong&lt;/span> &lt;span class="n">copy&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">attributes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">SOURCE_AS64200&lt;/span> &lt;span class="n">seq&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">28.8&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">huizong&lt;/span> &lt;span class="n">seq&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">111.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">mingxi&lt;/span> &lt;span class="n">seq&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">111.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">2.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">mingxi&lt;/span> &lt;span class="n">seq&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">111.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">3.0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">24&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">mingxi&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">mingxi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set&lt;/span> &lt;span class="n">community&lt;/span> &lt;span class="n">no&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">export&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">huizong&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">match&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">huizong&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">match&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">source&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">SOURCE_AS64200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">router&lt;/span> &lt;span class="n">bgp&lt;/span> &lt;span class="mi">64520&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bgp&lt;/span> &lt;span class="n">inject&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">mingxi&lt;/span> &lt;span class="n">exist&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">huizong&lt;/span> &lt;span class="n">copy&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">attributes&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="bgp选路medas-pathlocal-pref">BGP选路(MED、AS-Path、Local-Pref)
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>R8上配置，实现AS 64200访问 120.1.X.X，X为偶数，走R4和R8互联链路；X为奇数，走R3和R6互联链路&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 10 permit 120.1.0.0 0.0.254.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 20 permit 120.1.1.1 0.0.254.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_LP permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set local-preference 120
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_LP permit 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set local-preference 99
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_LP permit 30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.48.4 route-map SET_LP in
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R6、R8上配置，实现AS 64100 访问 140.1.X.X/32，X为偶数，走R4和R8互联链路；X为奇数，走R3和R6互联链路&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 30 permit 140.1.0.0 0.0.254.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 40 permit 140.1.1.1 0.0.254.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_MED permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address 30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set metric 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_MED permit 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address 40
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set metric 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_MED permit 30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.36.3 route-map SET_MED out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 30 permit 140.1.0.0 0.0.254.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 40 permit 140.1.1.1 0.0.254.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_MED permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address 30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set metric 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_MED permit 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address 40
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set metric 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map SET_MED permit 30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.48.4 route-map SET_MED out
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R1上对起始于AS 64540的任意前缀，AS 64520总是通过R2转发（路由拆分的明细条目除外）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">配置 ip as-path列表，匹配AS 64540 开头的路径路由条目，route-map 设置追加AS号使路径变长
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip as-path access-list 100 permit _64540$
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map AS_PREPEND permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match as-path 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set as-path prepend last-as 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64520
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.15.5 route-map AS_PREPEND in
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="bgp路由过滤">BGP路由过滤
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>R6、R7仅通告 200.1.XY.0/24 与 100.1.1.X/32的路由到 R11、R12&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">route-map 设置匹配，向R11，R12通告路由进行过滤
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list ADV_TO_64540 seq 5 permit 200.1.0.0/16 le 24
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list ADV_TO_64540 seq 10 permit 100.1.1.0/24 le 32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map ADV_TO_64540 permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address prefix-list ADV_TO_64540
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.116.11 route-map ADV_TO_64540 out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list ADV_TO_64540 seq 5 permit 200.1.0.0/16 le 24
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list ADV_TO_64540 seq 10 permit 100.1.1.0/24 le 32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map ADV_TO_64540 permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address prefix-list ADV_TO_64540
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.127.12 route-map ADV_TO_64540 out
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R3、R10上配置ORF，使AS 64100仅通告 200.1.XY.0/24 与 100.1.1.X/32的前缀到R10&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">通过向对等体通告ORF能力可以激活这一feature。表示接受从对等体来的，前缀列表，并把这个前缀列表应用到针对对等体的出站方向。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list FROM_64100 seq 5 permit 200.1.0.0/16 le 24
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list FROM_64100 seq 10 permit 100.1.1.0/24 le 32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64540
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.103.3 capability orf prefix-list send
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.103.3 prefix-list FROM_64100 in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> neighbor 200.1.103.10 capability orf prefix-list receive
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="bgp-特性">BGP 特性
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>AS 64520 不作为传输型AS 不能使用BGP路由过滤&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">no&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">export团体属性&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">SET_COMM&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set&lt;/span> &lt;span class="n">community&lt;/span> &lt;span class="n">no&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">export&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">router&lt;/span> &lt;span class="n">bgp&lt;/span> &lt;span class="mi">64520&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">neighbor&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">2.2&lt;/span> &lt;span class="n">send&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">community&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">neighbor&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">2.2&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">SET_COMM&lt;/span> &lt;span class="n">out&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">R2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">SET_COMM&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set&lt;/span> &lt;span class="n">community&lt;/span> &lt;span class="n">no&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">export&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">router&lt;/span> &lt;span class="n">bgp&lt;/span> &lt;span class="mi">64520&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">neighbor&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="n">send&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">community&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">neighbor&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">SET_COMM&lt;/span> &lt;span class="n">out&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R1与R2之间的iBGP邻居启用MD5认证，密码为cisco&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">R1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neighbor 10.1.1.1 password cisco
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neighbor 10.1.2.2 password cisco
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R3上配置，若100.1.1.10/32不稳定，震荡2次抑制传递，并在5min后自动恢复&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">配置BGP路由惩罚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">R3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip prefix-list DAMPENING seq 5 permit 100.1.1.10/32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map DAMPENING permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address prefix-list DAMPENING
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set dampening 4 750 2000 16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router bgp 64100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bgp dampening route-map DAMPENING
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>R1上配置，若100.1.1.10路由条目存在，通告默认路由到R2&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">R1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">EXIST_10&lt;/span> &lt;span class="n">seq&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">100.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.10&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">DEFAULT_CONDITION&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">match&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="n">EXIST_10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set&lt;/span> &lt;span class="n">community&lt;/span> &lt;span class="n">no&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="k">export&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">router&lt;/span> &lt;span class="n">bgp&lt;/span> &lt;span class="mi">64520&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">neighbor&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">2.2&lt;/span> &lt;span class="n">default&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">originate&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="n">DEFAULT_CONDITION&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="ending">Ending
&lt;/h3>&lt;ul>
&lt;li>文中可能有些配置未提及或内容术语表述的不规范，请见谅。&lt;/li>
&lt;li>配置存阿里云盘了，这是链接：[&lt;a class="link" href="https://www.aliyundrive.com/s/ekTf1JRqVFa" target="_blank" rel="noopener"
>分享的文件
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>]&lt;/li>
&lt;li>欢迎“&lt;del>来电&lt;/del>”来函探讨。&lt;/li>
&lt;/ul></description></item><item><title>几种重分发方式可能带来的问题和处理</title><link>https://kiraster.github.io/posts/1b6d0fec.html/</link><pubDate>Sun, 28 Nov 2021 15:10:27 +0000</pubDate><guid>https://kiraster.github.io/posts/1b6d0fec.html/</guid><description>&lt;p>最近翻看 《CCNP ROUTE(642-902)学习指南 》，没错就是 2015 年之前 CCNP 改版前的那本，现在最新的认证考试已不是这个编号和课程了。诶，不聊这些，这不重要。&lt;/p>
&lt;p>现在把时间线拉回当年那个技术发展的时候，你要是说技术过时了，不好意思今年我还在某现网中看到设备运行 RIPv2 和 OSPF 两种协议的重分发。这也不重要。&lt;/p>
&lt;p>本文权当自己学习和回忆。&lt;/p>
&lt;h2 id="part-1">Part 1
&lt;/h2>&lt;p>&lt;strong>单点单向重分发&lt;/strong>&lt;/p>
&lt;p>下图所示 ，在 R1 上进行单向重分发（RIP 重分发进入 OSPF），R2 不进行重分发操作。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/HwmqiykMruAxldG.jpg">
&lt;img src="https://i.loli.net/2021/11/28/HwmqiykMruAxldG.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>观察 R2 上的路由表发现去往 RIP 外部网络 10.0.0.0 的路由下一跳地址是 R1 的 12.1.1.1 ，产生了次优路由。正确路径的下一跳应是 R3 的 23.1.1.3 。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/4zPy9MbFkonw28D.jpg">
&lt;img src="https://i.loli.net/2021/11/28/4zPy9MbFkonw28D.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>产生这条次优路由的原因是 R1 进行的重分发，产生 5 类 LSA 传递到 R2 上，最终 Cisco 路由器根据对比管理距离大小选择加载了 OSPF (110) 的路由。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/7lk5v3xDAZFgBUC.jpg">
&lt;img src="https://i.loli.net/2021/11/28/7lk5v3xDAZFgBUC.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>既然知道了加载这条路由的原因，解决方法有：1、阻断重分发而来的 LSA ，使 R2 自始至终只有 RIP 的路由，这么做虽然能临时使 R2 选择最优路径，但是当 R2 和 R3 之间的链路出现问题，通过 R2 去往 10.0.0.0 外部网络将不可达，不是一个好方法；2、修改 OSPF 外部路由的管理距离，使之大于 RIP （120），这样处理就可以使 R2 选择加载 RIP 学习到的路由，这是可行的。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- 方式 1 ，定义 ACL 匹配外部网络，在 OSPF 进程下针对该 ACL 修改管理距离
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 10 permit 10.0.0.0 0.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> distance 121 0.0.0.0 255.255.255.255 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- 方式 2 ，直接在 OSPF 进程下针对外部网络修改管理距离
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> distance ospf external 121
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>无论使用哪种方式，都会得到下图所示路由表。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/OoFESgzdmCWBpiG.jpg">
&lt;img src="https://i.loli.net/2021/11/28/OoFESgzdmCWBpiG.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="part-2">Part 2
&lt;/h2>&lt;p>&lt;strong>多点单向重分发&lt;/strong>&lt;/p>
&lt;p>下图所示 ，在 R1 和 R2 上进行单向重分发（RIP 重分发进入 OSPF）。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/aJ6fuZ2vhNwQ7yc.jpg">
&lt;img src="https://i.loli.net/2021/11/28/aJ6fuZ2vhNwQ7yc.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>观察 R2 上的路由表发现去往 RIP 外部网络 10.0.0.0 的路由下一跳地址是 R1 的 12.1.1.1 ，产生了次优路由。正确路径的下一跳应是 R3 的 23.1.1.3 。R1 上执行 &lt;em>&lt;strong>clear ip ospf redistribution&lt;/strong>&lt;/em> 命令，再观察 R1 路由表发现去往 RIP 外部网络 10.0.0.0 的路由下一跳地址是 R1 的 12.1.1.2 ，产生了次优路由。正确路径的下一跳应是 R3 的 13.1.1.3 。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/hdbmjRwiTvepCa4.gif">
&lt;img src="https://i.loli.net/2021/11/28/hdbmjRwiTvepCa4.gif"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>产生次优路由的原因和 &lt;em>&lt;strong>Part 1&lt;/strong>&lt;/em> 中是类似的，解决方法类似。&lt;/p>
&lt;h2 id="part-3">Part 3
&lt;/h2>&lt;p>&lt;strong>多点多向重分发&lt;/strong>&lt;/p>
&lt;p>下图所示 ，在 R1 和 R2 上进行双向重分发。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/HsXxUZ3JLcBWpja.jpg">
&lt;img src="https://i.loli.net/2021/11/28/HsXxUZ3JLcBWpja.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>观察 R1 和 R2 去往 EIGRP 外部网络 192.168.1.0 和 192.168.2.0 的路由表项，发现 R1 上去往外部网络路径下一跳是 R2 ，R2 上去往外部网络路径下一跳是 R1 ，出现了&lt;strong>次优路由&lt;/strong>和&lt;strong>路由环路&lt;/strong>。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/AwWzrbkBn8mQtIl.jpg">
&lt;img src="https://i.loli.net/2021/11/28/AwWzrbkBn8mQtIl.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/JiAYCQ571LOSoFg.jpg">
&lt;img src="https://i.loli.net/2021/11/28/JiAYCQ571LOSoFg.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/eBifcXS3QyoEFY8.gif">
&lt;img src="https://i.loli.net/2021/11/28/eBifcXS3QyoEFY8.gif"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>产生上述问题的原因是，在 R1 上把 EIGRP 重分发进 OSPF ，R2 上又把重分发进 OSPF 的路由重分发回 EIGRP ，R1 上收到 R2 和 R3 发过来关于 192.168.1.0/192.168.2.0 的外部路由更新，对比度量值后，选取度量值小的加载到路由表。R1 上查看输出：&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/28/pe1M8UgSCrvo3n7.jpg">
&lt;img src="https://i.loli.net/2021/11/28/pe1M8UgSCrvo3n7.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>**解决方法：**阻断重分发进对方路由域的路由更新再次重分发回原路由域 。定义名称为 &lt;strong>in2ospf&lt;/strong> 的 route-map ，序号 10 的语句对匹配 TAG 为 &lt;strong>100&lt;/strong> 的路由条目拒绝重分发；序号 20 的语句对 TAG 不是 &lt;strong>100&lt;/strong> 的路由条目设置 TAG 为 200 。定义名称为 &lt;strong>in2eigrp&lt;/strong> 的 route-map ，序号 10 的语句对匹配 TAG 为 &lt;strong>200&lt;/strong> 的路由条目拒绝重分发；序号 20 的语句对 TAG 不是 &lt;strong>200&lt;/strong> 的路由条目设置 TAG 为 100 。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R2 上定义 route-map ，R1 上也做这样的操作
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map in2ospf deny 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match tag 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map in2ospf permit 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set tag 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map in2eigrp deny 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match tag 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map in2eigrp permit 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set tag 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- 重分发时调用 route-map ，R1 上也做这样的操作
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router eigrp 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute ospf 100 metric 10000 100 255 1 1500 route-map in2eigrp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute eigrp 100 metric 100 subnets route-map in2ospf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>还可以使用更精简的方式&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R2 上定义 route-map ，R1 上也做这样
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map R-TAGS deny 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match tag 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map R-TAGS permit 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set tag 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- 重分发时调用 route-map ，R1 上也做这样的操作
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router eigrp 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute ospf 100 metric 10000 100 255 1 1500 route-map R-TAGS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redistribute eigrp 100 metric 100 subnets route-map R-TAGS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>做完以上步骤后，查看 R1 和 R2 的路由表，发现环路路由问题解决了，但是还存在次优路由。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/29/9FjXYtfGx5sinKD.jpg">
&lt;img src="https://i.loli.net/2021/11/29/9FjXYtfGx5sinKD.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/29/nSZVpNFzc1Ti78M.jpg">
&lt;img src="https://i.loli.net/2021/11/29/nSZVpNFzc1Ti78M.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>修改 OSPF 外部路由的管理距离，使之大于 EIGRP 外部路由 （170），这样处理就可以使路由器选择加载 EIGRP 学习到的外部路由。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- 方式 1 ，定义 ACL 匹配外部网络，在 OSPF 进程下针对该 ACL 修改管理距离
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 10 permit 192.168.1.0 0.0.0.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 10 permit 192.168.2.0 0.0.0.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> distance 171 0.0.0.0 255.255.255.255 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- 方式 2 ，直接在 OSPF 进程下针对外部网络修改管理距离
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> distance ospf external 171
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>最终解决问题&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/29/noHTCkGxhsVfl9A.jpg">
&lt;img src="https://i.loli.net/2021/11/29/noHTCkGxhsVfl9A.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/29/okR8upbOfKC3Tz6.jpg">
&lt;img src="https://i.loli.net/2021/11/29/okR8upbOfKC3Tz6.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="ending">Ending
&lt;/h2>&lt;ul>
&lt;li>做路由重分发的时候要考虑到操作后是否产生环路路由、次优路由和网络不可达的情况。&lt;/li>
&lt;li>对于产生环路路由、次优路由和网络不可达的情况，要是合理使用 route-map、修改管理距离等手段修正。&lt;/li>
&lt;li>当然合理的规划网络也很重要。必要的进行路由汇总，设置 passive-interface ……，使设备路由表尽可能的精简而又能高效的完成转发工作，这是很好的思路。&lt;/li>
&lt;li>文中可能有些配置未提及或内容术语表述的不规范，请见谅。&lt;/li>
&lt;li>欢迎“&lt;del>来电&lt;/del>”来函探讨。&lt;/li>
&lt;/ul></description></item><item><title>No.004 Simple Case</title><link>https://kiraster.github.io/posts/1fa3e02b.html/</link><pubDate>Thu, 18 Nov 2021 13:10:41 +0000</pubDate><guid>https://kiraster.github.io/posts/1fa3e02b.html/</guid><description>&lt;p>红茶三杯的原文 ：&lt;a class="link" href="http://blog.sina.com.cn/s/blog_5ec353710102vmgc.html" target="_blank" rel="noopener"
>【有点儿意思系列 02】哎哟喂停不下来了
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a> ，看完原文描述，我想到的是用 NAT 转换目的地址的方式解决，经过实验验证后，也说明了这个方法是可行的。做完实验后又想还有没有其他方法实现呢，想到用霸道的 PBR ，也能实现，不过这个方法我个人觉得比较傻。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/18/s2KaDPXMNwSLiWT.jpg">
&lt;img src="https://i.loli.net/2021/11/18/s2KaDPXMNwSLiWT.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>&lt;strong>背景描述：&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>R1、R2为两台出口路由器，分别连接电信及网通的广域网出口线路；&lt;/li>
&lt;li>R1、R2、SW1、SW2运行OSPF，R1配置指向网通的静态路由并部署静态路由到OSPF的路由重发布，R2则向OSPF域发布缺省路由。换而言之，内网访问网通的流量缺省走R1，而访问其他Internet资源的流量走R2出去；&lt;/li>
&lt;li>内网有两种服务器：一是向网通公网用户提供服务的服务器，以及向电信公网用户提供服务的服务器。为了使得这两台服务器能够被外网访问，在R1上将网通服务器映射到网通公网地址220.12.15.x/27，而在R2上把电信服务器映射到电信公网地址202.112.12.x/24。&lt;/li>
&lt;li>完成上述部署后，网通的公网用户使用目的地址220.12.15.x可以访问网通服务器，电信外网用户通过202.112.12.x可以访问电信服务器。但是电信外网用户使用220.12.15.x地址却无法正常访问网通服务器。请分析原因，并提出解决方案。&lt;/li>
&lt;/ol>
&lt;h2 id="solution">Solution
&lt;/h2>&lt;h3 id="part-1">Part 1
&lt;/h3>&lt;p>详细的配置我就不贴文中了，可到文章末尾链接自取。&lt;/p>
&lt;p>先说明一下拓扑在中的设备：CNC_User 和 Telecom_User 是用 PNETLab 的 &lt;em>Docker Chrome Node&lt;/em> 设备（打开界面是是一个 Chrome 浏览器，用命令行登陆发现是个 Linux 系统），内网服务器用的是 &lt;em>Docker Apache&lt;/em> （命令行登后发现是 Linux 系统，开启了 Apache 服务）。本次实验模拟外网客户端访问内网映射到公网的 HTTP 服务。&lt;/p>
&lt;p>首先，日常配置 VLAN、VRRP、OSPF、NAT……&lt;/p>
&lt;p>一顿操作后，实现上面提到的 &lt;em>&lt;strong>1 - 3&lt;/strong>&lt;/em> 的需求及 &lt;em>&lt;strong>4&lt;/strong>&lt;/em> 中的前半部分需求。*电信外网用户使用220.12.15.x地址却无法正常访问网通服务器。*原因在于电信用户访问220.12.15.x地址来回路径不一致导致 TCP 会话超时（拓扑中模拟访问 HTTP）,解决方案就是使来回路径一致（皮）。&lt;/p>
&lt;h3 id="part-2">Part 2
&lt;/h3>&lt;p>没有添加配置前，查看 Telecom_User 访问网通服务器 的情况。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/18/YGjhp9nl4iNoyMv.jpg">
&lt;img src="https://i.loli.net/2021/11/18/YGjhp9nl4iNoyMv.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>从图中可以看出 Telecom_User （202.112.13.2）电信用户向网通服务器映射地址（220.12.15.1）发出目的端口为 80 的 TCP 的数据包，而 R2 上电信的公网 IP （202.112.12.1）回应了 TCP ，证实了前面提到的 来回路径不一致（其实从内网路由表也可看出），后面数据包逐渐黑化了。&lt;/p>
&lt;p>在 R1 上添加公网访问网通服务器的目的地址 NAT 转换配置&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- 配置公网访问网通服务器转换的 NAT 地址池
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip nat pool to_cnc_server 172.16.1.100 172.16.1.110 netmask 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- 配置（outside list）任一公网地址访问 R1 上公网 IP 的 80 端口
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 101 permit tcp any host 220.12.15.1 eq www
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- 配置目的地址 NAT 转换
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip nat outside source list 101 pool to_cnc_server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- 配置 NAT 地址池网段静态路由，用于回程触发 NAT 转换
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route 172.16.1.0 255.255.255.0 220.12.15.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置完成测试结果如下：&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/18/2XpYlNcgE3ISKmC.jpg">
&lt;img src="https://i.loli.net/2021/11/18/2XpYlNcgE3ISKmC.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/18/iLsfHeNT4pO3mkx.jpg">
&lt;img src="https://i.loli.net/2021/11/18/iLsfHeNT4pO3mkx.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>电信外网用户使用220.12.15.x地址正常访问网通服务器。&lt;/p>
&lt;p>查看 R1 NAT 映射表，有目的地址 NAT 转换，注意观察 Outside local 和 Outside global&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/18/Bondgqwj7SvMT41.jpg">
&lt;img src="https://i.loli.net/2021/11/18/Bondgqwj7SvMT41.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>原理就是让 网通服务器 回程的数据包从 R1 出去。在 R1 上配置目的地址 NAT 转换。这时从网通服务上看就是源地址为 172.16.1.100 - 172.16.1.110 的地址访问的自身，回包也就回这个地址段。待回包至 R1 ，查找路由表发现 172.16.1.0 网段下一跳地址是 220.12.15.2 （手动配置的静态路由），触发 NAT 转换（此处查找 NAT 映射表项），源地址转成 R1 网通公网 IP地址回包最终至电信用户。此处配置的 172.16.1.0 网段静态路由是触发 NAT 转换，如果不配置，R1 就把网通服务器发过来的数据包丢弃了。&lt;/p>
&lt;p>普及一下 NAT 执行的顺序，查看思科官网(&lt;a class="link" href="https://www.cisco.com/c/en/us/support/docs/ip/network-address-translation-nat/6209-5.html?referring_site=bodynav" target="_blank" rel="noopener"
>NAT Order of Operation
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>)&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/18/3VtGKEm9P8WZjTU.jpg">
&lt;img src="https://i.loli.net/2021/11/18/3VtGKEm9P8WZjTU.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h3 id="part-3">Part 3
&lt;/h3>&lt;p>&lt;em>&lt;strong>Part 2&lt;/strong>&lt;/em> 中使用 目的地址 NAT 转换的手段使得来回路径一致，那有什么办法能使网通服务器回包强制从 R1 的公网 IP 地址端口出去呢？— &lt;strong>PBR&lt;/strong>。从 SW1 上就开始把网通服务器回包路径扭到 R1 上，R1 再把数据强行从公网接口丢出去。&lt;/p>
&lt;p>清除 &lt;em>&lt;strong>Part 2&lt;/strong>&lt;/em> 增加的配置，SW1、R1 添加如下配置：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- SW1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 101 permit ip host 192.168.10.1 any
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map acc_telecom_remote permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address 101
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set ip next-hop 10.10.10.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip policy route-map acc_telecom_remote
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- R1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 102 permit ip host 192.168.10.1 any
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map acc_telecom_remote permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address 102
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set ip next-hop 220.12.15.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip policy route-map acc_telecom_remote
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置完成测试结果如下：&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/18/PU7eDJI1X9YLZCT.jpg">
&lt;img src="https://i.loli.net/2021/11/18/PU7eDJI1X9YLZCT.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>电信外网用户使用220.12.15.x地址正常访问网通服务器。&lt;/p>
&lt;p>查看 R1 NAT 映射表，没有目的地址 NAT 转换，但是触发了正常流量上网的 PAT，注意观察 Outside local 和 Outside global&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/18/U4wzxdgM56Wy2oE.jpg">
&lt;img src="https://i.loli.net/2021/11/18/U4wzxdgM56Wy2oE.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="ending">Ending
&lt;/h2>&lt;ul>
&lt;li>原文后边加两台防火墙的测试我就不做了（古董 AMD 台式机跑不起 ASAv），大概的考察点还是 数据包来回路径一致的问题&lt;/li>
&lt;li>文中可能有些配置未提及或内容术语表述的不规范，请见谅。&lt;/li>
&lt;li>配置存阿里云盘了，这是链接：[&lt;a class="link" href="https://www.aliyundrive.com/s/3sWzTdiL5TG" target="_blank" rel="noopener"
>分享的文件
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>]&lt;/li>
&lt;li>欢迎“&lt;del>来电&lt;/del>”来函探讨。&lt;/li>
&lt;/ul></description></item><item><title>No.003 Simple Case</title><link>https://kiraster.github.io/posts/62d0e673.html/</link><pubDate>Thu, 11 Nov 2021 13:44:43 +0000</pubDate><guid>https://kiraster.github.io/posts/62d0e673.html/</guid><description>&lt;p>红茶三杯的原文 ：&lt;a class="link" href="http://blog.sina.com.cn/s/blog_5ec353710102vmkk.html" target="_blank" rel="noopener"
>【有点儿意思系列 04】哎哟喂停不下来了
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a> ，根据问题延续中的表述， 实验拓扑增加了两台出口路由器，两台防火墙，一台服务器。本次拓扑实验依托上一个拓扑演变而来，大部分基础配置与上一个相同，如果您是初次看到本文，请参阅上文 &lt;strong>【&lt;a class="link" href="https://kiraster.github.io/posts/2da7a7a9.html" target="_blank" rel="noopener"
>No.002 Simple Case
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>】&lt;/strong>，本文不在赘述。&lt;/p>
&lt;p>可能你看到拓扑中防火墙名称就懵了，我解释一下，由于我这是台古董级 AMD CPU 的电脑，跑不起 Cisco ASAv 的镜像（报错：Unsupport CPU type，无限重启），再加上内存有限，就不折腾了，考虑到文中只提到 NAT 的需求，我就用两台路由器换个图标和名称代替了。最终实现了原文中源地址转换及静态映射的需求，虽然牺牲了安全策略配置和 HA 配置。&lt;/p>
&lt;p>极致极简，拓扑中的 Open_Server 同样是用路由器模拟的，实验中将实现 Open_Server 的 SSH 服务映射到公网地址提供访问。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/VWlKy1fZaJ2eBEM.jpg">
&lt;img src="https://i.loli.net/2021/11/11/VWlKy1fZaJ2eBEM.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="part-1">Part 1
&lt;/h2>&lt;h3 id="step-1修改-core-sw1-和-core-sw2-配置">Step 1：修改 Core-SW1 和 Core-SW2 配置
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core-SW1 配置，增加与 Faker_FW1 互联地址，OSPF 宣告互联地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no switchport
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.100.5 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200 vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.100.5 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core-SW2 配置，增加与 Faker_FW2 互联地址，OSPF 宣告互联地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no switchport
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.100.1 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200 vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.100.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="step-2修改-obr-sw1-和-obr-sw2-配置">Step 2：修改 OBR-SW1 和 OBR-SW2 配置
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- OBR-SW1 配置，配置与 R1 互联地址，OSPF 宣告互联地址,去除原先的 NAT 相关配置和去除 OSPF 注入默认路由
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no switchport
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 20.20.20.1 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200 vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 20.20.20.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- OBR-SW2 配置，配置与 R2 互联地址，OSPF 宣告互联地址,去除原先的 NAT 相关配置和去除 OSPF 注入默认路由
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> no switchport
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 20.20.20.10 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200 vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 20.20.20.10 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="step-3配置-r1-和-r2">Step 3：配置 R1 和 R2
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">R1&lt;/span> &lt;span class="err">配置，配置互联地址，&lt;/span>&lt;span class="n">OSPF&lt;/span> &lt;span class="err">宣告互联地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置中包含了&lt;/span> &lt;span class="n">NAT&lt;/span> &lt;span class="err">配置，当两台防火墙宕机后仍可保持内网与互联网通信&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.248&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.2&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.5&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">router&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">router&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">id&lt;/span> &lt;span class="mf">111.111&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">111.111&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">network&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.2&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="n">area&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">network&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.5&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="n">area&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">network&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="n">area&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">default&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">information&lt;/span> &lt;span class="n">originate&lt;/span> &lt;span class="n">metric&lt;/span> &lt;span class="mi">11&lt;/span> &lt;span class="n">metric&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">type&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span> &lt;span class="n">overload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">R2&lt;/span> &lt;span class="err">配置，配置互联地址，&lt;/span>&lt;span class="n">OSPF&lt;/span> &lt;span class="err">宣告互联地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置中包含了&lt;/span> &lt;span class="n">NAT&lt;/span> &lt;span class="err">配置，当两台防火墙宕机后仍可保持内网与互联网通信&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.9&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.248&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.6&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">duplex&lt;/span> &lt;span class="n">auto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">router&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">router&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">id&lt;/span> &lt;span class="mf">222.222&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">222.222&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">network&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.6&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="n">area&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">network&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.9&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="n">area&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">network&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="n">area&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">default&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">information&lt;/span> &lt;span class="n">originate&lt;/span> &lt;span class="n">metric&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">metric&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">type&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span> &lt;span class="n">overload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="step-4internet-配置faker_fw1faker_fw2-基础配置">Step 4：Internet 配置，Faker_FW1、Faker_FW2 基础配置
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Internet 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 1.2.3.4 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport access vlan 123
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan123
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.1.6 255.255.255.248
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Faker_FW1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 200.1.1.3 是 NAT 和 映射使用的公网地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.1.3 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.100.6 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Faker_FW2 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 200.1.1.4 是 NAT 和 映射使用的公网地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.1.4 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.100.2 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="part-2">Part 2
&lt;/h2>&lt;ol>
&lt;li>配置完第一部分， Biz_B_PC 可以 ping 通 Internet 的 1.2.3.4，路径是： &lt;strong>Core-SW2 -&amp;gt; OBR-SW2 -&amp;gt; R2&lt;/strong>，而从 Internet 开启 debug ip icmp 观察到：Internet 返回 reply 报文远端地址是 R2 的外网接口 IP 地址（200.1.1.2）。&lt;/li>
&lt;/ol>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/j46XPe2TpvLVhNk.gif">
&lt;img src="https://i.loli.net/2021/11/11/j46XPe2TpvLVhNk.gif"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ol start="2">
&lt;li>
&lt;p>根据原文中的描述，“ &lt;em>防火墙与核心交换机为仅有一条物理线路。另外，由于增加了防火墙，因此将原先部署在出口路由器（拓扑中没有画出来）上的NAT下沉到防火墙上，由防火墙来部署源地址转换及静态映射。防火墙出公网的下一跳是OBR-SW交换机，两者使用私有IP地址三层对接。&lt;/em>”&lt;/p>
&lt;p>也就是 NAT 和映射的功能交给了防火墙设备，然后防火墙出公网的下一跳是出口设备，联想到防火墙与出口路由器之间创建一条隧道，内网去往公网的 inside source IP 地址在防火墙上进行 NAT 后直接走隧道至出口路由器，再路由出去。我在两台防火墙上配置的环回接口地址就是转换用的。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="step-1配置-faker_fw-与出口路由器建立-gre-隧道">Step 1：配置 Faker_FW 与出口路由器建立 GRE 隧道
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">Faker_FW2&lt;/span> &lt;span class="err">配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">NAT&lt;/span> &lt;span class="err">和&lt;/span> &lt;span class="err">映射使用的公网地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Loopback0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.4&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">使用&lt;/span> &lt;span class="n">e0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="err">接口地址与&lt;/span> &lt;span class="n">R2&lt;/span> &lt;span class="err">的&lt;/span> &lt;span class="n">e0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="err">接口地址建立隧道，并配置&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Tunnel0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">1.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">100.2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">destination&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.9&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置&lt;/span> &lt;span class="n">NAT&lt;/span> &lt;span class="n">overload&lt;/span> &lt;span class="err">和&lt;/span> &lt;span class="err">静态映射（将内网&lt;/span> &lt;span class="n">Open_Server&lt;/span> &lt;span class="err">的&lt;/span> &lt;span class="n">SSH&lt;/span> &lt;span class="err">端口映射到公网的&lt;/span> &lt;span class="mi">2222&lt;/span> &lt;span class="err">端口）&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">pool&lt;/span> &lt;span class="n">nat&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">pat&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.4&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.4&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">length&lt;/span> &lt;span class="mi">29&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">pool&lt;/span> &lt;span class="n">nat&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">pat&lt;/span> &lt;span class="n">overload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="k">static&lt;/span> &lt;span class="n">tcp&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.200&lt;/span> &lt;span class="mi">22&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.4&lt;/span> &lt;span class="mi">2222&lt;/span> &lt;span class="n">extendable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置默认路由和必要的静态路由&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="n">Tunnel0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.8&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">100.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.0&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">100.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- R2 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 使用 e0/0 接口地址与 Faker_FW2 的 e0/0 接口地址建立隧道
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 1.1.1.1 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source 20.20.20.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel destination 192.168.100.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 配置需要走隧道的 VRF 静态路由，内网地址回程路由 track 跟踪
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route vrf vpn_internet 192.168.50.0 255.255.255.0 Tunnel0 track 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route vrf vpn_internet 200.1.1.4 255.255.255.255 Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 配置 SLA 监测隧道对端的连通性
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 192.168.100.2 source-interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla schedule 1 life forever start-time now
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 1 ip sla 1 reachability
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">Faker_FW1&lt;/span> &lt;span class="err">配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">NAT&lt;/span> &lt;span class="err">和&lt;/span> &lt;span class="err">映射使用的公网地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Loopback0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.3&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">使用&lt;/span> &lt;span class="n">e0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="err">接口地址与&lt;/span> &lt;span class="n">R1&lt;/span> &lt;span class="err">的&lt;/span> &lt;span class="n">e0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="err">接口地址建立隧道，并配置&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Tunnel0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">2.2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">2.1&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">virtual&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reassembly&lt;/span> &lt;span class="ow">in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">100.6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tunnel&lt;/span> &lt;span class="n">destination&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置&lt;/span> &lt;span class="n">NAT&lt;/span> &lt;span class="n">overload&lt;/span> &lt;span class="err">和&lt;/span> &lt;span class="err">静态映射&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">pool&lt;/span> &lt;span class="n">nat&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">pat&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.3&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.3&lt;/span> &lt;span class="n">prefix&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">length&lt;/span> &lt;span class="mi">29&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">pool&lt;/span> &lt;span class="n">nat&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">pat&lt;/span> &lt;span class="n">overload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="k">static&lt;/span> &lt;span class="n">tcp&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.200&lt;/span> &lt;span class="mi">22&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.3&lt;/span> &lt;span class="mi">2222&lt;/span> &lt;span class="n">extendable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置默认路由和必要的静态路由&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.0&lt;/span> &lt;span class="n">Tunnel0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mf">20.20&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">20.0&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">100.5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.0&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.0&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">100.5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">配置&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- R1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 使用 e0/1 接口地址与 Faker_FW2 的 e0/0 接口地址建立隧道
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 2.2.2.2 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel source 20.20.20.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel destination 192.168.100.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tunnel vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 配置需要走隧道的 VRF 静态路由，内网地址回程路由 track 跟踪
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route vrf vpn_internet 192.168.50.0 255.255.255.0 Tunnel0 track 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route vrf vpn_internet 200.1.1.3 255.255.255.255 Tunnel0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 配置 SLA 监测隧道对端的连通性
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 192.168.100.6 source-interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla schedule 1 life forever start-time now
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 1 ip sla 1 reachability
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="step-2配置-core-sw-静态路由使上网流量下一跳设备为防火墙">Step 2：配置 Core-SW 静态路由使上网流量下一跳设备为防火墙
&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core-SW1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route vrf vpn_internet 0.0.0.0 0.0.0.0 192.168.100.6 track 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 192.168.100.6 source-interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 1 ip sla 1 reachability
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core-SW2 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route vrf vpn_internet 0.0.0.0 0.0.0.0 192.168.100.2 track 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 192.168.100.2 source-interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 1 ip sla 1 reachability
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>完成配置到这个步骤，再观察内网到 Internet 的流量路径,： &lt;strong>Core-SW2 -&amp;gt; Faker_FW2 -&amp;gt; R2&lt;/strong>，而从 Internet 开启 debug ip icmp 观察到：Internet 返回的 reply 报文远端地址是 &lt;strong>Faker_FW2&lt;/strong> 配置的 NAT 转换地址（200.1.1.4）。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/TktXihfwbMCjx9d.gif">
&lt;img src="https://i.loli.net/2021/11/11/TktXihfwbMCjx9d.gif"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>配置 Open_Server 和测试公网 SSH 访问&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Open_Server 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.50.200 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route 0.0.0.0 0.0.0.0 192.168.50.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 配置 SSH SERVICES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip domain name test.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">crypto key generate rsa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1024
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip ssh version 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">line vty 0 4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> login local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> transport input ssh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">username cisco password 0 cisco
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">enable password cisco
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>NAT 静态映射已在 【&lt;em>&lt;strong>Part 2 &amp;ndash; Step 1&lt;/strong>&lt;/em>】 中配置，将 Open_Server 的 22 端口映射到被访问公网 IP 地址的 2222 端口。测试结果如图：&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/ciU36EwAlCWsIzG.gif">
&lt;img src="https://i.loli.net/2021/11/11/ciU36EwAlCWsIzG.gif"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="part-3">Part 3
&lt;/h2>&lt;p>&lt;strong>网络冗余的设计&lt;/strong>&lt;/p>
&lt;p>本实验中探讨的是在网络中某段线路通断的情况下 Biz_B_PC 访问 Internet 环回接口地址 1.2.3.4 的路径切换。网络正常情况下，访问路径如下图：&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/FR9PMsbqgIQNjzV.jpg">
&lt;img src="https://i.loli.net/2021/11/11/FR9PMsbqgIQNjzV.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>情况 1：&lt;/strong>（假设 Faker_FW1、Core-SW1、OBR-SW1、R1 设备都正常，线路也正常 ）&lt;/p>
&lt;p>当 Core-SW2 的 e0/3 状态为 DOWN；&lt;/p>
&lt;p>当 Core-SW2 的 e0/0 状态为 DOWN；&lt;/p>
&lt;p>当 OBR-SW2 的 e0/0 状态为 DOWN；&lt;/p>
&lt;p>当 Core-SW2 的 e1/3 链路协议 DOWN；&lt;/p>
&lt;p>以上四个条件有一个为真，即其中出现一个接口为 DOWN 状态， Core-SW2 降低 内网 VRRP 组的优先级， 同时将内网 VRRP 组切换至 Backup 状态，内网上网流量路径切换至 Core-SW1 进行转发。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>情况 2：&lt;/strong>（假设 Faker_FW2、 Core-SW2、OBR-SW2、R2 设备都正常，线路也正常 ）&lt;/p>
&lt;p>当 Core-SW1 的 e0/3 状态为 DOWN；&lt;/p>
&lt;p>当 Core-SW1 的 e0/0 状态为 DOWN；&lt;/p>
&lt;p>当 OBR-SW1 的 e0/1 状态为 DOWN；&lt;/p>
&lt;p>当 Core-SW1 的 e1/3 链路协议 DOWN；&lt;/p>
&lt;p>以上四个条件有一个为真，即其中出现一个接口为 DOWN 状态， Core-SW1 降低 内网 VRRP 组的优先级，不进行 VRRP 状态切换。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>情况 3：&lt;/strong>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/SidCgVkOe76LKAo.jpg">
&lt;img src="https://i.loli.net/2021/11/11/SidCgVkOe76LKAo.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>当 A 组条件任一条件为真和 B 组任一条件为真时，此时 Core-SW1 和 Core-SW2 都降低 VRRP 组优先级，由于设置了 Core-SW2 的 VRRP 优先级为 120 （ Core-SW1 默认优先级 100），两台设备同时降低相同的优先级 21 。此时的 VRRP Master 设备是 Core-SW2 ，上网流量路径：&lt;strong>Core-SW2&lt;/strong> -&amp;gt; &lt;strong>OBR-SW2&lt;/strong> -&amp;gt; &lt;strong>R2&lt;/strong> ，在 &lt;strong>R2&lt;/strong> 上进行 &lt;strong>NAT&lt;/strong> 最终出公网；当 B 组中的条件是：&lt;strong>OBR-SW2 的 e0/0 状态为 DOWN&lt;/strong>，上网流量路径：&lt;strong>Core-SW2&lt;/strong> -&amp;gt; &lt;strong>OBR-SW2&lt;/strong> -&amp;gt; &lt;strong>OBR-SW1&lt;/strong>-&amp;gt; &lt;strong>R1&lt;/strong>，在 &lt;strong>R1&lt;/strong> 上进行 &lt;strong>NAT&lt;/strong> 最终出公网。&lt;/p>
&lt;p>分别手动 &lt;strong>shutdown&lt;/strong> 以上任一条件中的接口（以 Core-SW2 的 e0/3 和 e1/3 为例），观察 Track 和 VRRP 状态的变化如下图：&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/tjePOHGadCIg1mN.jpg">
&lt;img src="https://i.loli.net/2021/11/11/tjePOHGadCIg1mN.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core-SW2 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 192.168.100.2 source-interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 10.10.10.9 source-interface Ethernet0/0.200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 20.20.20.10 source-interface Ethernet0/0.200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla group schedule 11 1-3 schedule-together start-time now life forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 1 ip sla 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 2 ip sla 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 3 ip sla 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 4 interface Ethernet1/3 line-protocol
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 11 list boolean and
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> object 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> object 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> object 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> object 4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan50
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 50 priority 120
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 50 track 11 decrement 21
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core-SW1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 192.168.100.6 source-interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 10.10.10.1 source-interface Ethernet0/0.200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 20.20.20.1 source-interface Ethernet0/0.200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla group schedule 11 1-3 schedule-together start-time now life forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 1 ip sla 1 reachability
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 2 ip sla 2 reachability
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 3 ip sla 3 reachability
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 4 interface Ethernet1/3 line-protocol
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 11 list boolean and
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> object 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> object 2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> object 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> object 4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan50
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 50 ip 192.168.50.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 50 track 11 decrement 21
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ending">Ending
&lt;/h2>&lt;ul>
&lt;li>码完字了，还是那句话（挺耗时间的）。尽管还有不满意的地方，比如还可以再完善配置，添加更多的配置参数，考虑更多扩展需求想解决思路，但是这是个“无底洞”。&lt;/li>
&lt;li>文中可能有些配置未提及或内容术语表述的不规范，请见谅。&lt;/li>
&lt;li>配置存阿里云盘了，这是链接：[&lt;a class="link" href="https://www.aliyundrive.com/s/HaEJNPJZEjq" target="_blank" rel="noopener"
>分享的文件
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>]&lt;/li>
&lt;li>欢迎“&lt;del>来电&lt;/del>”来函探讨。&lt;/li>
&lt;/ul></description></item><item><title>No.002 Simple Case</title><link>https://kiraster.github.io/posts/2da7a7a9.html/</link><pubDate>Wed, 10 Nov 2021 11:37:50 +0000</pubDate><guid>https://kiraster.github.io/posts/2da7a7a9.html/</guid><description>&lt;p>来自红茶三杯的原文:&lt;a class="link" href="http://blog.sina.com.cn/s/blog_5ec353710102vmkk.html" target="_blank" rel="noopener"
>【有点儿意思系列 04】哎哟喂停不下来了
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;p>当时看完 Case 的需求我是不想理会的，不就是 VRF 隔离么，我压根没往配置 ACL 这个方向去，其实看需求已经暗示的非常明显了，“始终”，“完全隔离” 等等字眼。再加上 VRRP（远离思科设备多年，不玩 HSRP 了，模拟器做不了堆叠啊） 的冗余方案。但是 “问题后续” 这段话引起了我的兴趣，还是从这个拓扑开始吧（其实我已经做完两个拓扑在码这篇文章的时候），话不多说，开干。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/PMKamjJfoEgb8G4.jpg">
&lt;img src="https://i.loli.net/2021/11/11/PMKamjJfoEgb8G4.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="step-1配置接入层交换机sw5sw6sw7">Step 1：配置接入层交换机（SW5、SW6、SW7）
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>创建 VLAN ，上联 Core-SW 的端口配置 Trunk 放行 VLAN，把连接 PC 的端口划入对应 VLAN&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! -- SW5 配置， 根据需求业务 A 有多个 VLAN ，就敷衍一下配置VLAN10,VLAN20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vlan 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vlan 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport access vlan 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>SW6、SW7 如法炮制即可。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="step-2配置-core_sw1-和-core_sw2">Step 2：配置 Core_SW1 和 Core_SW2
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>创建 VLAN10、VLAN20、VLAN50，创建 VRF 定义为 vpn_biz 和 vpn_internet&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">Core_SW1&lt;/span> &lt;span class="err">和&lt;/span> &lt;span class="n">Core_SW2&lt;/span> &lt;span class="err">配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">vlan&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">vlan&lt;/span> &lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">vlan&lt;/span> &lt;span class="mi">50&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="err">其实用不到&lt;/span> &lt;span class="n">RD&lt;/span> &lt;span class="err">和&lt;/span> &lt;span class="n">RT&lt;/span> &lt;span class="err">，在&lt;/span> &lt;span class="n">MPLS&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">VPN&lt;/span> &lt;span class="err">引入的时候才用，为了看起来好看点&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>配置 Core-SW1 与 Core-SW2 之间的 Port-channel，配置 Core-SW 和下联 SW5、SW6、SW7 的 Trunk&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core_SW1 和 Core_SW2 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Port-channel1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20,50
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20,50
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> channel-group 1 mode active
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20,50
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> channel-group 1 mode active
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet1/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet1/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 50
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>创建 VLAN 接口并绑定 VRF，配置 IP 地址，配置 VRRP&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core_SW1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.10.252 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 10 ip 192.168.10.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 10 priority 120
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.20.252 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 20 ip 192.168.20.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 20 priority 120
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan50
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.50.252 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 50 ip 192.168.50.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core_SW2 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.10.253 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 10 ip 192.168.10.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.20.253 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 20 ip 192.168.20.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan50
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 192.168.50.253 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 50 ip 192.168.50.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 50 priority 120
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>配置 Core-SW1 与 OBR-SW1 ，Core-SW2 与 OBR-SW2 互联的接口 IP 地址，并配置 OSPF 网络类型为点对点&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core_SW1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0.100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation dot1Q 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.10.10.2 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0.200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation dot1Q 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.10.10.2 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core_SW2 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0.100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation dot1Q 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.10.10.10 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0.200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation dot1Q 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip vrf forwarding vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.10.10.10 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf network point-to-point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="step-3配置-obr-sw1-和-obr-sw2">Step 3：配置 OBR-SW1 和 OBR-SW2
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>配置创建 VRF 定义为 vpn_biz 和 vpn_internet，配置互联接口 IP 地址&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">OBR&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">SW1&lt;/span> &lt;span class="err">配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">switchport&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">100.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">switchport&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">2.100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encapsulation&lt;/span> &lt;span class="n">dot1Q&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">10.10&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.5&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">2.200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encapsulation&lt;/span> &lt;span class="n">dot1Q&lt;/span> &lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">10.10&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.5&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">3.100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encapsulation&lt;/span> &lt;span class="n">dot1Q&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">10.10&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.1&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">3.200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encapsulation&lt;/span> &lt;span class="n">dot1Q&lt;/span> &lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">10.10&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.1&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">OBR&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">SW2&lt;/span> &lt;span class="err">配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">switchport&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">200.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">switchport&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">100.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.5&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">2.100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encapsulation&lt;/span> &lt;span class="n">dot1Q&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">10.10&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.6&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">2.200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encapsulation&lt;/span> &lt;span class="n">dot1Q&lt;/span> &lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">10.10&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.6&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">3.100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encapsulation&lt;/span> &lt;span class="n">dot1Q&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">10.10&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.9&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">3.200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encapsulation&lt;/span> &lt;span class="n">dot1Q&lt;/span> &lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_internet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">10.10&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">10.9&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="step-4配置-biz_a_remote">Step 4：配置 Biz_A_Remote
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>配置创建 VRF 定义为 vpn_biz，配置互联接口 IP 地址，配置环回接口作为测试地址&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">Biz_A_Remote&lt;/span> &lt;span class="err">配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rd&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="k">export&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">target&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Loopback0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">30.111&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">switchport&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">100.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.2&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">switchport&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">vrf&lt;/span> &lt;span class="n">forwarding&lt;/span> &lt;span class="n">vpn_biz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="mf">100.1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">1.6&lt;/span> &lt;span class="mf">255.255&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">255.252&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">ospf&lt;/span> &lt;span class="n">network&lt;/span> &lt;span class="n">point&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">point&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="step-5配置-internet">Step 5：配置 Internet
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>配置接口 IP 地址和环回接口即可，现实环境中，运营商的设备控制不了&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Internet 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Loopback0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 1.2.3.4 255.255.255.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.1.2 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 200.1.1.6 255.255.255.252
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> duplex auto
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="step-6配置-ospf">Step 6：配置 OSPF
&lt;/h2>&lt;ul>
&lt;li>
&lt;p>为了简化配置过程，我全网使用 Area 0 ，生产环境中该划分区域的不要偷懒。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core_SW1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100 vrf vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 1.1.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.2 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.10.252 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.20.252 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200 vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 1.1.1.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.2 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.50.252 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Core_SW2 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100 vrf vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 2.2.2.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.10 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.10.253 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.20.253 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200 vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 2.2.2.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.10 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.50.253 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- OBR-SW1 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100 vrf vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 11.11.11.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.5 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 100.1.1.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200 vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 11.11.11.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.1 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.5 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default-information originate always
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route vrf vpn_internet 0.0.0.0 0.0.0.0 200.1.1.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- OBR-SW2 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100 vrf vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 22.22.22.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.6 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.9 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 100.1.1.5 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200 vrf vpn_internet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 22.22.22.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.6 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.10.10.9 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default-information originate always
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route vrf vpn_internet 0.0.0.0 0.0.0.0 200.1.1.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- Biz_A_Remote 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 100 vrf vpn_biz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> router-id 3.3.3.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 100.1.1.2 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 100.1.1.6 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 192.168.30.111 0.0.0.0 area 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="step-7配置-nat">Step 7：配置 NAT
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>其实在生产环境中用核心交换机作为互联网出口的情况不常见（我没见过），核心交换机的上行可能会有行为管理器、安全设备、路由器等设备，具体情况就要看客户单位对网络有什么样的需求和预算了。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>到这还有个问题，思科 CEF 和 NAT 貌似有冲突，去思科论坛看巴拉巴拉一大通大概是软件版本和硬件和处理器的类型等等问题，我这个是虚拟环境，不好判断是什么原因，放出看过的链接。各位如果知道是什么原因的请知会我，万分感谢。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a class="link" href="https://learningnetwork.cisco.com/s/question/0D53i00000Kt7C1/nat-not-working-with-cef" target="_blank" rel="noopener"
>NAT not working with CEF
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://www.cisco.com/c/en/us/support/docs/ip/network-address-translation-nat/26704-nat-faq-00.html" target="_blank" rel="noopener"
>Network Address Translation (NAT) FAQ
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a class="link" href="https://learningnetwork.cisco.com/s/question/0D53i00000Kt6em/nat-cef-punted-packets" target="_blank" rel="noopener"
>NAT: CEF Punted packets
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>对于上述问题，经过试验可行的方法是在需要配置 NAT 参数的接口关闭路由高速缓存&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">OBR&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">SW1&lt;/span> &lt;span class="err">配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">2.200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">3.200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="n">overload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span> &lt;span class="o">---&lt;/span> &lt;span class="n">OBR&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">SW2&lt;/span> &lt;span class="err">配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">outside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">2.200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">3.200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">no&lt;/span> &lt;span class="n">ip&lt;/span> &lt;span class="n">route&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">permit&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.0&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">0.255&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">nat&lt;/span> &lt;span class="n">inside&lt;/span> &lt;span class="n">source&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">Ethernet0&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="n">overload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="step-8test">Step 8：Test
&lt;/h2>&lt;ol>
&lt;li>Biz_A_PC 和 Biz_B_PC 测试，发现两个网络之间不能互通。Biz_A_PC 能 ping 通 Biz_A_Remote 的环回地址 192.168.30.111；Biz_B_PC 能 ping 通 Internet 的环回地址 1.2.3.4&lt;/li>
&lt;/ol>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/wfSlNJc7AarQi8v.gif">
&lt;img src="https://i.loli.net/2021/11/11/wfSlNJc7AarQi8v.gif"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/57yVOWh2RKnEwrG.gif">
&lt;img src="https://i.loli.net/2021/11/11/57yVOWh2RKnEwrG.gif"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ol start="2">
&lt;li>
&lt;p>冗余测试&lt;/p>
&lt;ul>
&lt;li>
&lt;p>由于这个拓扑实验和我写的下一篇文章有大量重叠部分，故放在下一篇文章中表述，本文中也没有添加配置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>大概思路思路是通过 Track 关联降低 VRRP 的优先级使其成为 VRRP 的 Backup 组，流量路径自动切换至另一台设备。举个例子：当 Core-SW1 以出接口 e0/0 监测到与 OBR-SW1 直连线路不通或监测到 Biz_A_Remote 的 e0/0 不通(这是个 and 的关系，用编程语言的描述就是：条件 A 和条件 B 同时为 True，结果才为 True)，此时 SLA 监测状态为 Time-out ，在 VRRP 与 Track 联动下降低 VRRP 优先级使其成为 Backup 状态，Biz_A_PC 去往 Biz_A_Remote 的流量路径切换至 Core-SW2 ，途径：Core-SW2 &amp;ndash;&amp;gt; OBR-SW2 最终到达 Biz_A_Remote ，如图所示：&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/11/YJWEOwKAsa9Xq4v.jpg">
&lt;img src="https://i.loli.net/2021/11/11/YJWEOwKAsa9Xq4v.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="ending">Ending
&lt;/h2>&lt;ul>
&lt;li>总算码完了，其实还挺耗时间的写文章，但是对做拓扑实验做了梳理，其中还包含怎么清晰的表达我的思路和想表达的意思。&lt;/li>
&lt;li>配置存阿里云盘了，这是链接：[&lt;a class="link" href="https://www.aliyundrive.com/s/k8tnrEpqc46" target="_blank" rel="noopener"
>分享的文件
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>]&lt;/li>
&lt;li>欢迎“&lt;del>来电&lt;/del>”来函探讨。&lt;/li>
&lt;li>下一篇文更有意思^_^，To be continued.&lt;/li>
&lt;/ul></description></item><item><title>No.001 Simple Case</title><link>https://kiraster.github.io/posts/8ac5ac4a.html/</link><pubDate>Sun, 07 Nov 2021 00:31:11 +0000</pubDate><guid>https://kiraster.github.io/posts/8ac5ac4a.html/</guid><description>&lt;p>上文提到要 po 一篇文，现在发表一下自己的思路和配置。原文:&lt;a class="link" href="http://blog.sina.com.cn/s/blog_5ec353710102w64i.html" target="_blank" rel="noopener"
>【有点儿意思系列 06】一个看起来简单的案例
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>，再上图。&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/05/aV6ElzprdKjscFt.jpg">
&lt;img src="https://i.loli.net/2021/11/05/aV6ElzprdKjscFt.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;h2 id="request-and-solution">Request and Solution
&lt;/h2>&lt;ol>
&lt;li>
&lt;p>PC1、PC2 分属 VLAN10 和 VLAN20；DHCP 服务器属 VLAN30 ，PC1 和 PC2 从 DHCP 服务器自动获取地址。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：根据上下文需求，确定 R3 和 R4 是热备组网。R3 和 R4 上配置子接口，配置 VRRP ；业务地址段和 DHCPServer 不在同一网段，所以需要在业务网段的网关上配置 DHCP 中继。实验中使用一台路由器模拟 DHCPServer，上面配置分配给 VLAN10,VLAN20 的地址池。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- DHCPServer 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip dhcp excluded-address 10.1.10.252 10.1.10.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip dhcp excluded-address 10.1.20.252 10.1.20.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip dhcp pool vlan10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.1.10.0 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default-router 10.1.10.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip dhcp pool vlan20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> network 10.1.20.0 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default-router 10.1.20.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- R3 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation dot1Q 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.1.10.252 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip helper-address 10.1.30.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 10 ip 10.1.10.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 10 priority 120
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 10 track 1 decrement 21
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1.20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation dot1Q 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.1.20.252 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip helper-address 10.1.30.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 20 ip 10.1.20.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1.30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation dot1Q 30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 10.1.30.252 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 30 ip 10.1.30.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 30 priority 120
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 30 track 1 decrement 21
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 网管地址网关
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1.99
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> encapsulation dot1Q 99
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 20.1.1.252 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 99 ip 20.1.1.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 99 priority 120
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 99 track 1 decrement 21
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>SW4 是内网用户接入交换机（仅具二层功能），要求内网两个网段的用户均能 telnet 到该设备。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：配置 VLAN ，划分接口，配置 Trunk，配置默认网关和远程网管&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- SW4 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20,30,99
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk allowed vlan 10,20,30,99
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport trunk encapsulation dot1q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport mode trunk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport access vlan 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet1/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport access vlan 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet1/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> switchport access vlan 30
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 网管IP地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Vlan99
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip address 20.1.1.10 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! -- 本想使用 ip default-gateway，但是不起作用，下面这条效果是一样
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route 0.0.0.0 0.0.0.0 20.1.1.254
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! --- 网管配置 略
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">……
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>由于 VPCS 不支持 Telnet ，此处使用 DHCPServer 做测试。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/07/cuPSatd6w2E18Hq.jpg">
&lt;img src="https://i.loli.net/2021/11/07/cuPSatd6w2E18Hq.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ol start="3">
&lt;li>
&lt;p>R3 和 R4 作为内网用户的网关设备，互为热备份。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：这一条前面提过了，整个拓扑完整配置后边发，我打个包。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>R3、R4、SW2 及 SW3 上不允许出现任何手工配置的静态路由条目。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：好的，满足你。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SW1 采用重发布的方式，将直连的服务器网段路由（如10.1.100.0/24）注入 EIGRP。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：好的，满足你。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>内网用户（PC1、PC2）访问核心服务器 Server（10.1.100.1）的数据流走向如下：&lt;/p>
&lt;p>PC1 访问 Server：R3 &amp;gt; R1 &amp;gt; SW2 &amp;gt; SW1 &amp;gt; Server；&lt;/p>
&lt;p>PC2 访问 Server：R4 &amp;gt; R2 &amp;gt; SW3 &amp;gt; SW1 &amp;gt; Server；&lt;/p>
&lt;p>沿途任何设备上到达 Server 的路由不允许出现负载均衡，且 PC 访问 Server 的流量往返路径一致。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：在配置完路由协议后，查看沿途设备路由表发现到达 Server 的路由出现负载均衡是正常现象，旁观大局，逐个处理就行。&lt;/p>
&lt;p>但是有一个现象我不知是模拟器的 Bug 还是镜像的问题，查看 SW3 和 SW4 ，总有一台设备到达 Server 的路由是这样的：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">D EX 10.1.100.0/24 [170/307200]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>另一台学习到去往 Server 网段的路由是从上面这台学习到的外部路由，重启两台交换机的 OSPF 进程，这条路由又可能显示在第二台了。我又用 GNS3 做了测试，也是这种情况，按理说加载到路由表的不应该是管理距离为 110 的 OSPF 外部路由么？&lt;/p>
&lt;p>我思考了一番，可能是 OSPF 进程启动先后顺序的问题，先启动的交换机 OSPF 进程加载了 EIGRP 外部路由，而后启动的交换机 OSPF 进程学习到 EIGRP 外部路由和 OSPF 外部路由，按照规则选择了管理距离值较小的 OSPF 路由条目。&lt;/p>
&lt;p>&lt;strong>PC1 访问 Server：R3 &amp;gt; R1 &amp;gt; SW2 &amp;gt; SW1 &amp;gt; Server；&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- R1 配置，修改 OSPF 入向接口的 cost ，使从 e0/0 收到去往10.1.100.0网段的路由更优
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf cost 11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- SW2 配置, 在 OSPF 进程下过滤入方向收到的去往 10.1.100.0 网段的条目，为什么这么做呢，从后面需求看，断掉 SW2/SW3 与 SW1 的线路之一，去往 Server的流量就不需要经过断掉线路这台交换机，而且断掉线路还要流量经过这台设备，走了个直角线路，并不是最优路径
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router ospf 200
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> distribute-list 10 in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 10 deny 10.1.100.0 0.0.0.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 10 permit any
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>PC2 访问 Server ：R4 &amp;gt; R2 &amp;gt; SW3 &amp;gt; SW1 &amp;gt; Server；&lt;/strong>&lt;/p>
&lt;p>思路和 PC1 访问 Server 一样，逆推一下即可，不占用篇幅了（懒得码字）&lt;/p>
&lt;p>&lt;strong>PC1 访问 Server 回程路径： Server&amp;gt; SW1 &amp;gt; SW2 &amp;gt; R1 &amp;gt;R3 ；&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- SW1 配置，观察到去往内网网段的路由条目是负载均衡，配置偏移列表和指定入向接口，增加希望不要出现在路由表里的条目 metric 偏移，影响路由表加载
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">router eigrp 100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> offset-list 20 in 1024 Ethernet0/2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> offset-list 10 in 1024 Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 10 permit 10.1.20.0 0.0.0.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 20 permit 10.1.10.0 0.0.0.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> !
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- SW2 配置，修改 e0/3 接口 cost，使得从该接口学习到去往 10.1.10.0 和 10.1.20.0 网段的路由不是最优路由
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip ospf cost 11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>PC2 访问 Server 回程路径： Server&amp;gt; SW1 &amp;gt; SW3 &amp;gt; R2 &amp;gt;R3 ；&lt;/strong>&lt;/p>
&lt;p>思路和 PC1 访问 Server 回程路径一样，逆推一下即可，不占用篇幅了（懒得码字）&lt;/p>
&lt;/li>
&lt;li>
&lt;p>要求 SW2 和 SW3 访问 Server 都走最优路径，即 SW2 前往 Server 的数据流走 SW1，SW3 前往 Server 的数据流也直接到 SW1。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：这一条也佐证了我在上面说到的流量走直角路径不是最优的想法。说的通俗一点就是：SW1 上的有流量要去往 Server 只能从 e0/1 出去，不走直角。即使 SW1 上的出口线路故障了也不走，走的路径是：拓扑上的对角线。退一步来说当 SW2/SW3 的出口线路故障了，下联的 R1/R2 不会从 SW2/SW3 学习到去往 Server 的路由条目。SW2 也是这个道理。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/07/VG6mjtd1Ww49iSv.jpg">
&lt;img src="https://i.loli.net/2021/11/07/VG6mjtd1Ww49iSv.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p>
&lt;ol start="8">
&lt;li>
&lt;p>SW1 上关于 10.1.10.0/24 和 10.1.20.0/24 的路由不应该出现等价负载均衡，正常情况下访问 10.0/24 网段的数据流走 SW2，访问2 0.0/24 网段的数据流走 SW3。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：在 PC1/PC2 访问 Server 的回程路径时候已经解决这一条，不占用篇幅了（懒得码字）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>当 SW1-SW2 之间的链路 DOWN 掉时，PC1 访问 Server 的数据流切换至路径： R3&amp;gt;R1&amp;gt;SW3&amp;gt;SW1&amp;gt;Server，且往返路径一致。而当 SW1-SW3 之间的链路 DOWN 掉时，PC2 应该仍然能够访问 Server，情况类似。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：正如我前面所说的：当 SW2/SW3 的出口线路故障了，下联的 R1/R2 也不会从 SW2/SW3 学习到去往 Server 的路由条目。此时去往 Server 的流量已经在 R1/R2 通过走对角线的路径来到 SW3/SW2 上。&lt;/p>
&lt;p>重点解决回程的路径。因为前面已经修改了 SW2 和 SW3 上的 e0/3 的 cost ，这就使得当 SW1-SW2 之间的链路 DOWN 掉或者 SW1-SW3 之间的链路 DOWN 掉时，SW3/SW2 去往 10.1.10.0 和 10.1.20.0 网段都是直线往下经过 R2 或者 R1 回程到业务网段，并不符合需求。需要添加策略路由 PBR 实现往返路径一致。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- SW2 配置，配置匹配去往 10.1.20.0 网段的 ACL，配置 route-map 匹配 ACL ，设置去往10.1.20.0 网段的下一跳地址，配置 SLA 监测，最后在 e0/1 调用
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">access-list 101 permit ip any 10.1.20.0 0.0.0.255
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route-map pbr_20.0 permit 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> match ip address 101
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> set ip next-hop verify-availability 10.1.254.105 1 track 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 10.1.254.105 source-interface Ethernet0/3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! 设置 delay 是为了及时观察现象，实际生产环境不需这么做
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> track 1 ip sla 1 reachability
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> delay down 5 up 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla schedule 1 life forever start-time now
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip policy route-map pbr_20.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>当SW1-SW3之间的链路DOWN掉时，PC2应该仍然能够访问Server，情况类似。解决思路和上面一样，懒-码-字。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>当 SW2-R1 之间的链路 DOWN 掉时，PC1 访问 Server 的数据流切换至路径：R3&amp;gt;R1&amp;gt;SW3&amp;gt;SW1&amp;gt;Server，此时不要求流量往返路径完全一致。当 SW3-R2 之间的链路 DOWN 掉时，PC2 应该仍能够访问到 Server。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：当 SW2-R1 之间的链路 DOWN 掉时，R1 是能够从 SW3 学习到去往 Server 的路由的，只是回程的时候路径是： Server&amp;gt; SW1 &amp;gt; SW2 &amp;gt; R2 &amp;gt;R4 ，不要求流量往返路径完全一致，本条需求已经自动实现了。当SW3-R2之间的链路DOWN掉时同理。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>R3、R4 任意一台路由器与内网交换机直连链路 DOWN 掉，不影响内网 PC 访问外网。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：配置的 VRRP 可以实现。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>【可选】若 R3 的出口 DOWN 或 R1 的两条上联链路都 DOWN，以上两种情况，R3 都能检测到，要求此两种情况发生时内网用户访问 SERVER 都不受影响，R4 同理。&lt;/p>
&lt;p>&lt;strong>S&lt;/strong>：R3 的出口 DOWN 或 R1 的两条上联链路都 DOWN，明显要求配置 SLA 特性，我的做法是在 SW3 和 SW2 上配置一个环回地址，R3/R4 检测这个地址的可达性。举例：当 R3 配置了监测 SW3 的环回地址可达性，无论是 R3 的出口 DOWN 或 R1 的两条上联链路都 DOWN 其中一个条件达成，都会导致监测失败不可达，再在相应的内网子接口下配置 Track 联动降低 VRRP 组的优先级，使其成为 Backup 状态，另一台路由器成为 Master ，此时内网用户访问 Server 路径自动切换不受影响（其实还是会掉包的，取决于你配置的监测周期，抢占延时，生成树协议）。R4 同理。&lt;/p>
&lt;p>（11月10日发现，可以使用 &lt;strong>Track list&lt;/strong> 的方式实现）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">! --- R3 配置
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">interface Ethernet0/1.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vrrp 10 track 1 decrement 21
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> icmp-echo 33.33.33.33 source-interface Ethernet0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> frequency 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip sla schedule 1 life forever start-time now
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">track 1 ip sla 1 reachability
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> delay down 5 up 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="ending">Ending
&lt;/h2>&lt;ul>
&lt;li>配置存阿里云盘了，这是链接：[&lt;a class="link" href="https://www.aliyundrive.com/s/VsEkNTBjuxy" target="_blank" rel="noopener"
>分享的文件
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>]&lt;/li>
&lt;li>欢迎“&lt;del>来电&lt;/del>”来函探讨。&lt;/li>
&lt;/ul></description></item><item><title>PNETLab试用</title><link>https://kiraster.github.io/posts/13f1a9a7.html/</link><pubDate>Fri, 05 Nov 2021 18:43:23 +0000</pubDate><guid>https://kiraster.github.io/posts/13f1a9a7.html/</guid><description>&lt;p>&lt;strong>PNETLab&lt;/strong> &lt;strong>(&lt;em>Packet Network Emulator Tool Lab&lt;/em>&lt;/strong>)is a platform that allows you to download and share labs with the community. 这句话摘抄自&lt;a class="link" href="https://pnetlab.com/pages/documentation" target="_blank" rel="noopener"
>官网
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>介绍，这是链接：&lt;a class="link" href="https://pnetlab.com/pages/documentation" target="_blank" rel="noopener"
>What is PNETLab?
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;p>上网冲浪发现这个大宝贝，看完介绍心理痒痒就搞一搞，有个帖子介绍挺好，原文：&lt;a class="link" href="https://community.cisco.com/t5/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2/%E5%8E%9F%E5%88%9B-%E8%B6%85%E7%BA%A7%E6%8E%A8%E8%8D%90-%E7%BD%91%E5%B7%A5%E5%BF%85%E5%A4%87%E6%A8%A1%E6%8B%9F%E5%99%A8pnetlab-%E9%99%84%E4%B8%8B%E8%BD%BD%E9%93%BE%E6%8E%A5-%E5%85%A8%E7%90%83%E7%AC%AC%E4%B8%80%E7%AF%87%E6%9C%80%E4%BC%98%E8%B4%A8%E7%9A%84%E5%B8%96%E5%AD%90/ba-p/4383377" target="_blank" rel="noopener"
>【原创】超级推荐：网工必备模拟器PNETLab，附下载链接，全球第一篇最优质的帖子
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>。&lt;/p>
&lt;h2 id="experience">Experience
&lt;/h2>&lt;p>不能说和 EVE-NG “一模一样”，我对比过（可能是使用方法不规范，也可能是其他原因），之前用EVE-NG可以跑起整张 CCIE V5 H1 的拓扑（电脑的 CPU 和 RAM 未变动，系统换 WIN10 ，加了固态硬盘做系统盘），现在装了 PNETLab 只能跑 31台 还是 32 台设备（原谅老年人健忘）。&lt;/p>
&lt;h3 id="hardware-requirements">Hardware requirements
&lt;/h3>&lt;p>看了官网文档，我这古董 AMD CPU 不在硬件支持范围内（是不是这个原因跑不了那么多设备呢？），当看到这些说明的时候，我差点就把正在下载中的文件给取消了。最后安上了，我若安不好，当天便可以多睡几小时。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">PC/Laptop HW requirements
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CPU：Intel i5/i7 (4 Logical processors), Enabled Intel virtualization in BIOS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RAM：8Gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HDD Space：40Gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Network：LAN/WLAN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------------------------------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PNETLab Virtual machine requirements
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CPU：4/1 (Number of processors/Number of cores per processor) Enabled Intel VT-x/EPT virtualization engine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RAM：6Gb or more
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HDD：40Gb or more
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Network：VMware NAT or Bridged network adapter
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Unsupported hardware and systems
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The following are currently not supported:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">• AMD CPU based PC or Server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">• VirtualBox virtualization
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">• Citrix XenServer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">• Microsoft HyperV
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">• Ubuntu 17.X or 18.x as platform
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="pnetlab-supported-images">PNETLab Supported Images
&lt;/h3>&lt;p>查看支持的镜像，还是挺多的，不知为何 H3C 不在列表里，看B站 UP 主视频把 H3C 的防火墙设备弄进去了，不过我挺少用 QEMU 的镜像（太吃内存了），Huawei/H3C 的实验还是用官方的模拟器。&lt;/p>
&lt;p>还有个事，就是现在 &lt;a class="link" href="https://user.pnetlab.com/store/labs/view" target="_blank" rel="noopener"
>&lt;em>PNETLab Store&lt;/em>
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a> 商店下载Lab不附带一起下载镜像了，要自己找镜像上传到目录，还好可以找之前 EVE-NG 的资源上传。&lt;/p>
&lt;h3 id="language--汉化">Language &amp;amp; 汉化
&lt;/h3>&lt;p>看到 B 站视频有 UP 主用了汉化，我就还好，看这些英文不头疼。其实也简单，就是把里边的英文包复制一份到电脑，再打开里面的 &lt;strong>JSON 文件&lt;/strong>，里面有两列，左边属性，右边 Web 界面显示的字符，把右边填上中文保存上传到 Chinese 的文件夹，再切换一下即可。&lt;/p>
&lt;h3 id="how-to-console-to-devices">How to console to devices
&lt;/h3>&lt;p>有两种方式，跟 EVE-NG 不知道是哪个版本的方式一样。&lt;/p>
&lt;ul>
&lt;li>使用 &lt;strong>HTML Console&lt;/strong>，在拓扑界面弹出一个小窗的方式，我个人就不太喜欢这么搞，不舒畅。&lt;/li>
&lt;li>使用 &lt;strong>Default Console&lt;/strong>，调用系统自带的默认程序打开，例如把 CRT 软件设置成系统默认，跟 EVE-NG 的 &lt;strong>EVE-NG-Win-Client-Pack&lt;/strong> 这玩意儿“一模一样”。&lt;/li>
&lt;/ul>
&lt;h2 id="ending">Ending
&lt;/h2>&lt;p>欢乐的时光特别短，又到时候说88，还有很多需要探索的地方，不谈了，开饭。&lt;/p>
&lt;p>接下来我将用 PNETLab 搞一个实验，来自大佬&lt;a class="link" href="http://blog.sina.com.cn/vinsoney" target="_blank" rel="noopener"
>红茶三杯
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>博客的原文:&lt;a class="link" href="http://blog.sina.com.cn/s/blog_5ec353710102w64i.html" target="_blank" rel="noopener"
>【有点儿意思系列 06】一个看起来简单的案例
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>，弄完了写一篇文 po 出来，先看图。&lt;/p>
&lt;p>下一篇文链接： &lt;a class="link" href="https://kiraster.github.io/posts/8ac5ac4a.html" target="_blank" rel="noopener"
>No.001 Simple Case - Kir&amp;rsquo;s Blog
&lt;span style="white-space: nowrap;">&lt;svg width=".7em"
height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
&lt;path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
&lt;path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
fill="currentColor">
&lt;/svg>&lt;/span>
&lt;/a>&lt;/p>
&lt;p>
&lt;div class="post-img-view">
&lt;a data-fancybox="gallery" href="https://i.loli.net/2021/11/05/aV6ElzprdKjscFt.jpg">
&lt;img src="https://i.loli.net/2021/11/05/aV6ElzprdKjscFt.jpg"
loading="lazy"
>
&lt;/a>
&lt;/div>
&lt;/p></description></item></channel></rss>